<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.48">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <link rel="icon" type="image/png" sizes="32x32" href="/img/logo/favicon-32_32.png"><link rel="manifest" href="/manifest.webmanifest"><meta name="application-name" content="AruNi"><meta name="apple-mobile-web-app-title" content="AruNi"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="apple-touch-icon" href="/img/logo/apple-touch-icon.png"><meta name="theme-color" content="#1e2124"><meta name="msapplication-TileColor" content="#1e2124"><title>volatile 详解 | AruNi</title><meta name="description" content="AruNi">
    <link rel="modulepreload" href="/assets/app.b6a0c7cc.js"><link rel="modulepreload" href="/assets/2022-12-27-volatile 详解.html.a005b096.js"><link rel="modulepreload" href="/assets/2022-12-27-volatile 详解.html.763bea6d.js"><link rel="prefetch" href="/assets/index.html.5d70a31e.js"><link rel="prefetch" href="/assets/2022-08-16-Hello_VuePress.html.58bc7bfa.js"><link rel="prefetch" href="/assets/2022-08-21-LeetCode 第 307 场周赛.html.6baebe90.js"><link rel="prefetch" href="/assets/2022-10-31-仿牛客项目总结.html.81b01d58.js"><link rel="prefetch" href="/assets/2022-12-1-ThreadLocal 详解.html.8fef6b6a.js"><link rel="prefetch" href="/assets/2022-12-12-什么是 HTTP.html.ed3e4aca.js"><link rel="prefetch" href="/assets/2022-12-16-Java 内存模型.html.a58acf00.js"><link rel="prefetch" href="/assets/2022-12-17-Object 类.html.d5303a2c.js"><link rel="prefetch" href="/assets/2022-12-18-String 类.html.e7e3b4ae.js"><link rel="prefetch" href="/assets/404.html.7d858b3d.js"><link rel="prefetch" href="/assets/index.html.de26035a.js"><link rel="prefetch" href="/assets/index.html.4a704eac.js"><link rel="prefetch" href="/assets/index.html.c92bc6f3.js"><link rel="prefetch" href="/assets/index.html.5abce942.js"><link rel="prefetch" href="/assets/index.html.cdfaefff.js"><link rel="prefetch" href="/assets/index.html.bb24b47e.js"><link rel="prefetch" href="/assets/index.html.122e117f.js"><link rel="prefetch" href="/assets/index.html.316d8e9c.js"><link rel="prefetch" href="/assets/index.html.b5449332.js"><link rel="prefetch" href="/assets/index.html.b0cee4e0.js"><link rel="prefetch" href="/assets/index.html.61779abc.js"><link rel="prefetch" href="/assets/index.html.deae5fb3.js"><link rel="prefetch" href="/assets/index.html.ce366625.js"><link rel="prefetch" href="/assets/2022-08-16-Hello_VuePress.html.52fadcec.js"><link rel="prefetch" href="/assets/2022-08-21-LeetCode 第 307 场周赛.html.91bdbfb5.js"><link rel="prefetch" href="/assets/2022-10-31-仿牛客项目总结.html.d35e1c64.js"><link rel="prefetch" href="/assets/2022-12-1-ThreadLocal 详解.html.2fd966a5.js"><link rel="prefetch" href="/assets/2022-12-12-什么是 HTTP.html.8e3b5226.js"><link rel="prefetch" href="/assets/2022-12-16-Java 内存模型.html.b3134907.js"><link rel="prefetch" href="/assets/2022-12-17-Object 类.html.8e641886.js"><link rel="prefetch" href="/assets/2022-12-18-String 类.html.7382a3e6.js"><link rel="prefetch" href="/assets/404.html.b1e26b29.js"><link rel="prefetch" href="/assets/index.html.307f8a67.js"><link rel="prefetch" href="/assets/index.html.605b8ec3.js"><link rel="prefetch" href="/assets/index.html.7da74174.js"><link rel="prefetch" href="/assets/index.html.399e1ca1.js"><link rel="prefetch" href="/assets/index.html.a6e56f51.js"><link rel="prefetch" href="/assets/index.html.15a8f5e1.js"><link rel="prefetch" href="/assets/index.html.d330514a.js"><link rel="prefetch" href="/assets/index.html.7fb87a55.js"><link rel="prefetch" href="/assets/index.html.b6b499d4.js"><link rel="prefetch" href="/assets/index.html.334e4a26.js"><link rel="prefetch" href="/assets/index.html.a9374416.js"><link rel="prefetch" href="/assets/index.html.79a21f93.js"><link rel="prefetch" href="/assets/404.86839219.js"><link rel="prefetch" href="/assets/HomePage.d4f4594d.js"><link rel="prefetch" href="/assets/Layout.2dbfa937.js"><link rel="prefetch" href="/assets/Links.3eadfccf.js"><link rel="prefetch" href="/assets/Post.a80c3669.js"><link rel="prefetch" href="/assets/Tags.26ceee83.js"><link rel="prefetch" href="/assets/index.4f5d4e06.js">
    <link rel="stylesheet" href="/assets/style.f603b422.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container no-sidebar"><!--[--><header class="navbar invert"><span><a href="/" class=""><span class="site-name">$ cd /home/</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg></span><span>Home</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/tags/" class="" aria-label="Tags"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg></span><span>Tags</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/links/" class="" aria-label="Links"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></span><span>Links</span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://aruni.me/docs/" rel="noopener noreferrer" target="_blank" aria-label="Docs"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/></svg></span><span>Docs</span><!--[--><!--]--></a></div><!--]--><div class="navbar-item"><a style="cursor:pointer;"><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9-9-4.032-9-9 4.032-9 9-9zm0 16c3.867 0 7-3.133 7-7 0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7zm8.485.071l2.829 2.828-1.415 1.415-2.828-2.829 1.414-1.414z"/></svg></span><span>Search</span></a></div></nav><!--[--><!--]--><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/" class="" aria-label="Home"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/></svg></span><span>Home</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/tags/" class="" aria-label="Tags"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M0 252.118V48C0 21.49 21.49 0 48 0h204.118a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882L293.823 497.941c-18.745 18.745-49.137 18.745-67.882 0L14.059 286.059A48 48 0 010 252.118zM112 64c-26.51 0-48 21.49-48 48s21.49 48 48 48 48-21.49 48-48-21.49-48-48-48z"/></svg></span><span>Tags</span><!--[--><!--]--></a></div><div class="navbar-item"><a href="/links/" class="" aria-label="Links"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96 0-59.27-59.26-59.27-155.7 0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757 0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037 0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482 0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96 0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454 0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037 0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639 0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></span><span>Links</span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://aruni.me/docs/" rel="noopener noreferrer" target="_blank" aria-label="Docs"><!--[--><!--]--><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd"/></svg></span><span>Docs</span><!--[--><!--]--></a></div><!--]--><div class="navbar-item"><a style="cursor:pointer;"><span class="nav-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 2c4.968 0 9 4.032 9 9s-4.032 9-9 9-9-4.032-9-9 4.032-9 9-9zm0 16c3.867 0 7-3.133 7-7 0-3.868-3.133-7-7-7-3.868 0-7 3.132-7 7 0 3.867 3.132 7 7 7zm8.485.071l2.829 2.828-1.415 1.415-2.828-2.829 1.414-1.414z"/></svg></span><span>Search</span></a></div></nav><!--[--><!--]--><!----><!--[--><!--]--></aside><!--]--><div class="page-content"><!--[--><div class="show-catalog post-wrapper"><div class="article-header use-image post-header" style="background-image:url(https://aruni-01-github-io.oss-cn-beijing.aliyuncs.com/posts/volatile.png);"><div class="article-header-mask" style="background:rgba(40, 57, 101, .4);"></div><div class="article-header-content"><div class="article-tags"><!--[--><span class="article-tag">Java 并发</span><span class="article-tag">Java</span><!--]--></div><h1 class="article-title">volatile 详解</h1><p class="article-subtitle">volatile 底层实现「Tag - Java 并发」</p><div class="article-icons"><div class="article-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M313.6 304c-28.7 0-42.5 16-89.6 16-47.1 0-60.8-16-89.6-16C60.2 304 0 364.2 0 438.4V464c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48v-25.6c0-74.2-60.2-134.4-134.4-134.4zM400 464H48v-25.6c0-47.6 38.8-86.4 86.4-86.4 14.6 0 38.3 16 89.6 16 51.7 0 74.9-16 89.6-16 47.6 0 86.4 38.8 86.4 86.4V464zM224 288c79.5 0 144-64.5 144-144S303.5 0 224 0 80 64.5 80 144s64.5 144 144 144zm0-240c52.9 0 96 43.1 96 96s-43.1 96-96 96-96-43.1-96-96 43.1-96 96-96z"/></svg><span>AruNi_Lu</span></div><div class="article-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M400 64h-48V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H160V12c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v52H48C21.5 64 0 85.5 0 112v352c0 26.5 21.5 48 48 48h352c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48zm-6 400H54c-3.3 0-6-2.7-6-6V160h352v298c0 3.3-2.7 6-6 6z"/></svg><span>2022-12-27</span></div><div class="article-icon"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="0 0 24 24" fill="currentColor"><path fill="none" d="M0 0h24v24H0z"/><path d="M17.618 5.968l1.453-1.453 1.414 1.414-1.453 1.453a9 9 0 11-1.414-1.414zM12 20a7 7 0 100-14 7 7 0 000 14zM11 8h2v6h-2V8zM8 1h8v2H8V1z"/></svg><span>21 min</span></div></div></div><!----></div><main class="page post-content"><!--[--><!--]--><div class="theme-gungnir-content"><!--[--><!--]--><div><p>Java 并发系列 —— volatile 详解</p><div class="custom-container tip"><svg viewBox="0 0 25 25" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><path d="M297.6 258.73H296c-59.47.87-110.69 51.45-111.83 110.43-.626 36.485 16.525 71.085 45.94 92.68 17.86 13.18 29.88 33.56 33.77 56.42h67.62c4-22.82 16.13-43.3 34.16-56.74 28.589-21.097 45.496-54.587 45.496-90.118 0-30.03-12.078-58.833-33.496-79.882a113.133 113.133 0 0 0-80.06-32.79ZM265.19 550.7v26.6c0 4.84 1.17 6.43 1.17 6.43l63.72-.59V550.7h-64.89Z" style="fill:#48b884;fill-rule:nonzero;" transform="matrix(.042 0 0 .042 0 -5.178)"></path><path d="M297.64 123.3C133.26 123.3 0 256.56 0 420.94s133.26 297.63 297.64 297.63 297.63-133.25 297.63-297.63S462 123.3 297.64 123.3ZM385 487.57c-14.11 10.48-22.51 28.09-22.51 47.14v48.43c-.016 17.792-14.648 32.428-32.44 32.45h-64.86c-15.6 0-32.44-12-32.44-38.29v-42.82c0-19-8.21-36.4-21.93-46.52-37.882-27.85-59.959-72.44-59.14-119.45 1.46-77.24 66-141.09 143.81-142.22 38.87.19 76.89 14.37 105 42.11a143.764 143.764 0 0 1 43.14 103c-.159 45.761-21.911 88.86-58.63 116.17Z" style="fill:#48b884;fill-rule:nonzero;" transform="matrix(.042 0 0 .042 0 -5.178)"></path></svg><p class="custom-container-title">本文内容：</p><nav class="table-of-contents"><ul><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_1-认识-volatile" class="router-link-active router-link-exact-active">1. 认识 volatile</a></li><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_2-jmm-介绍" class="router-link-active router-link-exact-active">2. JMM 介绍</a></li><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_3-volatile-底层原理" class="router-link-active router-link-exact-active">3. volatile 底层原理</a><ul><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_3-1-如何保证可见性" class="router-link-active router-link-exact-active">3.1 如何保证可见性？</a></li><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_3-2-如何禁止指令重排" class="router-link-active router-link-exact-active">3.2 如何禁止指令重排？</a></li><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_3-3-为何不保证原子性" class="router-link-active router-link-exact-active">3.3 为何不保证原子性？</a></li></ul></li><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_4-volatile-和-synchronized-的区别" class="router-link-active router-link-exact-active">4. volatile 和 synchronized 的区别</a></li><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_5-volatile-应用场景" class="router-link-active router-link-exact-active">5. volatile 应用场景</a><ul><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_5-1-状态标志" class="router-link-active router-link-exact-active">5.1 状态标志</a></li><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_5-2-单例模式" class="router-link-active router-link-exact-active">5.2 单例模式</a></li><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_5-3-volatile-bean-模式" class="router-link-active router-link-exact-active">5.3 volatile bean 模式</a></li><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_5-4-开销较低的读-写锁策略" class="router-link-active router-link-exact-active">5.4 开销较低的读－写锁策略</a></li></ul></li><li><a aria-current="page" href="/posts/2022-12-27-volatile%20%E8%AF%A6%E8%A7%A3.html#_6-参考文章" class="router-link-active router-link-exact-active">6. 参考文章</a></li></ul></nav></div><h2 id="_1-认识-volatile" tabindex="-1"><a class="header-anchor" href="#_1-认识-volatile" aria-hidden="true">#</a> 1. 认识 volatile</h2><p>volatile 关键字是一个轻量级的同步机制，一般作用于 <strong>变量</strong>，在并发场景下保证了内存的 <strong>可见性</strong>，以及 <strong>避免了指令的重排序</strong>。</p><p>volatile 三大特性：</p><ul><li><strong>保证可见性</strong>；</li><li><strong>不保证原子性</strong>；</li><li><strong>禁止指令重排</strong>；</li></ul><div class="custom-container info"><svg viewBox="0 0 25 25" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><path d="M13 1.188C6.477 1.188 1.188 6.477 1.188 13S6.477 24.813 13 24.813 24.813 19.523 24.813 13c0-6.523-5.29-11.812-11.813-11.812Zm2.459 18.307c-.608.24-1.092.422-1.455.548a3.838 3.838 0 0 1-1.262.189c-.736 0-1.309-.18-1.717-.539a1.74 1.74 0 0 1-.611-1.367c0-.215.015-.435.045-.659a8.23 8.23 0 0 1 .147-.759l.761-2.688c.067-.258.125-.503.171-.731.046-.23.068-.441.068-.633 0-.342-.071-.582-.212-.717-.143-.135-.412-.201-.813-.201-.196 0-.398.029-.605.09-.205.063-.383.12-.529.176l.201-.828c.498-.203.975-.377 1.43-.521a4.225 4.225 0 0 1 1.29-.218c.731 0 1.295.178 1.692.53.395.353.594.812.594 1.376 0 .117-.014.323-.041.617a4.129 4.129 0 0 1-.152.811l-.757 2.68a7.582 7.582 0 0 0-.167.736 3.892 3.892 0 0 0-.073.626c0 .356.079.599.239.728.158.129.435.194.827.194.185 0 .392-.033.626-.097.232-.064.4-.121.506-.17l-.203.827Zm-.134-10.878a1.807 1.807 0 0 1-1.275.492c-.496 0-.924-.164-1.28-.492a1.57 1.57 0 0 1-.533-1.193c0-.465.18-.865.533-1.196a1.812 1.812 0 0 1 1.28-.497c.497 0 .923.165 1.275.497.353.331.53.731.53 1.196 0 .467-.177.865-.53 1.193Z" style="fill:#157ffb;fill-rule:nonzero;" transform="translate(-1.257 -1.257) scale(1.0582)"></path></svg><p class="custom-container-title">并发编程的三个重要特性：</p><ul><li><strong>可见性</strong>：一个线程对共享变量进行了修改，其他线程可以立刻看到修改后的最新值；</li><li><strong>原子性</strong>：一次或多次操作，要么全都执行，要么全都不执行（volatile 不保证、可以使用锁机制）；</li><li><strong>有序性</strong>：代码在执行过程中的先后顺序，编译器及处理器会对指令进行重排优化后在执行；</li></ul></div><h2 id="_2-jmm-介绍" tabindex="-1"><a class="header-anchor" href="#_2-jmm-介绍" aria-hidden="true">#</a> 2. JMM 介绍</h2><blockquote><p>详细的 JMM 讲解在 <a href="https://aruni.me/posts/2022-12-16-Java%20%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.html" target="_blank" rel="noopener noreferrer">Java 内存模型</a></p></blockquote><p>Java 内存模型抽象了线程和主存之间的关系，主要由三部分构成：<strong>1 个主内存、n 个线程、n 个本地（工作）内存</strong>，共享数据就在它们三者之间来回倒腾。</p><p>线程之间的共享变量存储在主内存（Main Memory）中，每个线程都有一个私有的本地内存（Local Memory），本地内存中存储了该线程以读/写共享变量的副本。</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202212142203111.png" alt=""></p><p>在当前的 Java 内存模型下，<strong>线程可以把变量保存在本地内存</strong>（比如机器的寄存器）中，而 <strong>不是直接在主存中进行读写</strong>。这就可能造成 <strong>一个线程在主存中修改了一个变量的值，而另外一个线程还继续使用它在寄存器中的变量值的拷贝，造成数据的不一致</strong>。</p><p>要解决这个问题，就需要把变量声明为 <strong>volatile</strong> ，这就指示 JVM，这个变量是共享且不稳定的，<strong>每次使用它都要到主存中 read 最新值，然后 load 回本地内存，再供线程 use</strong>。即保证了共享变量的 <strong>可见性</strong>。</p><h2 id="_3-volatile-底层原理" tabindex="-1"><a class="header-anchor" href="#_3-volatile-底层原理" aria-hidden="true">#</a> 3. volatile 底层原理</h2><h3 id="_3-1-如何保证可见性" tabindex="-1"><a class="header-anchor" href="#_3-1-如何保证可见性" aria-hidden="true">#</a> 3.1 如何保证可见性？</h3><p>上面也说到，在 JMM 中每个线程都有自己的本地内存，线程对于变量的读写都要在本地内存中进行，而不能直接读写主存中的变量。同时，线程之间的本地内存不共享，不能直接互相访问，需要通过主存来完成。</p><p>这里很容易产生一个 <strong>误解</strong>：如果一个变量被标记成了 volatile 变量，那么这个变量的值就 <strong>不会被加载进线程的工作内存中，而是直接在主内存上进行读写</strong>。</p><p>实际上并不是这样的，因为这需要为 volatile 变量的读写设置一套特殊的规则，显然不合适。</p><p>即使是 volatile 变量，也是从工作内存中读取的，只是它 <strong>有特殊的操作顺序规定</strong>，使得看起来像是直接在主内存中读写一样。</p><p>首先，<strong>在对 volatile 变量进行读/写操作时，必须去主内存拉取新值/将新值更新进主内存</strong>。即：</p><ul><li>在线程 <strong>读</strong> 变量时，必须先从主内存中 read，再 load 进本地内存后，才供线程 use；</li><li>在线程 <strong>写</strong> 变量时，把变量 assign 到本地内存后，必须进行 store，然后 write 进主内存；</li></ul><p>现在已经保证了对变量的写操作可以时刻同步进主内存，接下来还需要一个规则，要保证每次读操作都在写操作后面执行，这样能保证 <strong>读操作读取到的是最新值</strong>。这个规则就是 Happens-Before 规则。</p><p><strong>Happens-Before 规则</strong> 中要求：<strong>对 volatile 变量的写操作必须在对该变量的读操作之前执行</strong>。</p><p>如下图所示：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202212271554517.png" alt="image-20221227151320803"></p><p>有了 Happens-Before 规则后：</p><ul><li>绿色箭头：程序次序规则保证；</li><li>紫色箭头：volatile 规则保证；</li><li>蓝色箭头：传递性规则保证；</li></ul><p>即保证了线程 B 的读操作读取到的是最新值，保证了可见性。</p><p>不过还需要 <strong>注意</strong>：在进行读写操作时，要保证执行顺序，因为 <strong>读写 volatile 变量的操作并不是原子的</strong>。无论是读还是写，都分为了 <strong>3 个命令</strong>（read -&gt; load -&gt; use 或 assign -&gt; store -&gt; write），若出现线程 A 的 write 操作发生在线程 B 的 use 操作之后，此时线程 B 在主内存中读取到的数据就是旧数据。</p><p>所以，在进行读操作时，<strong>必须等写操作把 3 个命令都指向完后，才能进行读</strong>。</p><div class="custom-container info"><svg viewBox="0 0 25 25" xmlns="http://www.w3.org/2000/svg" xml:space="preserve" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;"><path d="M13 1.188C6.477 1.188 1.188 6.477 1.188 13S6.477 24.813 13 24.813 24.813 19.523 24.813 13c0-6.523-5.29-11.812-11.813-11.812Zm2.459 18.307c-.608.24-1.092.422-1.455.548a3.838 3.838 0 0 1-1.262.189c-.736 0-1.309-.18-1.717-.539a1.74 1.74 0 0 1-.611-1.367c0-.215.015-.435.045-.659a8.23 8.23 0 0 1 .147-.759l.761-2.688c.067-.258.125-.503.171-.731.046-.23.068-.441.068-.633 0-.342-.071-.582-.212-.717-.143-.135-.412-.201-.813-.201-.196 0-.398.029-.605.09-.205.063-.383.12-.529.176l.201-.828c.498-.203.975-.377 1.43-.521a4.225 4.225 0 0 1 1.29-.218c.731 0 1.295.178 1.692.53.395.353.594.812.594 1.376 0 .117-.014.323-.041.617a4.129 4.129 0 0 1-.152.811l-.757 2.68a7.582 7.582 0 0 0-.167.736 3.892 3.892 0 0 0-.073.626c0 .356.079.599.239.728.158.129.435.194.827.194.185 0 .392-.033.626-.097.232-.064.4-.121.506-.17l-.203.827Zm-.134-10.878a1.807 1.807 0 0 1-1.275.492c-.496 0-.924-.164-1.28-.492a1.57 1.57 0 0 1-.533-1.193c0-.465.18-.865.533-1.196a1.812 1.812 0 0 1 1.28-.497c.497 0 .923.165 1.275.497.353.331.53.731.53 1.196 0 .467-.177.865-.53 1.193Z" style="fill:#157ffb;fill-rule:nonzero;" transform="translate(-1.257 -1.257) scale(1.0582)"></path></svg><p class="custom-container-title">计算机硬件层面</p><p>😴</p></div><p>那么在计算机硬件层面是如何做到的呢？其实，在执行了 volatile 变量的赋值后，还会 <strong>额外增加一个 lock 前缀指令</strong>，这个指令会 <strong>将当前 CPU 的 Cache 写入主内存，并无效化其他 CPU 的 Cache</strong>，相当于执行 assign 后，有进行了 store -&gt; write。</p><p>这使得 <strong>其他 CPU 可以立即看见 volatile 变量的修改。因为其他 CPU 在读取 volatile 变量时，会发现缓存已过期，于是不得不去主存中拉取最新的值</strong>，也就是被迫在 use 前进行了一次 read -&gt; load。</p><p>lock 指令就是一个原子操作。原子操作是指不会被线程调度机制打断的操作；这种操作一旦开始，就一直运行到结束，中间不会有任何 context switch （切换到另一个线程）。</p><h3 id="_3-2-如何禁止指令重排" tabindex="-1"><a class="header-anchor" href="#_3-2-如何禁止指令重排" aria-hidden="true">#</a> 3.2 如何禁止指令重排？</h3><p>volatile 是通过编译器在生成字节码时，在指令序列中添加 “<strong>内存屏障</strong>” 来禁止指令重排序的。</p><p>Java 编译器会在生成指令系列时在适当的位置会插入内存屏障指令来禁止特定类型的处理器重排序。</p><p>为了实现 volatile 内存语义，JMM 针对编译器制定的 volatile 重排序规则表：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202212271554260.png" alt="image-20221227155357106"></p><p>从上图可以看出：</p><ul><li>当第二个操作是 volatile 写时，不管第一个操作是什么，<strong>都不能重排序</strong>。 这个规则确保 <strong>volatile 写之前的操作不会被编译器重排序到此操作之后</strong>。</li><li>当第一个操作是 volatile 读时，不管第二个操作是什么，<strong>都不能重排序</strong>。 这个规则确保 <strong>volatile 读之后的操作不会被编译器重排序到此操作之前</strong>。</li><li>当第一个操作是 volatile 写，第二个操作是 volatile 读或写时，不能重排序。</li></ul><p>对于编译器来说，发现一个最优布置来最小化插入屏障的总数几乎不可能，为此，JMM 采取保守策略。</p><p>下面是基于保守策略（能加屏障就都加）的 JMM 内存屏障插入策略：</p><ul><li>在每个 volatile 写操作的前面插入一个 StoreStore 屏障。</li><li>在每个 volatile 写操作的后面插入一个 StoreLoad 屏障。</li><li>在每个 volatile 读操作的后面插入一个 LoadLoad 屏障。</li><li>在每个 volatile 读操作的后面插入一个 LoadStore 屏障。</li></ul><p>上述内存屏障插入策略虽然非常保守，但它可以保证在任意处理器平台，任意的程序中都能得到正确的volatile 内存语义。</p><p>volatile 写插入内存屏障后生成的指令序列示意图：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202212271604166.png" alt="image-20221227160418688"></p><p>图中的 StoreStore 屏障可以保证在 volatile 写之前，其前面的所有普通写操作已经对任意处理器可见了。这是因为 StoreStore 屏障将保障上面所有的普通写在 volatile 写之前刷新到主内存。</p><p>volatile 写后面的 StoreLoad 屏障。此屏障的作用是避免 volatile 写与后面可能有的volatile 读/写操作重排序。</p><p>volatile 读插入内存屏障后生成的指令序列示意图：</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202212271612845.png" alt="image-20221227161243751"></p><p>图中的 LoadLoad 屏障用来禁止处理器把上面的 volatile 读与下面的普通读重排序。LoadStore 屏障用来禁止处理器把上面的 volatile 读与下面的普通写重排序。</p><p>上述 volatile 写和 volatile 读的内存屏障插入策略非常保守。在实际执行时，只要不改变 volatile 写-读的内存语义，编译器可以根据具体情况省略不必要的屏障。</p><h3 id="_3-3-为何不保证原子性" tabindex="-1"><a class="header-anchor" href="#_3-3-为何不保证原子性" aria-hidden="true">#</a> 3.3 为何不保证原子性？</h3><p>一个变量简单的读取和赋值操作是原子性的，但将一个变量赋值给另外一个变量的操作不是原子性的。</p><p>Java 内存模型（JMM）仅仅保障了变量的基本 <strong>读取</strong> 和 <strong>赋值</strong> 操作是原子性的，其他均不会保证的。如果想要使某段代码块要求具备原子性，就需要使用 synchronized 关键字、Lock 锁、Atomic 各种类型的原子类来实现。</p><p>所以，Java 中只有对 <strong>基本类型变量的赋值和读取是原子操作</strong>，如 <code>i = 1</code> 的赋值操作。但是像 <code>j = i</code> 或者 <code>i++</code> 这样的操作都 <strong>不是原子操作</strong>，因为他们都进行了多次原子操作，比如先读取 <code>i</code> 的值，再将 <code>i</code> 的值赋值给 <code>j</code>，两个原子操作加起来就不是原子操作了。</p><h2 id="_4-volatile-和-synchronized-的区别" tabindex="-1"><a class="header-anchor" href="#_4-volatile-和-synchronized-的区别" aria-hidden="true">#</a> 4. volatile 和 synchronized 的区别</h2><p>synchronized 关键字和 volatile 关键字是两个互补的存在，而不是对立的存在。</p><p>volatile 关键字是线程同步的轻量级实现，所以 volatile 性能肯定比 synchronized 好。</p><p>但是 <strong>volatile</strong> 关键字 <strong>只能用于变量</strong>，而 <strong>synchronized</strong> 可以 <strong>修饰方法</strong> 以及 <strong>代码块</strong> 。</p><p><strong>volatile</strong> <strong>保证数据的可见性</strong>，可以 <strong>禁止指令重排</strong>，但 <strong>不能保证数据的原子性</strong>；</p><p><strong>synchronized 关键字能保证可见性和原子性，但不能禁止指令重排</strong>。</p><p>因此 synchronized 和 volatile 通常配合起来使用，保证并发的安全。</p><h2 id="_5-volatile-应用场景" tabindex="-1"><a class="header-anchor" href="#_5-volatile-应用场景" aria-hidden="true">#</a> 5. volatile 应用场景</h2><h3 id="_5-1-状态标志" tabindex="-1"><a class="header-anchor" href="#_5-1-状态标志" aria-hidden="true">#</a> 5.1 状态标志</h3><p>在并发操作中，如果需要有一个状态标志变量，用于某些判断，那么可以将这个状态标志变量用 volatile 修饰。</p><p>例如，<strong>AQS 同步器框架中的 <code>state</code> 同步状态标志，就是使用 volatile 修饰的</strong>。</p><p>许多使用 AQS 实现的同步器，如 ReentrantLock、CountDownLatch、Semaphore 等，他们在被并发访问时，都需要先获取 <code>state</code> 来判断是否能执行后续的操作，所以同步状态 <code>state</code> 的可见性是非常重要的，否则可能会出现加锁错误等等 Bug。</p><h3 id="_5-2-单例模式" tabindex="-1"><a class="header-anchor" href="#_5-2-单例模式" aria-hidden="true">#</a> 5.2 单例模式</h3><p>在单例模式的双重检测锁（DCL）模式下，实例变量是需要用 volatile 修饰的，原因在代码中：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LazySingletonDCL</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">LazySingletonDCL</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * volatile 防止指令重排：
     * 因为在 instance = new LazySingletonDCL(); 时分为三步：
     * 1. 分配内存空间
     * 2. 执行构造方法，初始化对象；
     * 3. 把这个对象指向分配的空间
     *
     * 如果线程1 的执行顺序是 132，那么线程2 在线程1 执行到第三步时，
     * 发现 instance 不为 null，则直接返回，此时线程2 获取到的 instance 其实是还没有实例化的。
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">LazySingletonDCL</span> instance<span class="token punctuation">;</span>

    <span class="token comment">// 不使用 synchronized 加锁，自己判断是否需要加锁</span>
    <span class="token keyword">public</span> <span class="token class-name">LazySingletonDCL</span> <span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 当判断实例为空时，别的线程可能插队实例化</span>
            <span class="token comment">// 所以在这里先锁住整个类，锁住后不可能插队了，再判断一次再实例化</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token class-name">LazySingletonDCL</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>instance <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    instance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LazySingletonDCL</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> instance<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-3-volatile-bean-模式" tabindex="-1"><a class="header-anchor" href="#_5-3-volatile-bean-模式" aria-hidden="true">#</a> 5.3 volatile bean 模式</h3><p><strong>volatile bean 模式</strong> 的基本原理是：很多框架为易变数据的持有者（例如 HttpSession）提供了容器，但是放入这些容器中的对象必须是线程安全的。 这就导致了 <strong>从容器中获取的数据可能是旧数据</strong>。</p><p>在 <strong>volatile bean 模式</strong> 中，JavaBean 的所有数据成员都是 <strong>volatile</strong> 类型的，并且 getter 和 setter 方法必须非常普通 —— 除了获取或设置相应的属性外，不能包含任何逻辑。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">User</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token class-name">String</span> name<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> age<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setName</span><span class="token punctuation">(</span><span class="token class-name">String</span> name<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> name<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setAge</span><span class="token punctuation">(</span><span class="token keyword">int</span> age<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> age<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> name<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getAge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> age<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_5-4-开销较低的读-写锁策略" tabindex="-1"><a class="header-anchor" href="#_5-4-开销较低的读-写锁策略" aria-hidden="true">#</a> 5.4 开销较低的读－写锁策略</h3><p>如果读操作远远超过写操作，可以结合使用内部锁和 volatile 变量来减少公共代码路径的开销。</p><p>线程安全的计数器使用 <code>synchronized</code> 确保增量操作是原子的，并使用 <code>volatile</code> 保证当前结果的可见性。</p><p>如果更新不频繁的话，该方法可实现更好的性能，因为读路径的开销仅仅涉及 volatile 读操作，这通常要优于一个无竞争的锁获取的开销。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CheesyCounter</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">int</span> value<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token punctuation">;</span> <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">int</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> value<span class="token operator">++</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-参考文章" tabindex="-1"><a class="header-anchor" href="#_6-参考文章" aria-hidden="true">#</a> 6. 参考文章</h2><div class="custom-container link"><a class="external-link" href="https://github.com/TangBean/Java-Concurrency-in-Practice" rel="noopener noreferrer" target="_blank"><!--[--><!--]--><!----><span></span><!--[--><!--]--></a><img alt="link-image" src="https://github.com/fluidicon.png" class="custom-container-identifier"><div class="custom-container-title">《Java 并发编程实战》阅读笔记</div><div class="custom-container-description"><p class="custom-container-link-text"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-139.52 -43.52 599.04 599.04" fill="currentColor"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg> github.com</p><!--[--><!--]--></div></div><div class="custom-container link"><a class="external-link" href="https://book.douban.com/subject/26591326/" rel="noopener noreferrer" target="_blank"><!--[--><!--]--><!----><span></span><!--[--><!--]--></a><img alt="link-image" src="https://img1.doubanio.com/favicon.ico" class="custom-container-identifier"><div class="custom-container-title">《Java 并发编程的艺术》</div><div class="custom-container-description"><p class="custom-container-link-text"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-139.52 -43.52 599.04 599.04" fill="currentColor"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg> book.douban.com</p><!--[--><!--]--></div></div><div class="custom-container link"><a class="external-link" href="https://javaguide.cn/" rel="noopener noreferrer" target="_blank"><!--[--><!--]--><!----><span></span><!--[--><!--]--></a><img alt="link-image" src="https://javaguide.cn/favicon.ico" class="custom-container-identifier"><div class="custom-container-title">Java Guide</div><div class="custom-container-description"><p class="custom-container-link-text"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-139.52 -43.52 599.04 599.04" fill="currentColor"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg> javaguide.cn</p><!--[--><!--]--></div></div><div class="custom-container link"><a class="external-link" href="https://cloud.tencent.com/developer/article/1340711#:~:text=%EE%80%80volatile%20bean%20%E6%A8%A1%E5%BC%8F%EE%80%81%E7%9A%84%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86%E6%98%AF%EF%BC%9A%E5%BE%88%E5%A4%9A%E6%A1%86%E6%9E%B6%E4%B8%BA%E6%98%93%E5%8F%98%E6%95%B0%E6%8D%AE%E7%9A%84%E6%8C%81%E6%9C%89%E8%80%85%EF%BC%88%E4%BE%8B%E5%A6%82%20HttpSession%EF%BC%89%E6%8F%90%E4%BE%9B%E4%BA%86%E5%AE%B9%E5%99%A8%EF%BC%8C%E4%BD%86%E6%98%AF%E6%94%BE%E5%85%A5%E8%BF%99%E4%BA%9B%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%84%E5%AF%B9%E8%B1%A1%E5%BF%85%E9%A1%BB%E6%98%AF%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8%E7%9A%84%E3%80%82%20%E5%9C%A8%20%EE%80%80volatile%20bean%20%E6%A8%A1%E5%BC%8F%EE%80%81%E4%B8%AD%EF%BC%8CJavaBean,%EE%80%80volatile%EE%80%81%20%E7%B1%BB%E5%9E%8B%E7%9A%84%EF%BC%8C%E5%B9%B6%E4%B8%94%20getter%20%E5%92%8C%20setter%20%E6%96%B9%E6%B3%95%E5%BF%85%E9%A1%BB%E9%9D%9E%E5%B8%B8%E6%99%AE%E9%80%9A%20%E2%80%94%E2%80%94%20%E9%99%A4%E4%BA%86%E8%8E%B7%E5%8F%96%E6%88%96%E8%AE%BE%E7%BD%AE%E7%9B%B8%E5%BA%94%E7%9A%84%E5%B1%9E%E6%80%A7%E5%A4%96%EF%BC%8C%E4%B8%8D%E8%83%BD%E5%8C%85%E5%90%AB%E4%BB%BB%E4%BD%95%E9%80%BB%E8%BE%91%E3%80%82" rel="noopener noreferrer" target="_blank"><!--[--><!--]--><!----><span></span><!--[--><!--]--></a><img alt="link-image" src="https://cloud.tencent.com/favicon.ico" class="custom-container-identifier"><div class="custom-container-title">Java 理论与实践：正确使用 volatile 变量</div><div class="custom-container-description"><p class="custom-container-link-text"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-139.52 -43.52 599.04 599.04" fill="currentColor"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg> cloud.tencent.com</p><!--[--><!--]--></div></div></div><!--[--><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg><a class="external-link meta-item-label" href="https://github.com/AruNi-01/github.AruNi.io/edit/main/posts/2022-12-27-volatile 详解.md" rel="noopener noreferrer" target="_blank" aria-label="Edit this page on GitHub"><!--[--><!--]--><!----><span>Edit this page on GitHub</span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><!----><!--[--><div class="pager"><a href="/posts/2022-12-18-String%20%E7%B1%BB.html" class="previous">Previous<br><span>String 类</span></a><!----></div><!--]--><!----></main><ul class="catalog" style="top:0px;"><li class="level-2 toc-link-_1-认识-volatile">1. 认识 volatile</li><li class="level-2 toc-link-_2-jmm-介绍">2. JMM 介绍</li><li class="level-2 toc-link-_3-volatile-底层原理">3. volatile 底层原理</li><li class="level-3 toc-link-_3-1-如何保证可见性">3.1 如何保证可见性？</li><li class="level-3 toc-link-_3-2-如何禁止指令重排">3.2 如何禁止指令重排？</li><li class="level-3 toc-link-_3-3-为何不保证原子性">3.3 为何不保证原子性？</li><li class="level-2 toc-link-_4-volatile-和-synchronized-的区别">4. volatile 和 synchronized 的区别</li><li class="level-2 toc-link-_5-volatile-应用场景">5. volatile 应用场景</li><li class="level-3 toc-link-_5-1-状态标志">5.1 状态标志</li><li class="level-3 toc-link-_5-2-单例模式">5.2 单例模式</li><li class="level-3 toc-link-_5-3-volatile-bean-模式">5.3 volatile bean 模式</li><li class="level-3 toc-link-_5-4-开销较低的读-写锁策略">5.4 开销较低的读－写锁策略</li><li class="level-2 toc-link-_6-参考文章">6. 参考文章</li></ul></div><!--]--></div><div class="search-page" role="search"><span class="search-close"><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 448 512" width="28" height="28" fill="currentColor"><path d="M224 416c-8.188 0-16.38-3.125-22.62-9.375l-192-192c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L224 338.8l169.4-169.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-192 192C240.4 412.9 232.2 416 224 416z"></path></svg></span><div class="gungnir-search-box"><input placeholder="$ grep title | tag ..." autocomplete="off" spellcheck="false" value><!----></div></div><div class="menu-btn-container"><div class="menu-btn-wrapper"><div class="menu-btn"><div style="" class="menu-btn-icon"><span></span><span></span><span></span></div><div style="display:none;" class="menu-text">0</div><svg class="menu-progress"><circle class="menu-border" cx="50%" cy="50%" r="48%" style="stroke-dasharray:0% 314.15926%;"></circle></svg></div><div class="menu-btn-child-wrapper"><div title="toggle color mode" class="menu-btn-child"><svg class="ov-icon" style="font-size:1.2em;display:none;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M256 160c-52.9 0-96 43.1-96 96s43.1 96 96 96 96-43.1 96-96-43.1-96-96-96zm246.4 80.5l-94.7-47.3 33.5-100.4c4.5-13.6-8.4-26.5-21.9-21.9l-100.4 33.5-47.4-94.8c-6.4-12.8-24.6-12.8-31 0l-47.3 94.7L92.7 70.8c-13.6-4.5-26.5 8.4-21.9 21.9l33.5 100.4-94.7 47.4c-12.8 6.4-12.8 24.6 0 31l94.7 47.3-33.5 100.5c-4.5 13.6 8.4 26.5 21.9 21.9l100.4-33.5 47.3 94.7c6.4 12.8 24.6 12.8 31 0l47.3-94.7 100.4 33.5c13.6 4.5 26.5-8.4 21.9-21.9l-33.5-100.4 94.7-47.3c13-6.5 13-24.7.2-31.1zm-155.9 106c-49.9 49.9-131.1 49.9-181 0-49.9-49.9-49.9-131.1 0-181 49.9-49.9 131.1-49.9 181 0 49.9 49.9 49.9 131.1 0 181z"/></svg><svg class="ov-icon" style="font-size:1.2em;display:none;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M283.211 512c78.962 0 151.079-35.925 198.857-94.792 7.068-8.708-.639-21.43-11.562-19.35-124.203 23.654-238.262-71.576-238.262-196.954 0-72.222 38.662-138.635 101.498-174.394 9.686-5.512 7.25-20.197-3.756-22.23A258.156 258.156 0 00283.211 0c-141.309 0-256 114.511-256 256 0 141.309 114.511 256 256 256z"/></svg><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M224 96l16-32 32-16-32-16-16-32-16 32-32 16 32 16 16 32zM80 160l26.66-53.33L160 80l-53.34-26.67L80 0 53.34 53.33 0 80l53.34 26.67L80 160zm352 128l-26.66 53.33L352 368l53.34 26.67L432 448l26.66-53.33L512 368l-53.34-26.67L432 288zm70.62-193.77L417.77 9.38C411.53 3.12 403.34 0 395.15 0c-8.19 0-16.38 3.12-22.63 9.38L9.38 372.52c-12.5 12.5-12.5 32.76 0 45.25l84.85 84.85c6.25 6.25 14.44 9.37 22.62 9.37 8.19 0 16.38-3.12 22.63-9.37l363.14-363.15c12.5-12.48 12.5-32.75 0-45.24zM359.45 203.46l-50.91-50.91 86.6-86.6 50.91 50.91-86.6 86.6z"/></svg></div><div class="menu-btn-child"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M207.029 381.476L12.686 187.132c-9.373-9.373-9.373-24.569 0-33.941l22.667-22.667c9.357-9.357 24.522-9.375 33.901-.04L224 284.505l154.745-154.021c9.379-9.335 24.544-9.317 33.901.04l22.667 22.667c9.373 9.373 9.373 24.569 0 33.941L240.971 381.476c-9.373 9.372-24.569 9.372-33.942 0z"/></svg></div><div class="menu-btn-child"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-75.52 -43.52 599.04 599.04" fill="currentColor"><path d="M240.971 130.524l194.343 194.343c9.373 9.373 9.373 24.569 0 33.941l-22.667 22.667c-9.357 9.357-24.522 9.375-33.901.04L224 227.495 69.255 381.516c-9.379 9.335-24.544 9.317-33.901-.04l-22.667-22.667c-9.373-9.373-9.373-24.569 0-33.941L207.03 130.525c9.372-9.373 24.568-9.373 33.941-.001z"/></svg></div><div class="menu-btn-child menu-toc-btn"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-43.52 -43.52 599.04 599.04" fill="currentColor"><path d="M48 48a48 48 0 1048 48 48 48 0 00-48-48zm0 160a48 48 0 1048 48 48 48 0 00-48-48zm0 160a48 48 0 1048 48 48 48 0 00-48-48zm448 16H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16zm0-320H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16V80a16 16 0 00-16-16zm0 160H176a16 16 0 00-16 16v32a16 16 0 0016 16h320a16 16 0 0016-16v-32a16 16 0 00-16-16z"/></svg></div><div class="toggle-sidebar-button menu-btn-child menu-btn-sidebar" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><svg class="ov-icon" style="font-size:1.2em;" aria-hidden="true" width="19.2" height="19.2" viewbox="-1.6 -1.6 19.2 19.2" fill="currentColor"><path d="M14 2a1 1 0 011 1v10a1 1 0 01-1 1H2a1 1 0 01-1-1V3a1 1 0 011-1h12zM2 1a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V3a2 2 0 00-2-2H2z"/><path d="M3 4a1 1 0 011-1h2a1 1 0 011 1v8a1 1 0 01-1 1H4a1 1 0 01-1-1V4z"/></svg></div></div></div></div><footer class="footer"><span>
      <a href="https://v2.vuepress.vuejs.org/" target="_blank">VuePress</a> 🤍
      <a href="https://github.com/Renovamen/vuepress-theme-gungnir" target="_blank">Gungnir</a>
      <br>
      Copyright &copy; 2020-2022 <a href="https://github.com/AruNi-01" target="_blank">AruNi_Lu</a>
    </span></footer></div><!----><!--]--></div>
    <script type="module" src="/assets/app.b6a0c7cc.js" defer></script>
  </body>
</html>
