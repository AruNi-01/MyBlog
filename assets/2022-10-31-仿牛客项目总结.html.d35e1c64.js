import{_ as c,r as l,o as e,c as o,b as n,a,w as t,e as p,d as i}from"./app.b6a0c7cc.js";const u={},k=n("p",null,"\u725B\u5BA2\u793E\u533A\u9879\u76EE\u603B\u7ED3\uFF0C\u4ECE\u6570\u636E\u5E93\u8BBE\u8BA1\u5230\u91CD\u70B9\u7684\u529F\u80FD\u5B9E\u73B0\uFF0C\u518D\u5230\u6027\u80FD\u4F18\u5316\uFF0C\u53E6\u5916\u81EA\u5DF1\u6DFB\u52A0\u4E86\u4E8C\u7EA7\u7F13\u5B58",-1),r={class:"custom-container tip"},d={viewBox:"0 0 25 25",xmlns:"http://www.w3.org/2000/svg","xml:space":"preserve",style:{"fill-rule":"evenodd","clip-rule":"evenodd","stroke-linejoin":"round","stroke-miterlimit":"2"}},v=n("path",{d:"M297.6 258.73H296c-59.47.87-110.69 51.45-111.83 110.43-.626 36.485 16.525 71.085 45.94 92.68 17.86 13.18 29.88 33.56 33.77 56.42h67.62c4-22.82 16.13-43.3 34.16-56.74 28.589-21.097 45.496-54.587 45.496-90.118 0-30.03-12.078-58.833-33.496-79.882a113.133 113.133 0 0 0-80.06-32.79ZM265.19 550.7v26.6c0 4.84 1.17 6.43 1.17 6.43l63.72-.59V550.7h-64.89Z",style:{fill:"#48b884","fill-rule":"nonzero"},transform:"matrix(.042 0 0 .042 0 -5.178)"},null,-1),m=n("path",{d:"M297.64 123.3C133.26 123.3 0 256.56 0 420.94s133.26 297.63 297.64 297.63 297.63-133.25 297.63-297.63S462 123.3 297.64 123.3ZM385 487.57c-14.11 10.48-22.51 28.09-22.51 47.14v48.43c-.016 17.792-14.648 32.428-32.44 32.45h-64.86c-15.6 0-32.44-12-32.44-38.29v-42.82c0-19-8.21-36.4-21.93-46.52-37.882-27.85-59.959-72.44-59.14-119.45 1.46-77.24 66-141.09 143.81-142.22 38.87.19 76.89 14.37 105 42.11a143.764 143.764 0 0 1 43.14 103c-.159 45.761-21.911 88.86-58.63 116.17Z",style:{fill:"#48b884","fill-rule":"nonzero"},transform:"matrix(.042 0 0 .042 0 -5.178)"},null,-1),b=[v,m],g=n("p",{class:"custom-container-title"},"\u672C\u6587\u5185\u5BB9\uFF1A",-1),y={class:"table-of-contents"},f=p("1. \u6570\u636E\u5E93\u8BBE\u8BA1"),w=p("1.1 \u7528\u6237\u8868 user"),h=p("1.2 \u5E16\u5B50\u8868 discuss_post"),q=p("1.3 \u8BC4\u8BBA\u8868 comment"),S=p("1.4 \u6D88\u606F\u8868 message"),_=p("1.5 \u767B\u5F55\u51ED\u8BC1\u8868 login_ticket"),C=p("2. \u4E1A\u52A1\u5F00\u53D1"),T=p("2.1 \u9996\u9875"),x=p("2.2 \u6CE8\u518C\u529F\u80FD"),R=p("2.3 \u767B\u5F55\u529F\u80FD\uFF08\u91CD\u70B9\uFF09"),L=p("2.4 \u4FEE\u6539\u4E2A\u4EBA\u4FE1\u606F\uFF08\u91CD\u70B9\uFF09"),I=p("2.5 \u8FC7\u6EE4\u654F\u611F\u8BCD"),E=p("2.6 \u7EDF\u4E00\u5F02\u5E38\u5904\u7406"),P=p("2.7 \u7EDF\u4E00\u65E5\u5FD7\u7BA1\u7406"),D=p("3. Redis \u76F8\u5173"),A=p("3.1 \u70B9\u8D5E\uFF08\u91CD\u70B9\uFF09"),j=p("3.2 \u5173\u6CE8\uFF08\u91CD\u70B9\uFF09"),O=p("3.3 \u9875\u9762\u4F18\u5316"),U=p("3.4 Redis \u9AD8\u7EA7\u6570\u636E\u7C7B\u578B"),M=p("4. Kafka \u76F8\u5173"),B=p("4.1 \u4EC0\u4E48\u662F Kafka"),N=p("4.2 \u53D1\u9001\u7CFB\u7EDF\u901A\u77E5"),K=p("5. ElasticSearch \u76F8\u5173"),H=p("5.1 \u4E3A\u4EC0\u4E48\u8981\u7528 ES"),F=p("5.2 \u4EC0\u4E48\u662F ES"),J=p("5.3 \u641C\u7D22\u529F\u80FD"),V=p("6. \u5B9A\u65F6\u4EFB\u52A1"),z=p("6.1 \u8BA4\u8BC6 Quartz"),W=p("6.2 \u70ED\u699C\u5E16\u5B50\u5B9E\u73B0"),Q=p("7. \u4E8C\u7EA7\u7F13\u5B58\u4F18\u5316\u6027\u80FD"),G=p("7.1 \u8BA4\u8BC6 Caffeine"),Y=p("7.2 \u4F7F\u7528 Caffeine"),$=p("7.3 \u914D\u5408 Redis \u505A\u4E8C\u7EA7\u7F13\u5B58"),X=p("8. \u9879\u76EE\u603B\u7ED3"),Z=p("9. \u5FC3\u5F97\u4F53\u4F1A"),nn=p("\u5F85\u5B8C\u5584"),sn=i(`<h2 id="_1-\u6570\u636E\u5E93\u8BBE\u8BA1" tabindex="-1"><a class="header-anchor" href="#_1-\u6570\u636E\u5E93\u8BBE\u8BA1" aria-hidden="true">#</a> 1. \u6570\u636E\u5E93\u8BBE\u8BA1</h2><h3 id="_1-1-\u7528\u6237\u8868-user" tabindex="-1"><a class="header-anchor" href="#_1-1-\u7528\u6237\u8868-user" aria-hidden="true">#</a> 1.1 \u7528\u6237\u8868 user</h3><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281420343.png" alt="image-20221028141958998"></p><h3 id="_1-2-\u5E16\u5B50\u8868-discuss-post" tabindex="-1"><a class="header-anchor" href="#_1-2-\u5E16\u5B50\u8868-discuss-post" aria-hidden="true">#</a> 1.2 \u5E16\u5B50\u8868 discuss_post</h3><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281425105.png" alt="image-20221028142548808"></p><blockquote><p>\u4E3A\u4EC0\u4E48\u8981\u5C06\u5E16\u5B50\u8BC4\u8BBA\u6570\u91CF\u653E\u5728\u5E16\u5B50\u8868\uFF1F</p></blockquote><p>\u5982\u679C\u4E0D\u653E\u5728\u5E16\u5B50\u8868\uFF0C\u90A3\u4E48\u5728\u67E5\u8BE2\u5E16\u5B50\u7684\u8BC4\u8BBA\u6570\u91CF\u65F6\u5C31\u9700\u8981\u5148\u5728\u8BC4\u8BBA\u8868\u4E2D\u67E5\u51FA post_id \u4E3A\u5F53\u524D\u5E16\u5B50\u7684\u8BC4\u8BBA\u6570\u91CF\uFF0C\u8FD9\u6837\u5728\u8BC4\u8BBA\u8868\u4E2D\u626B\u63CF\u67E5\u8BE2\u80AF\u5B9A\u662F\u6BD4\u76F4\u63A5\u4ECE\u5E16\u5B50\u8868\u4E2D\u8FDB\u884C\u7B49\u503C\u67E5\u8BE2\u6027\u80FD\u5DEE\u7684\u3002</p><h3 id="_1-3-\u8BC4\u8BBA\u8868-comment" tabindex="-1"><a class="header-anchor" href="#_1-3-\u8BC4\u8BBA\u8868-comment" aria-hidden="true">#</a> 1.3 \u8BC4\u8BBA\u8868 comment</h3><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281437335.png" alt="image-20221028143740939"></p><h3 id="_1-4-\u6D88\u606F\u8868-message" tabindex="-1"><a class="header-anchor" href="#_1-4-\u6D88\u606F\u8868-message" aria-hidden="true">#</a> 1.4 \u6D88\u606F\u8868 message</h3><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281446446.png" alt="image-20221028144604816"></p><p>\u6CE8\u610F\uFF1A</p><ul><li>\u6D88\u606F\u8868\u65E2\u4FDD\u5B58\u7528\u6237\u4E4B\u95F4\u7684\u79C1\u4FE1\uFF0C\u4E5F\u4FDD\u5B58\u7CFB\u7EDF\u6D88\u606F\u901A\u77E5\uFF1B</li></ul><p>\u82E5\u4FDD\u5B58\u7684\u662F\u7528\u6237\u4E4B\u95F4\u7684\u79C1\u4FE1\uFF1A</p><ul><li>from_id\uFF1A\u53D1\u4FE1\u606F\u7684\u7528\u6237 id\uFF1B</li><li>to_id\uFF1A\u6536\u4FE1\u606F\u7684\u7528\u6237 id\uFF1B</li><li>conversation_id\uFF1A\u683C\u5F0F\u89C4\u5B9A\u4E3A\uFF1A[\u53C2\u4E0E\u79C1\u4FE1\u7684\u4E24\u4E2A\u7528\u6237 id \u4E2D\u7684\u6700\u5C0F\u503C] _ [\u53C2\u4E0E\u79C1\u4FE1\u7684\u4E24\u4E2A\u7528\u6237 id \u4E2D\u7684\u6700\u5927\u503C]\u3002 <ul><li>\u6C38\u8FDC\u628A\u8F83\u5C0F\u7684 id \u653E\u5728\u524D\u9762\u7684\u89C4\u5B9A\u4FDD\u8BC1\u4E86\u79C1\u4FE1\u7684\u552F\u4E00\u6027\u3002\u4F8B\u5982 1_2 \u548C 2_1 \u662F\u540C\u4E00\u4E2A\u79C1\u4FE1\u3002</li></ul></li><li>content\uFF1A\u79C1\u4FE1\u7684\u5185\u5BB9\uFF0C\u5C31\u662F\u666E\u901A\u7684 text \u6587\u672C\u683C\u5F0F\uFF1B</li></ul><p>\u82E5\u4FDD\u5B58\u7684\u662F\u7CFB\u7EDF\u6D88\u606F\u901A\u77E5\uFF1A</p><ul><li>from_id\uFF1A\u56FA\u5B9A\u4E3A 1\uFF0C\u8868\u793A\u7CFB\u7EDF\u7BA1\u7406\u5458\uFF1B</li><li>to_id\uFF1A\u8981\u901A\u77E5\u7684\u7528\u6237 id\uFF1B</li><li>conversation_id\uFF1A\u7531\u4E8E\u7CFB\u7EDF\u901A\u77E5\u5206\u4E3A\u4E09\u5927\u7C7B\uFF0C\u6240\u4EE5\u6709\u4E09\u79CD\u4E0D\u540C\u7684\u503C\uFF0C\u6BCF\u79CD\u503C\u5BF9\u5E94 Kafka \u7684 Topic\uFF0C\u5E94\u4E3A\u7CFB\u7EDF\u901A\u77E5\u662F\u91C7\u7528 Kafka \u5B8C\u6210\u7684\uFF0C\u5177\u4F53\u5B9E\u73B0\u5728\u540E\u9762\u3002 <ul><li>follow\uFF1A\u5173\u6CE8\u901A\u77E5</li><li>like\uFF1A\u70B9\u8D5E\u901A\u77E5</li><li>comment\uFF1A\u8BC4\u8BBA\u901A\u77E5</li></ul></li><li>content\uFF1AJSON \u5B57\u7B26\u4E32\uFF0C\u5177\u4F53\u5185\u5BB9\u6839\u636E\u901A\u77E5\u7684\u7C7B\u578B\u800C\u5B9A\uFF1A <ul><li>follow \u7C7B\u578B\uFF1A{&quot;entityType&quot;: \u901A\u77E5\u7C7B\u578B\uFF0C3 \u8868\u793A\u5173\u6CE8\uFF0C&quot;entityId&quot;\uFF1A\u88AB\u901A\u77E5\u7684\u5B9E\u4F53 id(\u5BF9\u4E8E\u5173\u6CE8\u6765\u8BF4\u662F\u7528\u6237 id)\uFF0C&quot;userId&quot;: \u89E6\u53D1\u901A\u77E5\u7684\u7528\u6237 id}</li><li>like \u7C7B\u578B\uFF1A{&quot;entityType&quot;: \u901A\u77E5\u7C7B\u578B\uFF0C2 \u8868\u793A\u70B9\u8D5E\uFF0C&quot;entityId&quot;: \u88AB\u901A\u77E5\u7684\u5B9E\u4F53 id(\u5BF9\u4E8E\u70B9\u8D5E\u6765\u8BF4\u662F\u5E16\u5B50 id)\uFF0C&quot;postId&quot;: \u88AB\u70B9\u8D5E\u7684\u5E16\u5B50 id\uFF0C&quot;userId&quot;: \u89E6\u53D1\u70B9\u8D5E\u7684\u7528\u6237 id}</li><li>comment \u7C7B\u578B\uFF1A{&quot;entityType&quot;: \u901A\u77E5\u7C7B\u578B\uFF0C1 \u8868\u793A\u8BC4\u8BBA\uFF0C&quot;entityId&quot;\uFF1A\u88AB\u8BC4\u8BBA\u7684\u5B9E\u4F53 id(\u5BF9\u4E8E\u8BC4\u8BBA\u6765\u8BF4\u662F\u5E16\u5B50 id\uFF0C\u6216\u8005\u88AB\u8BC4\u8BBA\u7684\u8BC4\u8BBA id)\uFF0C&quot;postId&quot;: \u88AB\u8BC4\u8BBA\u7684\u5E16\u5B50 id\uFF0C&quot;userId&quot;: \u89E6\u53D1\u8BC4\u8BBA\u7684\u7528\u6237 id}</li></ul></li></ul><h3 id="_1-5-\u767B\u5F55\u51ED\u8BC1\u8868-login-ticket" tabindex="-1"><a class="header-anchor" href="#_1-5-\u767B\u5F55\u51ED\u8BC1\u8868-login-ticket" aria-hidden="true">#</a> 1.5 \u767B\u5F55\u51ED\u8BC1\u8868 login_ticket</h3><p>\u8BE5\u8868\u6700\u540E\u88AB\u5E9F\u5F03\uFF0C\u4F7F\u7528 Redis \u4EE3\u66FF\u4E86\u3002</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281622257.png" alt="image-20221028162221130"></p><p>\u51ED\u8BC1\u76F8\u5F53\u4E0E session\uFF0C\u53EA\u662F\u7528\u4E86\u6570\u636E\u5E93\u8868\u6765\u5B58\u8FD9\u4E2A\u51ED\u8BC1\u4FE1\u606F\u3002</p><p>\u5728\u767B\u5F55\u65F6\u5C06\u7528\u6237\u7684\u4FE1\u606F\u5B58\u5165 login_ticket \u8868\u4E2D\uFF0C\u5728\u8BF7\u6C42\u524D\u4ECE\u6570\u636E\u5E93\u4E2D\u83B7\u53D6\u51ED\u8BC1\uFF0C\u82E5\u83B7\u53D6\u6210\u529F\u4E14\u51ED\u8BC1\u6709\u6548\u8BF4\u660E\u7528\u6237\u5DF2\u767B\u5F55\u3002</p><h2 id="_2-\u4E1A\u52A1\u5F00\u53D1" tabindex="-1"><a class="header-anchor" href="#_2-\u4E1A\u52A1\u5F00\u53D1" aria-hidden="true">#</a> 2. \u4E1A\u52A1\u5F00\u53D1</h2><h3 id="_2-1-\u9996\u9875" tabindex="-1"><a class="header-anchor" href="#_2-1-\u9996\u9875" aria-hidden="true">#</a> 2.1 \u9996\u9875</h3><p>\u9996\u9875\u9700\u8981\u7684\u6570\u636E\u6709\u5E16\u5B50\u4FE1\u606F\uFF08\u6807\u9898\uFF0C\u65F6\u95F4\u7B49\uFF09\u3001\u5E16\u5B50\u4F5C\u8005\u4FE1\u606F\uFF08\u7528\u6237\u7684\u5934\u50CF\u3001\u7528\u6237\u540D\uFF09\u3002</p><p>\u6240\u4EE5\u53EA\u9700\u8981\u67E5\u8BE2\u51FA\u6240\u6709\u7684\u5E16\u5B50\uFF0C\u5F97\u5230\u5E16\u5B50\u540E\uFF0C\u518D\u6839\u636E user_id \u67E5\u51FA\u7528\u6237\u4FE1\u606F\uFF0C\u5C06\u5B83\u4EEC\u4E00\u5BF9\u4E00\u7684\u5C01\u88C5\u5230\u4E00\u4E2A Map \u7C7B\u578B\u7684 List \u4E2D\uFF0C\u8FD4\u56DE\u7ED9\u524D\u7AEF\u5373\u53EF\u3002</p><p>\u4E3A\u4E86\u51CF\u5C0F\u6570\u636E\u5E93\u548C\u6D4F\u89C8\u5668\u7684\u538B\u529B\uFF0C\u9700\u8981\u5206\u9875\u8FD4\u56DE\u6570\u636E\u3002</p><blockquote><p>\u5206\u9875\u529F\u80FD\u7684\u8BBE\u8BA1</p></blockquote><p>\u81EA\u5B9A\u4E49\u4E86\u4E00\u4E2A\u5206\u9875\u7684\u7C7B\uFF0C\u8868\u793A\u5206\u9875\u65F6\u6240\u9700\u7684\u4FE1\u606F\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Page</span> <span class="token punctuation">{</span>

    <span class="token comment">// \u5F53\u524D\u9875\u7801\uFF0C\u9ED8\u8BA41</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> current <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">// \u6BCF\u9875\u663E\u793A\u7684\u6570\u91CF\uFF0C\u9ED8\u8BA410</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>

    <span class="token comment">//\u6570\u636E\u603B\u6570\uFF0C\u7528\u4E8E\u8BA1\u7B97\u603B\u9875\u9762\u6570\u91CF</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> rows<span class="token punctuation">;</span>

    <span class="token comment">// \u67E5\u8BE2\u8DEF\u5F84\uFF0C\u67D0\u9875\u7684 url\uFF08\u7528\u4E8E\u590D\u7528\u5206\u9875\u7684\u8FDE\u63A5\uFF09</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> path<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u83B7\u53D6\u5F53\u524D\u9875\u7684\u8D77\u59CB\u884C
     * <span class="token keyword">@return</span> \u5F53\u524D\u9875\u7684\u8D77\u59CB\u884C
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOffset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// current * limit - limit</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>current <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u83B7\u53D6\u603B\u9875\u6570
     * <span class="token keyword">@return</span> \u603B\u9875\u6570
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// rows / limit [+1]</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">%</span> limit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> rows <span class="token operator">/</span> limit<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token keyword">return</span> rows<span class="token operator">/</span> limit <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u83B7\u53D6\u8D77\u59CB\u9875\u7801\uFF08\u9875\u6570\u8F83\u591A\u65F6\uFF0C\u53EA\u663E\u793A\u5F53\u524D\u9875\u53F7\u7684\u524D\u4E24\u4E2A\u9875\u53F7\u548C\u4E24\u4E2A\u9875\u53F7\uFF09
     * <span class="token keyword">@return</span> \u8D77\u59CB\u9875\u7801
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getFrom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> from <span class="token operator">=</span> current <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> from <span class="token operator">&lt;</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> from<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token doc-comment comment">/**
     * \u83B7\u53D6\u6700\u540E\u9875\u7801\uFF08\u9875\u6570\u8F83\u591A\u65F6\uFF0C\u53EA\u663E\u793A\u5F53\u524D\u9875\u53F7\u7684\u524D\u4E24\u4E2A\u9875\u53F7\u548C\u4E24\u4E2A\u9875\u53F7\uFF09
     * <span class="token keyword">@return</span> \u6700\u540E\u9875\u7801
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">int</span> <span class="token keyword">to</span> <span class="token operator">=</span> current <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> total <span class="token operator">=</span> <span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">to</span> <span class="token operator">&gt;</span> total <span class="token operator">?</span> total <span class="token operator">:</span> <span class="token keyword">to</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setCurrent</span><span class="token punctuation">(</span><span class="token keyword">int</span> current<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">&gt;=</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>current <span class="token operator">=</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setLimit</span><span class="token punctuation">(</span><span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>limit <span class="token operator">&gt;=</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> limit <span class="token operator">&lt;=</span> <span class="token number">100</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>limit <span class="token operator">=</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setRows</span><span class="token punctuation">(</span><span class="token keyword">int</span> rows<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">&gt;=</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>rows <span class="token operator">=</span> rows<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5206\u9875\u5BF9\u8C61\u4FE1\u606F\u5728\u524D\u540E\u7AEF\u4E92\u4F20\uFF1A</p><ul><li><p>\u521D\u59CB\u65F6\u540E\u7AEF\u4F1A\u6839\u636E Page \u5BF9\u8C61\u7684\u9ED8\u8BA4 <code>current</code> \u548C <code>limit</code> \u67E5\u8BE2\u51FA\u5BF9\u5E94\u6761\u6570\u7684\u6570\u636E\u4F20\u7ED9\u524D\u7AEF\uFF1B</p></li><li><p>\u524D\u7AEF\u53EF\u4EE5\u6839\u636E Page \u5BF9\u8C61\u83B7\u53D6\u9875\u7684\u603B\u6570\u3001\u5F53\u524D\u9875\u7684\u8D77\u59CB\u4F4D\u7F6E\u7B49\u4FE1\u606F\uFF0C\u5F53\u70B9\u51FB\u522B\u7684\u9875\u65F6\uFF0C\u4F1A\u5C06 Page \u5BF9\u8C61\u7684 <code>current</code> \u6539\u6210\u5BF9\u5E94\u7684\u9875\u53F7\uFF0C\u7136\u540E\u901A\u8FC7 <code>path</code> \u91CD\u65B0\u8BBF\u95EE\u540E\u7AEF\uFF0C\u5C06\u65B0\u7684 Page \u4F20\u7ED9\u540E\u7AEF\uFF0C\u540E\u7AEF\u518D\u83B7\u53D6\u65B0 Page \u4E2D\u7684\u9875\u53F7\uFF0C\u91CD\u65B0\u67E5\u8BE2\u6570\u636E\u8FD4\u56DE\uFF1B</p></li></ul><h3 id="_2-2-\u6CE8\u518C\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_2-2-\u6CE8\u518C\u529F\u80FD" aria-hidden="true">#</a> 2.2 \u6CE8\u518C\u529F\u80FD</h3><p>\u6CE8\u518C\u529F\u80FD\u4E0D\u9700\u8981\u8FD4\u56DE\u4EC0\u4E48\u6570\u636E\uFF0C\u82E5\u6CE8\u518C\u6210\u529F\u5219\u8DF3\u8F6C\u5230\u6210\u529F\u9875\u9762\uFF0C\u7ED9\u4E00\u4E2A\u6FC0\u6D3B\u8D26\u53F7\u7684\u8FDE\u63A5\uFF0C\u6CE8\u518C\u5931\u8D25\u5219\u9700\u8981\u5C06\u539F\u56E0\u63D0\u793A\u7ED9\u7528\u6237\u3002</p><p>\u82E5\u80FD\u6CE8\u518C\u6210\u529F\uFF1A</p><ol><li>\u9700\u8981\u968F\u673A\u4E3A\u7528\u6237\u751F\u6210\u4E00\u4E2A\u76D0\uFF0C\u7528\u4E8E\u5BF9\u5BC6\u7801\u52A0\u5BC6\uFF0C\u6570\u636E\u5E93\u4E2D\u5B58\u50A8\u7684\u90FD\u662F\u52A0\u5BC6\u540E\u7684\u5BC6\u7801\u3002</li><li>\u968F\u673A\u751F\u6210\u4E00\u4E2A\u6FC0\u6D3B\u7801\uFF0C\u53D1\u9001\u6FC0\u6D3B\u90AE\u4EF6\uFF0C\u76F4\u63A5\u4F7F\u7528 SpringMail\u3002</li></ol><h3 id="_2-3-\u767B\u5F55\u529F\u80FD-\u91CD\u70B9" tabindex="-1"><a class="header-anchor" href="#_2-3-\u767B\u5F55\u529F\u80FD-\u91CD\u70B9" aria-hidden="true">#</a> 2.3 \u767B\u5F55\u529F\u80FD\uFF08\u91CD\u70B9\uFF09</h3><p>\u56E0\u4E3A\u767B\u5F55\u6210\u529F\u540E\uFF0C\u9700\u8981\u5C06\u767B\u5F55\u4FE1\u606F\u4FDD\u5B58\u8D77\u6765\uFF0C\u65B9\u4FBF\u7528\u6237\u8FDB\u884C\u4EE5\u540E\u7684\u8BF7\u6C42\uFF0C\u6240\u4EE5\u9700\u8981\u8003\u8651\u4E0B\u9762\u7684\u95EE\u9898\u3002</p><p>\u5206\u5E03\u5F0F session \u95EE\u9898\uFF1A</p><p>\u4F20\u7EDF\u7684\u505A\u6CD5\u662F\u76F4\u63A5\u67E5\u8BE2 user \u8868\u83B7\u53D6 user \u5BF9\u8C61\uFF0C\u7136\u540E\u5B58\u5165 session \u4E2D\uFF0C\u4E4B\u540E\u5C31\u53EF\u4EE5\u6839\u636E session \u83B7\u53D6\u7528\u6237\u4FE1\u606F\u4E86\u3002</p><p>\u8FD9\u6837\u7684\u65B9\u6848\u5728\u5206\u5E03\u5F0F\u90E8\u7F72\u65F6\u4F1A\u51FA\u73B0\u4EC0\u4E48\u95EE\u9898\u5462\uFF1F</p><p>\u5206\u5E03\u5F0F\u90E8\u7F72\u610F\u5473\u7740\u6709\u591A\u53F0\u670D\u52A1\u5668\uFF0C\u800C session \u662F\u5B58\u50A8\u5728\u670D\u52A1\u5668\u4E0A\u7684\uFF0C\u90A3\u4E48\u5982\u679C\u6211\u4E0B\u6B21\u8BF7\u6C42\u7684\u670D\u52A1\u5668\u548C\u6211\u521D\u59CB\u65F6\u8BF7\u6C42\u7684\u670D\u52A1\u5668\u4E0D\u4E00\u6837\uFF0C\u5C31\u4F1A\u56E0\u53E6\u4E00\u53F0\u670D\u52A1\u5668\u6CA1\u6709\u4FDD\u5B58\u6211\u7684 session \u800C\u5224\u5B9A\u6211\u4E3A\u672A\u767B\u5F55\u72B6\u6001\u3002</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281719174.png" alt="image-20221028171918119"></p><p>\u5982\u4F55\u89E3\u51B3\u5462\uFF1F</p><ul><li>\u53EF\u4EE5\u540C\u6B65\u670D\u52A1\u5668\u7684 session\uFF0C\u4F46\u662F\u8FD9\u6837\u4E0D\u4E45\u6D6A\u8D39\u670D\u52A1\u5668\u8D44\u6E90\u4E86\u5417\uFF1F</li><li>\u90A3\u8981\u4E0D\uFF0C\u4F7F\u7528 cookie\uFF1Fcookie \u4EE5\u660E\u6587\u5F62\u5F0F\u5B58\u50A8\u5728\u5BA2\u6237\u7AEF\uFF0C\u4E0D\u5B89\u5168\u3002</li></ul><p>\u6211\u4EEC\u521D\u6B65\u7684\u89E3\u51B3\u65B9\u6848\u662F\u5EFA\u4E00\u4E2A\u767B\u5F55\u51ED\u8BC1\u8868\uFF0C\u628A\u7528\u6237\u4FE1\u606F\u4FDD\u5B58\u5230\u8868\u4E2D\uFF0C\u6709\u4E00\u4E2A ticket \u5B57\u6BB5\uFF0C\u5B58\u653E\u5230 cookie \u4E2D\uFF0C\u56E0\u4E3A\u53EA\u662F\u5B58\u653E\u4E86\u4E00\u4E32\u968F\u673A\u5B57\u7B26\u4E32\u5230 cookie\uFF0C\u5176\u4ED6\u9690\u79C1\u4FE1\u606F\u90FD\u5728\u8868\u4E2D\uFF0C\u9700\u8981\u901A\u8FC7 ticket \u8BBF\u95EE\u8868\u624D\u80FD\u83B7\u53D6\u3002</p><p>\u4F46\u662F\u8FD9\u6837\u5C82\u4E0D\u662F\u8981\u989D\u5916\u5EFA\u4E00\u5F20\u8868\u6765\u5B58\u653E\u51ED\u8BC1\u4FE1\u606F\uFF0C\u4E5F\u6709\u70B9\u6D6A\u8D39\u8D44\u6E90\u554A\uFF0C\u800C\u4E14\u6BCF\u6B21\u90FD\u8981\u67E5\u8BE2\u6570\u636E\u5E93\uFF0C\u6548\u7387\u4E5F\u4E0D\u9AD8\u3002</p><p>\u6240\u4EE5\u6700\u7EC8\u7684\u89E3\u51B3\u65B9\u6848\u662F\u4F7F\u7528 <strong>Redis</strong>\uFF1A</p><ul><li>\u5B58\u50A8\u7684 key \u4E3A ticket\uFF0Cvalue \u4E3A\u5B57\u7B26\u4E32\u5373\u53EF\uFF0C\u56E0\u4E3A\u8981\u5C06\u767B\u5F55\u51ED\u8BC1 LoginTicket \u5BF9\u8C61\u5E8F\u5217\u5316\u540E\u518D\u5B58\u5165 Redis\uFF1B</li><li>\u540C\u6837\uFF0C\u8FD8\u662F\u628A ticket \u5B58\u653E\u5230 cookie \u4E2D\uFF1B</li><li>\u7531\u4E8E Redis \u7684\u6027\u80FD\u9AD8\uFF0C\u800C\u4E14\u8BBE\u7F6E\u4E86\u51ED\u8BC1\u7684\u8FC7\u671F\u65F6\u95F4\uFF0C\u8FC7\u671F\u7684\u952E\u4F1A\u81EA\u52A8\u4ECE Redis \u4E2D\u5220\u9664\uFF0C\u4E5F\u4E0D\u6D6A\u8D39\u8D44\u6E90\uFF1B</li></ul><p>\u73B0\u5728\u5728\u767B\u5F55\u6210\u529F\u540E\uFF0C\u4F1A\u751F\u6210\u4E00\u4E2A\u5E26\u6709\u7528\u6237\u4FE1\u606F\u548C\u8FC7\u671F\u65F6\u95F4\u7684\u767B\u5F55\u51ED\u8BC1 LoginTicket \u5BF9\u8C61\uFF0C\u4FDD\u5B58\u5230 Redis \u4E2D\u3002</p><p>\u63A5\u7740\u8FD8\u8981\u628A\u751F\u6210\u7684\u51ED\u8BC1 ticket \u5B58\u5165\u5230\u5BA2\u6237\u7AEF\u7684 cookie \u4E2D\uFF0C\u540C\u6837\u4E5F\u8981\u8BBE\u7F6E\u76F8\u540C\u7684\u8FC7\u671F\u65F6\u95F4\u3002</p><p>\u4E4B\u540E\u5BA2\u6237\u7AEF\u5411\u670D\u52A1\u5668\u8BF7\u6C42\u7684\u65F6\u5019\u5C31\u4F1A\u5E26\u4E0A cookie\u3002</p><p>\u90A3\u4E48\u6211\u4EEC\u4ECE\u54EA\u513F\u83B7\u53D6 cookie \u5462\uFF1F\u5F53\u7136\u65F6\u8981\u5728\u7528\u6237\u8BF7\u6C42\u9875\u9762\u524D\u83B7\u53D6\uFF0C\u8FD9\u6837\u624D\u80FD\u5728\u9875\u9762\u663E\u793A\u524D\u628A\u7528\u6237\u7684\u72B6\u6001\u67E5\u8BE2\u51FA\u6765\u3002</p><p>\u6211\u4EEC\u901A\u8FC7 <strong>\u62E6\u622A\u5668</strong> \u6765\u5B9E\u73B0\uFF0C\u4F7F\u7528 Spring \u81EA\u5E26\u7684\u62E6\u622A\u5668\uFF0C\u5B9E\u73B0 HandlerInterceptor \u540E\uFF0C\u53EF\u4EE5\u91CD\u5199 3 \u4E2A\u65B9\u6CD5\uFF1A</p><ul><li>preHandle\uFF1A\u5728\u76EE\u6807\u8BF7\u6C42\u65B9\u6CD5\u6267\u884C\u524D\u6267\u884C\uFF1B</li><li>postHandle\uFF1A\u5728\u76EE\u6807\u8BF7\u6C42\u65B9\u6CD5\u6267\u884C\u4E4B\u540E\uFF0C\u89C6\u56FE\u672A\u8FD4\u56DE\u524D\u6267\u884C\uFF1B</li><li>afterCompletion\uFF1A\u5728\u6574\u4E2A\u6D41\u7A0B\u6267\u884C\u5B8C\u6BD5\u540E\u6267\u884C\uFF08DispatcherServlet \u5B8C\u5168\u5904\u7406\u5B8C\u8BF7\u6C42\u540E\uFF09\uFF1B</li></ul><p>\u6700\u540E\u5728 WebMvcConfig\uFF08\u9700\u5B9E\u73B0 WebMvcConfigurer\uFF09\u7684 addInterceptors \u65B9\u6CD5\u4E2D\u6DFB\u52A0\u8BE5\u62E6\u622A\u5668\uFF0C\u5373\u53EF\u5B9E\u73B0\u62E6\u622A\u529F\u80FD\u3002</p><p>\u6839\u636E\u6211\u4EEC\u7684\u4E1A\u52A1\u9700\u6C42\uFF0C\u6211\u4EEC\u9700\u8981\u5728\u8BF7\u6C42\u524D\u67E5\u8BE2\u51FA\u7528\u6237\u7684\u767B\u5F55\u72B6\u6001\u3002</p><p>\u6240\u4EE5\u9700\u8981\u5728 preHandle \u4E2D\u83B7\u53D6\u51ED\u8BC1\u4FE1\u606F\uFF0C\u901A\u8FC7\u8BF7\u6C42 request \u83B7\u53D6\u5230 cookie \u540E\uFF0C\u518D\u6839\u636E cookie \u4ECE Redis \u6C47\u603B\u67E5\u8BE2\u51FA LoginTicket \u5BF9\u8C61\uFF0C\u767B\u5F55\u51ED\u8BC1\u4E2D\u5373\u6709\u7528\u6237\u7684 id\uFF0C\u90A3\u4E48\u5C31\u80FD\u83B7\u53D6\u5230\u7528\u6237\u7684\u6240\u6709\u4FE1\u606F\u4E86\u3002</p><p>\u90A3\u6211\u4EEC\u83B7\u53D6\u5230\u7528\u6237\u4FE1\u606F\u540E\uFF0C\u4E3A\u4E86\u540E\u9762\u7684\u64CD\u4F5C\u4E2D\u53EF\u4EE5\u65B9\u4FBF\u7684\u83B7\u53D6\u7528\u6237\u4FE1\u606F\uFF0C\u600E\u4E48\u6837\u4FDD\u5B58\u8FD9\u4E2A\u7528\u6237\u4FE1\u606F\u5462\uFF1F</p><p>\u4E00\u4E2A\u597D\u7684\u65B9\u6CD5\u662F\u4F7F\u7528 <strong>ThreadLocal</strong>\uFF0C<strong>\u5B83\u53EF\u4EE5\u5728\u540C\u4E00\u7EBF\u7A0B\u4E2D\u5F88\u65B9\u4FBF\u7684\u83B7\u53D6\u7528\u6237\u4FE1\u606F\uFF0C\u4E0D\u9700\u8981\u9891\u7E41\u7684\u4F20\u9012\u5BF9\u8C61</strong>\u3002</p><p>\u6240\u4EE5\u5728 preHandle \u4E2D\u83B7\u53D6\u5230\u7528\u6237\u4FE1\u606F\u540E\uFF0C\u5C06\u7528\u6237\u4FE1\u606F\u5B58\u5165 ThreadLocal\uFF0C\u540E\u7EED\u5728\u4EFB\u4F55\u5730\u65B9\u90FD\u53EF\u4EE5\u4ECE ThreadLocal \u4E2D\u83B7\u53D6\u5230\u5F53\u524D\u7528\u6237\u7684\u4FE1\u606F\u3002</p><p>\u9664\u6B64\u4E4B\u5916\uFF0C\u5F53\u7528\u6237\u5B58\u5165 ThreadLocal \u540E\uFF0C\u6211\u4EEC\u8FD8\u5728 postHandle \u4E2D\u901A\u8FC7 ThreadLocal \u83B7\u53D6\u7528\u6237\u4F20\u7ED9\u524D\u7AEF\uFF0C\u65B9\u4FBF\u524D\u7AEF\u5224\u65AD\u5F53\u524D\u7528\u6237\u662F\u5426\u5DF2\u5177\u6709\u767B\u5F55\u51ED\u8BC1\u3002</p><p>\u6700\u540E\uFF0C\u5F53\u6574\u4E2A\u6D41\u7A0B\u6267\u884C\u5B8C\u6BD5\u540E\uFF0C\u8BB0\u5F97\u5728 afterCompletion \u4E2D\u6E05\u7406\u6389 ThreadLocal\uFF0C\u5426\u5219\u53EF\u80FD\u53D1\u751F\u5185\u5B58\u6CC4\u6F0F\uFF08GC \u81EA\u52A8\u6E05\u7406\u6CA1\u6709\u6E05\u7406\u6389\uFF09\u3002</p><p>\u62E6\u622A\u5668\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: \u767B\u5F55\u51ED\u8BC1\u62E6\u622A\u5668\uFF0C\u7528\u4E8E\u5728\u8BF7\u6C42\u524D\u83B7\u53D6\u51ED\u8BC1
 * \u82E5\u83B7\u53D6\u6210\u529F\u4E14\u51ED\u8BC1\u6709\u6548\u8BF4\u660E\u7528\u6237\u5DF2\u767B\u5F55\uFF0C\u5C06\u7528\u6237\u5B58\u5165 ThreadLocal \u4E2D\uFF0C
 * \u7136\u540E\u5728\u751F\u6210\u89C6\u56FE\u4E4B\u524D\u5C06 ThreadLocal \u4E2D\u7684\u5F53\u524D\u7528\u6237\u4F20\u7ED9\u89C6\u56FE\u5C42\uFF0C
 * \u89C6\u56FE\u5C42\u6839\u636E loginUser \u662F\u5426\u4E3A\u7A7A\u6765\u5224\u65AD\u7528\u6237\u662F\u5426\u5DF2\u767B\u5F55\u3002
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/11
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginTicketInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">LoginTicketInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u4ECE Cookie \u4E2D\u83B7\u53D6\u51ED\u8BC1</span>
        <span class="token class-name">String</span> ticket <span class="token operator">=</span> <span class="token class-name">CookieUtil</span><span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token string">&quot;ticket&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>ticket <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u67E5\u8BE2\u51ED\u8BC1</span>
            <span class="token class-name">LoginTicket</span> loginTicket <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findLoginTicket</span><span class="token punctuation">(</span>ticket<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u68C0\u67E5\u51ED\u8BC1\u662F\u5426\u6709\u6548</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loginTicket <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> loginTicket<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> loginTicket<span class="token punctuation">.</span><span class="token function">getExpired</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u6839\u636E\u51ED\u8BC1\u67E5\u8BE2\u7528\u6237</span>
                <span class="token class-name">User</span> user <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>loginTicket<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u5728\u672C\u6B21\u8BF7\u6C42\u4E2D\u6301\u6709\u7528\u6237\uFF08\u5B58\u5165ThreadLocal\uFF0C\u5728controller\u4E2D\u901A\u8FC7UserThreadLocal.get\u76F4\u63A5\u83B7\u53D6\u5373\u53EF\uFF09</span>
                <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token comment">// \u6784\u5EFA\u7528\u6237\u8BA4\u8BC1\u7684\u7ED3\u679C\uFF0C\u5E76\u5B58\u5165 SecurityContext\uFF0C\u4EE5\u4FBF\u4E8E Security \u8FDB\u884C\u6388\u6743</span>
                <span class="token class-name">Authentication</span> authentication <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span>
                        user<span class="token punctuation">,</span> user<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">setContext</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">SecurityContextImpl</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">postHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">ModelAndView</span> modelAndView<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u4ECE ThreadLocal \u4E2D\u83B7\u53D6\u8BE5\u7528\u6237\uFF0C\u8FD4\u56DE\u7ED9\u89C6\u56FE\u5C42</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> modelAndView <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            modelAndView<span class="token punctuation">.</span><span class="token function">addObject</span><span class="token punctuation">(</span><span class="token string">&quot;loginUser&quot;</span><span class="token punctuation">,</span> user<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterCompletion</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">,</span> <span class="token class-name">Exception</span> ex<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5728 DispatcherServlet \u5B8C\u5168\u5904\u7406\u5B8C\u8BF7\u6C42\u540E\u88AB\u8C03\u7528</span>
        <span class="token comment">// \u89C6\u56FE\u5C42\u90FD\u7528\u5B8C\u4E86\uFF0C\u6E05\u7406\u6389 ThreadLocal\uFF0C\u5426\u5219\u53EF\u80FD\u6709\u5185\u5B58\u6CC4\u9732\u7684\u98CE\u9669\uFF08GC \u81EA\u52A8\u6E05\u7406\u6CA1\u6709\u6E05\u7406\u6389\uFF09</span>
        <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//        SecurityContextHolder.clearContext();</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-4-\u4FEE\u6539\u4E2A\u4EBA\u4FE1\u606F-\u91CD\u70B9" tabindex="-1"><a class="header-anchor" href="#_2-4-\u4FEE\u6539\u4E2A\u4EBA\u4FE1\u606F-\u91CD\u70B9" aria-hidden="true">#</a> 2.4 \u4FEE\u6539\u4E2A\u4EBA\u4FE1\u606F\uFF08\u91CD\u70B9\uFF09</h3><p>\u4FEE\u6539\u4E2A\u4EBA\u4FE1\u606F\u4E0D\u662F\u4E3B\u8981\u7684\uFF0C\u91CD\u70B9\u662F\u9700\u8981\u767B\u5F55\u7684\u7528\u6237\u624D\u80FD\u8FDB\u884C\u4FEE\u6539\u9875\u9762\u7684\u8BBF\u95EE\u3002</p><p>\u53EF\u4EE5\u4F7F\u7528\u4E0A\u9762\u7684\u62E6\u622A\u5668\u6765\u5B9E\u73B0\uFF0C\u4F46\u662F\u5982\u679C\u4EE5\u540E\u53C8\u6709\u4E00\u4E9B\u9875\u9762\u8981\u767B\u5F55\u540E\u624D\u80FD\u8BBF\u95EE\uFF0C\u90A3\u52A0\u4E00\u4E2A\u9700\u6C42\u5C31\u53BB\u4FEE\u6539\u62E6\u622A\u5668\u6E90\u7801\u5417\uFF1F\u5982\u679C\u6211\u53C8\u4E0D\u60F3\u62E6\u622A\u4E86\u5462\uFF0C\u53C8\u53BB\u628A\u5BF9\u5E94\u7684\u6E90\u7801\u5220\u6389\uFF1F\u8FD9\u6837\u4E5F\u592A\u9EBB\u70E6\u4E86\u3002</p><p>\u6240\u4EE5\u8FD9\u91CC\u63D0\u4F9B\u53E6\u4E00\u79CD\u62E6\u622A\u65B9\u5F0F\uFF0C\u901A\u8FC7 <strong>\u81EA\u5B9A\u4E49\u6CE8\u89E3</strong> \u8FDB\u884C\u62E6\u622A\u3002\u88AB\u8FD9\u4E2A\u6CE8\u89E3\u6807\u6CE8\u7684\u8BF7\u6C42\u65B9\u6CD5\uFF0C\u5C31\u4F1A\u88AB\u8FD9\u4E2A\u62E6\u622A\u5668\u62E6\u622A\u3002</p><p>\u81EA\u5B9A\u4E49\u4E00\u4E2A LoginRequired \u6CE8\u89E3\uFF0C\u91CC\u9762\u4EC0\u4E48\u4E5F\u4E0D\u7528\u5199\uFF0C\u53EA\u662F\u5176\u4E00\u4E2A\u6807\u6CE8\u7684\u4F5C\u7528\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span>METHOD<span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span><span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span>RUNTIME<span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">LoginRequired</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u7F16\u5199\u62E6\u622A\u5668\uFF0C\u62E6\u622A\u5E26\u6709\u6B64\u6CE8\u89E3\u7684\u65B9\u6CD5\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: \u9700\u8981\u767B\u5F55\u624D\u80FD\u8BF7\u6C42\u7684\u62E6\u622A\u5668
 * \u4F7F\u7528\u6CE8\u89E3\u5B9E\u73B0\uFF1A
 *      \u5F53\u65B9\u6CD5\u4E2D\u6CE8\u89E3\u4E86 @LoginRequired \u65F6\uFF0C\u8BF4\u660E\u8BE5\u65B9\u6CD5\u9700\u8981\u767B\u5F55\u540E\u624D\u80FD\u8BF7\u6C42
 *      \u672C\u62E6\u622A\u5668\u5C31\u662F\u6839\u636E\u6CE8\u89E3\u6765\u62E6\u622A\u5BF9\u5E94\u7684\u65B9\u6CD5\u7684
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/12
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginRequiredInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5F53\u524D\u62E6\u622A\u7684\u5BF9\u8C61\u662F\u4E00\u4E2A\u65B9\u6CD5\u65F6\uFF0C\u624D\u62E6\u622A</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>handler <span class="token keyword">instanceof</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// \u83B7\u53D6\u5F53\u524D\u62E6\u622A\u7684\u65B9\u6CD5</span>
            <span class="token class-name">Method</span> method <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">HandlerMethod</span><span class="token punctuation">)</span> handler<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">LoginRequired</span> loginRequired <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">LoginRequired</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u82E5\u5F53\u524D\u62E6\u622A\u7684\u65B9\u6CD5\u6CE8\u89E3\u4E86 @LoginRequired\uFF0C\u8BF4\u660E\u5F53\u524D\u65B9\u6CD5\u9700\u8981\u767B\u5F55\uFF0C</span>
            <span class="token comment">// \u4F46 ThreadLocal \u53D6\u4E0D\u5230\u7528\u6237\uFF0C\u8BF4\u660E\u672A\u767B\u5F55\uFF0C\u9700\u8981\u62E6\u622A\u3002</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>loginRequired <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u91CD\u5B9A\u5411\u5230\u767B\u5F55\u754C\u9762\uFF0C\u4E0D\u653E\u884C</span>
                response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6700\u540E\u4E5F\u8981\u5728 WebMvcConfig \u4E2D\u6DFB\u52A0\u6B64\u62E6\u622A\u5668\u3002</p><p>\u73B0\u5728\uFF0C\u53EA\u9700\u8981\u5728\u9700\u8981\u8FDB\u884C\u767B\u5F55\u62E6\u622A\u7684\u8BF7\u6C42\u65B9\u6CD5\u4E2D\u52A0\u4E0A\u6B64\u6CE8\u89E3\uFF0C\u5C31\u4F1A\u88AB\u8BE5\u62E6\u622A\u5668\u62E6\u622A\u4E86\u3002</p><h3 id="_2-5-\u8FC7\u6EE4\u654F\u611F\u8BCD" tabindex="-1"><a class="header-anchor" href="#_2-5-\u8FC7\u6EE4\u654F\u611F\u8BCD" aria-hidden="true">#</a> 2.5 \u8FC7\u6EE4\u654F\u611F\u8BCD</h3><p>\u8FC7\u6EE4\u654F\u611F\u8BCD\u4E3B\u8981\u662F\u4E3A\u4E86\u53D1\u5E16\u65F6\u548C\u8BC4\u8BBA\u65F6\u5BF9\u654F\u611F\u8BCD\u8FDB\u884C\u8FC7\u6EE4\uFF0C\u8FC7\u6EE4\u654F\u611F\u8BCD\u4F7F\u7528\u524D\u7F00\u6811\u6BD4\u8F83\u65B9\u4FBF\uFF0C\u53EF\u4EE5\u4F9D\u6B21\u6BD4\u8F83\u67D0\u4E2A\u533A\u95F4\u7684\u5185\u5BB9\u662F\u5426\u4E3A\u654F\u611F\u5185\u5BB9\u3002</p><blockquote><p>\u4EC0\u4E48\u662F\u524D\u7F00\u6811\uFF1F</p></blockquote><p>Trie \u6811\u4E5F\u79F0\u4E3A\u524D\u7F00\u6811\u3001\u5B57\u5178\u6811\uFF0C\u6700\u5927\u7684\u7279\u70B9\u5C31\u662F <strong>\u5171\u4EAB\u5B57\u7B26\u4E32\u7684\u516C\u5171\u524D\u7F00</strong> \u6765\u8FBE\u5230\u8282\u7701\u7A7A\u95F4\u7684\u76EE\u7684\u3002</p><p>Trie \u6811\u7684\u6839\u8282\u70B9\u4E0D\u5B58\u50A8\u6570\u636E\uFF0C\u6BCF\u4E00\u6761\u5B8C\u6574\u7684\u5206\u652F\u4EE3\u8868\u4E00\u4E2A\u5B8C\u6574\u7684\u5B57\u7B26\u4E32\u3002</p><p><strong>Trie \u6811\u7684\u672C\u8D28\uFF0C\u5C31\u662F\u5229\u7528\u5B57\u7B26\u4E32\u4E4B\u95F4\u7684\u516C\u5171\u524D\u7F00\uFF0C\u5C06\u91CD\u590D\u7684\u524D\u7F00\u5408\u5E76\u5728\u4E00\u8D77</strong>\u3002</p><p>\u4E3E\u4F8B\uFF1A</p><p>\u6709 6 \u4E2A\u5B57\u7B26\u4E32\uFF0C\u5B83\u4EEC\u5206\u522B\u662F\uFF1Ahow\uFF0Chi\uFF0Cher\uFF0Chello\uFF0Cso\uFF0Csee\u3002\u6211\u4EEC\u5E0C\u671B\u5728\u91CC\u9762\u591A\u6B21\u67E5\u627E\u67D0\u4E2A\u5B57\u7B26\u4E32\u662F\u5426\u5B58\u5728\u3002\u5982\u679C\u6BCF\u6B21\u67E5\u627E\uFF0C\u90FD\u662F\u62FF\u8981\u67E5\u627E\u7684\u5B57\u7B26\u4E32\u8DDF\u8FD9 6 \u4E2A\u5B57\u7B26\u4E32\u4F9D\u6B21\u8FDB\u884C\u5B57\u7B26\u4E32\u5339\u914D\uFF0C\u90A3\u6548\u7387\u5C31\u6BD4\u8F83\u4F4E\uFF0C\u6709\u6CA1\u6709\u66F4\u9AD8\u6548\u7684\u65B9\u6CD5\u5462\uFF1F</p><p>\u8FD9\u4E2A\u65F6\u5019\uFF0C\u6211\u4EEC\u5C31\u53EF\u4EE5\u5148\u5BF9\u8FD9 6 \u4E2A\u5B57\u7B26\u4E32\u505A\u4E00\u4E0B\u9884\u5904\u7406\uFF0C\u7EC4\u7EC7\u6210 Trie \u6811\u7684\u7ED3\u6784\uFF0C\u4E4B\u540E\u6BCF\u6B21\u67E5\u627E\uFF0C\u90FD\u662F\u5728 Trie \u6811\u4E2D\u8FDB\u884C\u5339\u914D\u67E5\u627E\u3002\u6700\u540E\u6784\u9020\u51FA\u6765\u7684\u5C31\u662F\u4E0B\u9762\u8FD9\u4E2A\u56FE\u4E2D\u7684\u6837\u5B50\uFF1A</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210291316198.png" alt="image-20221029131606877"></p><p>\u6240\u4EE5\u5229\u7528\u524D\u7F00\u6811\u7684\u7279\u70B9\uFF0C\u53EF\u4EE5\u5F88\u65B9\u4FBF\u7684\u8FDB\u884C\u654F\u611F\u8BCD\u8FC7\u6EE4\u7684\u8BBE\u8BA1\u3002</p><blockquote><p>\u654F\u611F\u8BCD\u8FC7\u6EE4\u8BBE\u8BA1</p></blockquote><p>\u5728\u8BBE\u8BA1\u654F\u611F\u8BCD\u8FC7\u6EE4\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u6211\u4EEC\u53EF\u4EE5\u8FD9\u6837\u5B9A\u4E49Trie\u6811\uFF1A</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210291318306.png" alt="image-20221029131855347"></p><p>\u56FE\u4E2D\u7684\u7EA2\u53C9\u8868\u793A\u6807\u8BB0\u5230\u8FD9\u4E2A\u5B57\u7B26\uFF0C\u4ECE <code>root </code>\u5230\u6B64\u5B57\u7B26\u6240\u7ECF\u8FC7\u7684\u5B57\u7B26\u4E32\u662F\u654F\u611F\u8BCD\u3002</p><p>\u628A\u6240\u6709\u654F\u611F\u8BCD\u5B58\u5165Trie\u6811\u4E2D\uFF0C\u8BBE\u7F6E\u4E09\u4E2A\u6307\u9488\uFF1Ap1\u3001p2\u3001p3\u3002</p><p>\u5176\u4E2D\uFF1Ap1 \u6307\u5411 Trie \u6811\u7684\u6839\u8282\u70B9\uFF0Cp2 \u548C p3 \u6307\u5411\u5F85\u8FC7\u6EE4\u7684\u5B57\u7B26\u6570\u7EC4\u3002</p><p>\u8FC7\u6EE4\u8FC7\u7A0B\u7B97\u6CD5\u5982\u4E0B\uFF1A</p><ol><li>p1 \u627E\u5230 root \u4E0B\u4E00\u5C42\uFF0C\u770B\u6709\u6CA1\u6709\u4E0E p2 \u6307\u5411\u76F8\u540C\u7684\u5B57\u7B26\uFF0C\u82E5\u6CA1\u6709\u5219\u8BF4\u660E\u4EE5 p2 \u4F4D\u7F6E\u5F00\u59CB\u7684\u5B57\u7B26\u4E0D\u662F\u654F\u611F\u8BCD\uFF0Cp2 \u548C p3 \u90FD\u5411\u540E\u79FB\u52A8\uFF1B\u82E5\u6709\u5219\u8BF4\u660E p2 \u4F4D\u7F6E\u5F00\u59CB\u7684\u5B57\u7B26\u53EF\u80FD\u662F\u654F\u611F\u8BCD\uFF0Cp2 \u56FA\u5B9A\u4E0D\u52A8\uFF0Cp3 \u5411\u540E\u79FB\u52A8\uFF0C\u7136\u540E\u91CD\u590D\u4E0A\u8FF0\u8FC7\u7A0B\uFF1B</li><li>\u5982\u679C p1 \u6307\u5411\u4E86\u5E26\u6807\u8BB0\u7684\u8282\u70B9\uFF0C\u90A3\u4E48\u8BF4\u660E p2 ~ p3 \u533A\u95F4\u7684\u5B57\u7B26\u662F\u654F\u611F\u8BCD\uFF0C\u5C06 p2 ~ p3 \u533A\u95F4\u7684\u5B57\u7B26\u4E32\u7528 *** \u4EE3\u66FF\u5E76\u5B58\u5165\u7ED3\u679C\u6570\u7EC4\u4E2D\uFF0C\u6B64\u65F6\u5C06 p2 \u548C p3 \u90FD\u79FB\u52A8\u5230 p3 + 1 \u7684\u4F4D\u7F6E\uFF0C\u5F00\u59CB\u4E0B\u4E00\u8F6E\u7684\u8FC7\u6EE4\uFF1B</li><li>\u5982\u679C p1 \u6CA1\u6709\u6307\u5411\u5E26\u6807\u8BB0\u7684\u8282\u70B9\uFF0C\u8BF4\u660E p2 ~ p3 \u533A\u95F4\u7684\u5B57\u7B26\u4E0D\u662F\u654F\u611F\u8BCD\uFF0C\u5219\u5C06 p2++\uFF0Cp3 = p2\uFF0C\u91CD\u65B0\u5F00\u59CB\u4E0B\u4E00\u8F6E\u7684\u8FC7\u6EE4\uFF1B</li><li>\u5F53 p3 == \u6570\u7EC4\u957F\u5EA6\u65F6\uFF0C\u5C06\u5269\u4F59\u5B57\u7B26\u52A0\u5165\u7ED3\u679C\u6570\u7EC4\uFF1B</li></ol><p>\u590D\u6742\u5EA6\u5206\u6790\uFF1A</p><ul><li>\u5982\u679C\u654F\u611F\u8BCD\u7684\u957F\u5EA6\u4E3A m\uFF0C\u5219\u6BCF\u4E2A\u654F\u611F\u8BCD\u7684\u67E5\u627E\u65F6\u95F4\u590D\u6742\u5EA6\u662F O(m)\uFF0C\u5B57\u7B26\u4E32\u7684\u957F\u5EA6\u4E3A n\uFF0C\u6211\u4EEC\u9700\u8981\u904D\u5386 n \u904D\uFF0C\u6240\u4EE5\u654F\u611F\u8BCD <strong>\u67E5\u627E</strong> \u8FD9\u4E2A\u8FC7\u7A0B\u7684\u65F6\u95F4\u590D\u6742\u5EA6\u662F <strong>O(n * m)</strong>\u3002</li><li>\u5982\u679C\u6709 t \u4E2A\u654F\u611F\u8BCD\u7684\u8BDD\uFF0C<strong>\u6784\u5EFA</strong> trie \u6811\u7684\u65F6\u95F4\u590D\u6742\u5EA6\u662F <strong>O(t * m)</strong>\u3002</li></ul><blockquote><p>\u4EE3\u7801\u5B9E\u73B0</p></blockquote><p>\u4ECE\u4E0A\u56FE\u53EF\u4EE5\u770B\u5230\uFF0C\u6BCF\u4E2A\u8282\u70B9\u90FD\u4FDD\u5B58\u4E86\u5F53\u524D\u8282\u70B9\u7684\u5B57\u7B26\u503C\u548C\u5B83\u7684\u5B50\u8282\u70B9\uFF0C\u6240\u4EE5\u53EF\u4EE5\u4F7F\u7528 Map \u6765\u8868\u793A\u6BCF\u4E2A\u8282\u70B9\uFF0Ckey \u4E3A\u5B57\u7B26\uFF0Cvalue \u4E3A\u5B50\u8282\u70B9\uFF1B\u56E0\u4E3A\u4E00\u4E2A\u8282\u70B9\u7684\u5B50\u8282\u70B9\u4E2A\u6570\u672A\u77E5\uFF0C\u91C7\u7528 HashMap \u8FD8\u53EF\u4EE5\u52A8\u6001\u62D3\u5C55\uFF0C\u800C\u4E14\u53EF\u4EE5\u5728 O(1) \u590D\u6742\u5EA6\u5185\u5224\u65AD\u67D0\u4E2A\u5B50\u8282\u70B9\u662F\u5426\u5B58\u5728\u3002</p><p>\u6240\u4EE5\uFF0C\u524D\u7F00\u6811\u7684\u7ED3\u6784\u5B9A\u4E49\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// \u524D\u7F00\u6811\u7ED3\u6784\u7684\u5B9A\u4E49</span>
    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">TrieNode</span> <span class="token punctuation">{</span>

        <span class="token comment">// \u5173\u952E\u8BCD\u7ED3\u675F\u6807\u8BC6\uFF08\u4EE5\u5173\u952E\u8BCD\u7ED3\u5C3E\u7684\u5B57\u7B26\u7684\u6B64\u5C5E\u6027\u4E3A true\uFF09</span>
        <span class="token keyword">private</span> <span class="token keyword">boolean</span> isKeyWordEnd  <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

        <span class="token comment">// \u5B50\u8282\u70B9\u96C6\u5408\uFF08key\uFF1A\u4E0B\u7EA7\u5B57\u7B26\uFF0Cvalue\uFF1A\u4E0B\u7EA7\u8282\u70B9\uFF09</span>
        <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Character</span><span class="token punctuation">,</span> <span class="token class-name">TrieNode</span><span class="token punctuation">&gt;</span></span> subNodesMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setKeyWordEnd</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> keyWordEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            isKeyWordEnd <span class="token operator">=</span> keyWordEnd<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u6DFB\u52A0\u5B50\u8282\u70B9</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">addSubNode</span><span class="token punctuation">(</span><span class="token class-name">Character</span> c<span class="token punctuation">,</span> <span class="token class-name">TrieNode</span> node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            subNodesMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> node<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u83B7\u53D6\u5B50\u8282\u70B9</span>
        <span class="token keyword">public</span> <span class="token class-name">TrieNode</span> <span class="token function">getSubNode</span><span class="token punctuation">(</span><span class="token class-name">Character</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> subNodesMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u6211\u4EEC\u9700\u8981\u63D0\u524D\u521D\u59CB\u5316\u597D\u524D\u7F00\u6811\uFF0C\u4EE5\u4FBF\u8FDB\u884C\u654F\u611F\u8BCD\u7684\u5339\u914D\u8FC7\u6EE4\uFF0C\u6240\u4EE5\u9700\u8981\u5148\u5199\u4E00\u4E2A\u6DFB\u52A0\u654F\u611F\u8BCD\u5230\u524D\u7F00\u6811\u7684\u65B9\u6CD5\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// \u628A\u4E00\u4E2A\u654F\u611F\u8BCD\u6DFB\u52A0\u5230\u524D\u7F00\u6811\u4E2D</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">addKeyword</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyword<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5B9A\u4E49\u4E00\u4E2A\u53D8\u91CF\u6307\u5411\u6839\u8282\u70B9\uFF0C\u4ECE\u6839\u5F00\u59CB\u6DFB\u52A0</span>
        <span class="token class-name">TrieNode</span> curNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> keyword<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> c <span class="token operator">=</span> keyword<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TrieNode</span> subNode <span class="token operator">=</span> curNode<span class="token punctuation">.</span><span class="token function">getSubNode</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u5982\u679C\u5F53\u524D\u5B57\u7B26\u8FD8\u6CA1\u6709\u5B50\u8282\u70B9\uFF0C\u8BF4\u660E\u524D\u7F00\u6811\u4E2D\u6CA1\u6709\u8BE5\u5B57\u7B26\uFF0C\u9700\u8981\u521D\u59CB\u5316\uFF0C</span>
            <span class="token comment">// \u5426\u5219\u6CBF\u7740\u5B50\u8282\u70B9\u7EE7\u7EED\u6DFB\u52A0\u4E0B\u4E00\u4E2A\u5B57\u7B26</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>subNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u521D\u59CB\u5316\u5B50\u8282\u70B9\uFF0C\u63A5\u5230\u5F53\u524D\u8282\u70B9\u4E0A</span>
                subNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TrieNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                curNode<span class="token punctuation">.</span><span class="token function">addSubNode</span><span class="token punctuation">(</span>c<span class="token punctuation">,</span> subNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// \u6307\u5411\u5B50\u8282\u70B9\uFF0C\u8FDB\u5165\u4E0B\u4E00\u8F6E\u5FAA\u73AF</span>
            curNode <span class="token operator">=</span> subNode<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u8BBE\u7F6E\u7ED3\u675F\u6807\u8BC6</span>
        curNode<span class="token punctuation">.</span><span class="token function">setKeyWordEnd</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u9879\u76EE\u542F\u52A8\u7684\u65F6\u5019\uFF0C\u9700\u8981\u6839\u636E\u654F\u611F\u8BCD\u6587\u4EF6\u4E2D\u7684\u654F\u611F\u8BCD\u6765\u521D\u59CB\u5316\u524D\u7F00\u6811\uFF0C\u5229\u7528 Spring \u7684 @PostConstruct \u6CE8\u89E3\uFF0C\u5728 Bean \u88AB\u5B9E\u4F8B\u5316\uFF0C\u8C03\u7528\u6784\u9020\u5668\u4E4B\u540E\uFF0C\u5C31\u521D\u59CB\u5316\u524D\u7F00\u6811\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">// \u5728 bean \u88AB\u5B9E\u4F8B\u5316\uFF0C\u8C03\u7528\u6784\u9020\u5668\u4E4B\u540E\uFF0C@PostConstruct \u6807\u6CE8\u7684\u65B9\u6CD5\u5C31\u4F1A\u88AB\u81EA\u52A8\u8C03\u7528</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token comment">// \u521D\u59CB\u5316\u524D\u7F00\u6811</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">(</span>
                <span class="token comment">// \u4ECE\u7C7B\u52A0\u8F7D\u5668\u4E2D\u83B7\u53D6\u52A0\u8F7D\u597D\u7684\u8D44\u6E90\uFF08\u654F\u611F\u8BCD\u6587\u4EF6\uFF09\uFF0C\u7136\u540E\u5C06\u5B57\u7B26\u6D41\u8F6C\u4E3A\u7F13\u51B2\u6D41\u8BFB\u53D6\u8BE5\u6587\u4EF6</span>
                <span class="token class-name">InputStream</span> is <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getResourceAsStream</span><span class="token punctuation">(</span><span class="token string">&quot;sensitive-words.txt&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">BufferedReader</span> reader <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferedReader</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">InputStreamReader</span><span class="token punctuation">(</span>is<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> keyword<span class="token punctuation">;</span>
            <span class="token comment">// \u4E00\u884C\u4E00\u884C\u7684\u8BFB\u53D6</span>
            <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>keyword <span class="token operator">=</span> reader<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u6DFB\u52A0\u5230\u524D\u7F00\u6811</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">addKeyword</span><span class="token punctuation">(</span>keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u4E0B\u6765\u5C31\u53EA\u5269\u4E0B\u8FC7\u6EE4\u7684\u6838\u5FC3\u65B9\u6CD5\u4E86\uFF0C\u8FD9\u4E2A\u65B9\u6CD5\u9700\u8981\u5728\u4E1A\u52A1\u4E2D\u4F7F\u7528\uFF0C\u5177\u4F53\u5B9E\u73B0\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * \u8FC7\u6EE4\u654F\u611F\u8BCD\uFF08\u4F9B\u5916\u754C\u8C03\u7528\uFF09
     * <span class="token keyword">@param</span> <span class="token parameter">text</span> \u5F85\u8FC7\u6EE4\u7684\u6587\u672C
     * <span class="token keyword">@return</span> \u8FC7\u6EE4\u540E\u7684\u6587\u672C
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">String</span> text<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">StringBuilder</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6307\u94881\uFF1A\u7528\u4E8E\u904D\u5386\u524D\u7F00\u6811</span>
        <span class="token class-name">TrieNode</span> curNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
        <span class="token comment">// \u6307\u94882\uFF1A\u904D\u5386\u6587\u672C\u7684\u5DE6\u8FB9\u754C</span>
        <span class="token keyword">int</span> begin <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6307\u94883\uFF1A\u904D\u5386\u6587\u672C\u7684\u53F3\u8FB9\u754C\uFF08\u6307\u94882\uFF0C3 \u5F62\u6210\u7684\u533A\u95F4\u7684\u6587\u672C\u53EF\u80FD\u662F\u654F\u611F\u8BCD\uFF09</span>
        <span class="token keyword">int</span> pos <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">// \u8FC7\u6EE4\u7B97\u6CD5\uFF1A\u904D\u5386\u6587\u672C\u7684\u8FC7\u7A0B\u4E2D\uFF0C\u540C\u65F6\u904D\u5386\u6574\u9897\u524D\u7F00\u6811\uFF0C\u627E\u51FA\u7B26\u5408\u7684\u6587\u672C</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>pos <span class="token operator">&lt;</span> text<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">char</span> c <span class="token operator">=</span> text<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>pos<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u8DF3\u8FC7\u7B26\u53F7\uFF08\u201C\u806A\u660E\u201D\u7684\u7F51\u53CB\uFF1A\u8DDF\u6211\u6765%\u8D4C$\u535A%\uFF09</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSymbol</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u82E5\u6307\u94881 \u5904\u4E8E\u6839\u8282\u70B9\uFF0C\u5C06\u6B64\u7B26\u53F7\u8BA1\u5165\u7ED3\u679C\uFF0C\u8BA9\u6307\u94882 \u5411\u4E0B\u8D70</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode <span class="token operator">==</span> rootNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    begin<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// \u65E0\u8BBA\u7B26\u53F7\u5728\u5F00\u5934\u8FD8\u662F\u4E2D\u95F4\uFF0C\u6307\u94883 \u90FD\u5411\u4E0B\u8D70</span>
                pos<span class="token operator">++</span><span class="token punctuation">;</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// \u68C0\u67E5\u4E0B\u7EA7\u8282\u70B9</span>
            curNode <span class="token operator">=</span> curNode<span class="token punctuation">.</span><span class="token function">getSubNode</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u4E0B\u7EA7\u8282\u70B9\u4E3A\u7A7A\uFF0C\u8868\u793A\u4EE5 begin \u5F00\u5934\u7684\u5B57\u7B26\u4E0D\u662F\u654F\u611F\u8BCD</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u8FDB\u5165\u4E0B\u4E00\u4E2A\u4F4D\u7F6E</span>
                pos <span class="token operator">=</span> <span class="token operator">++</span>begin<span class="token punctuation">;</span>
                <span class="token comment">// \u91CD\u65B0\u6307\u5411\u6839\u8282\u70B9\uFF0C\u5F00\u59CB\u4E0B\u4E00\u4E2A\u5B57\u7B26\u7684\u5224\u65AD</span>
                curNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>curNode<span class="token punctuation">.</span>isKeyWordEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u53D1\u73B0\u654F\u611F\u8BCD\uFF0C\u66FF\u6362</span>
                sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>REPLACEMENT<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// \u8FDB\u5165\u4E0B\u4E00\u4E2A\u4F4D\u7F6E</span>
                begin <span class="token operator">=</span> <span class="token operator">++</span>pos<span class="token punctuation">;</span>
                <span class="token comment">// \u91CD\u65B0\u6307\u5411\u6839\u8282\u70B9</span>
                curNode <span class="token operator">=</span> rootNode<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// \u68C0\u67E5\u4E0B\u4E00\u4E2A\u5B57\u7B26</span>
                pos<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// \u7531\u4E8E\u5FAA\u73AF\u662F\u4EE5\u6307\u94883 pos\uFF08\u53F3\u533A\u95F4\uFF09\u4E3A\u7ED3\u675F\u6761\u4EF6\uFF0C\u6240\u4EE5\u6700\u540E\u53EF\u80FD\u8FD8\u6709\u533A\u95F4\u6CA1\u88AB\u52A0\u5165\u8FDB\u7ED3\u679C\u4E2D</span>
        sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>begin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u5224\u65AD\u662F\u5426\u4E3A\u7B26\u53F7</span>
    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isSymbol</span><span class="token punctuation">(</span><span class="token class-name">Character</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// isAsciiAlphanumeric() \u5224\u65AD\u662F\u5426\u4E3A\u6570\u5B57\u6216\u5E0C\u814A\u5B57\u6BCD | 0x2E80-0x9FFF \u4E4B\u95F4\u7684\u5B57\u7B26\u662F\u4E1C\u4E9A\u6587\u5B57</span>
        <span class="token keyword">return</span> <span class="token operator">!</span><span class="token class-name">CharUtils</span><span class="token punctuation">.</span><span class="token function">isAsciiAlphanumeric</span><span class="token punctuation">(</span>c<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>c <span class="token operator">&lt;</span> <span class="token number">0x2E80</span> <span class="token operator">||</span> c <span class="token operator">&gt;</span> <span class="token number">0x9FFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-6-\u7EDF\u4E00\u5F02\u5E38\u5904\u7406" tabindex="-1"><a class="header-anchor" href="#_2-6-\u7EDF\u4E00\u5F02\u5E38\u5904\u7406" aria-hidden="true">#</a> 2.6 \u7EDF\u4E00\u5F02\u5E38\u5904\u7406</h3><p>SpringBoot \u5BF9\u4E8E\u5F02\u5E38\u7684\u5904\u7406\u4E5F\u505A\u4E86\u4E0D\u9519\u7684\u652F\u6301\uFF0C\u5B83\u63D0\u4F9B\u4E86 2 \u4E2A\u6CE8\u89E3\uFF1A</p><ul><li><strong>@ControllerAdvice</strong>\uFF1A\u7528\u6765 <strong>\u5F00\u542F\u5168\u5C40\u7684\u5F02\u5E38\u6355\u83B7</strong>\uFF0C\u8BF4\u660E\u8981\u5728\u54EA\u4E9B\u5730\u65B9\u6355\u83B7\uFF1B</li><li><strong>@ExceptionHandler</strong>\uFF1A\u8BF4\u660E <strong>\u6355\u83B7\u54EA\u4E9B\u5F02\u5E38</strong>\uFF0C\u5BF9\u90A3\u4E9B\u5F02\u5E38\u8FDB\u884C\u5904\u7406\uFF1B</li></ul><p>\u7EDF\u4E00\u5F02\u5E38\u5904\u7406\u5229\u7528\u4E86 AOP \u7684\u601D\u60F3\uFF0C\u5728\u6CA1\u6709\u6539\u53D8\u539F\u6709\u4EE3\u7801\u7684\u60C5\u51B5\u4E0B\u5B9E\u73B0\u4E86\u5F02\u5E38\u5904\u7406\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: @ControllerAdvice\u4F5C\u7528\uFF1A\u7ED9 Controller \u63A7\u5236\u5668\u6DFB\u52A0\u7EDF\u4E00\u7684\u64CD\u4F5C\u6216\u5904\u7406\u3002
 * \u5BF9\u52A0\u4E86 @Controller \u6CE8\u89E3\u7684\u63A7\u5236\u5668\u6DFB\u52A0\u7EDF\u4E00\u7684\u5F02\u5E38\u5904\u7406\uFF08AOP\u5B9E\u73B0\uFF09
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/15
 */</span>
<span class="token annotation punctuation">@ControllerAdvice</span><span class="token punctuation">(</span>annotations <span class="token operator">=</span> <span class="token class-name">Controller</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AllExceptionHandler</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">AllExceptionHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// \u8FDB\u884C\u5F02\u5E38\u5904\u7406\uFF0C\u5904\u7406 Exception.class \u7684\u5F02\u5E38(\u5168\u90E8\u5F02\u5E38)</span>
    <span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlerException</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">,</span> <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u670D\u52A1\u5668\u53D1\u751F\u5F02\u5E38\uFF1A&quot;</span> <span class="token operator">+</span> e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">StackTraceElement</span> element <span class="token operator">:</span> e<span class="token punctuation">.</span><span class="token function">getStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>element<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> xRequestWith <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;x-requested-with&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5224\u65AD\u662F\u5F02\u6B65\u8FD8\u662F\u666E\u901A\u8BF7\u6C42\uFF0C\u5F02\u6B65\u8BF7\u6C42\u9700\u8981\u8FD4\u56DE JSON \u5B57\u7B26\u4E32\uFF0C\u666E\u901A\u8BF7\u6C42\u8FD4\u56DE\u9519\u8BEF\u9875\u9762</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;XMLHttpRequest&quot;</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>xRequestWith<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/plain;charset=utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">PrintWriter</span> writer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">JSONUtil</span><span class="token punctuation">.</span><span class="token function">getJSONString</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;\u670D\u52A1\u5668\u5F02\u5E38\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getContextPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;/error&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="_2-7-\u7EDF\u4E00\u65E5\u5FD7\u7BA1\u7406" tabindex="-1"><a class="header-anchor" href="#_2-7-\u7EDF\u4E00\u65E5\u5FD7\u7BA1\u7406" aria-hidden="true">#</a> 2.7 \u7EDF\u4E00\u65E5\u5FD7\u7BA1\u7406</h3><p>Spring \u5BF9\u7EDF\u4E00\u65E5\u5FD7\u7BA1\u7406\u505A\u4E86\u96C6\u5408\uFF0C\u4F7F\u7528\u7684\u662F logback\uFF0C\u53EA\u9700\u8981\u5728 resource \u4E0B\u521B\u5EFA <code>logback-spring.xml</code> \u914D\u7F6E\u6587\u4EF6\u914D\u7F6E\u65E5\u5FD7\u7684\u8BB0\u5F55\u683C\u5F0F\uFF0C\u65E5\u5FD7\u7C7B\u578B\u7B49\u7B49\uFF0C\u5C31\u53EF\u4EE5\u76F4\u63A5\u5728\u9879\u76EE\u4E2D\u4F7F\u7528\u3002</p><p>\u800C\u6211\u4EEC\u73B0\u5728\u81EA\u5DF1\u5B9A\u4E49\u4E00\u4E2A\u65E5\u5FD7\uFF0C\u6765\u8BB0\u5F55\u6BCF\u4E2A\u7528\u6237\u5728\u4EC0\u4E48\u65F6\u95F4\u70B9\u8BBF\u95EE\u4E86\u4E1A\u52A1\u5C42\u7684\u4EC0\u4E48\u65B9\u6CD5\u3002</p><p>Spring \u63D0\u4F9B\u4E86\u6BD4\u8F83\u65B9\u4FBF\u7684\u65B9\u5F0F\uFF0C\u4E0D\u7528\u52A8\u539F\u672C\u7684\u4E1A\u52A1\u5C42\u4EE3\u7801\uFF0C\u4E5F\u662F\u4F7F\u7528 AOP \u601D\u60F3\uFF0C\u5C06\u5207\u70B9\u5B9A\u4E49\u4E3A\u9700\u8981\u8BB0\u5F55\u65E5\u5FD7\u7684\u5730\u65B9\u5373\u53EF\u5B9E\u73B0\u3002</p><p>\u9996\u5148\u6765\u4E86\u89E3\u4E00\u4E0B AOP \u7684\u51E0\u4E2A\u6838\u5FC3\u6982\u5FF5\uFF1A</p><ul><li>\u901A\u77E5\uFF08Advice\uFF09\uFF1A\u5C31\u662F <strong>\u81EA\u5DF1\u60F3\u8981\u7684\u529F\u80FD</strong>\uFF0C\u6BD4\u5982\u6211\u4EEC\u8FD9\u91CC\u8981\u6253\u5370\u65E5\u5FD7\u3002</li><li>\u8FDE\u63A5\u70B9\uFF08JoinPoint\uFF09\uFF1A\u5C31\u662F <strong>\u4F7F\u7528\u901A\u77E5\u7684\u5730\u65B9</strong>\uFF0CSpring \u53EA\u652F\u6301\u65B9\u6CD5\u8FDE\u63A5\u70B9\uFF0C\u65B9\u6CD5\u6267\u884C\u524D/\u540E\u3001return \u4E4B\u540E\u3001\u629B\u51FA\u5F02\u5E38\u4E4B\u540E\u90FD\u662F\u8FDE\u63A5\u70B9\u3002</li><li>\u5207\u70B9\uFF08Pointcut\uFF09\uFF1A\u6709\u65F6\u5019\u6211\u4EEC\u4E0D\u5E0C\u671B\u5728\u6240\u6709\u7684\u65B9\u6CD5\u4E0A\u90FD\u4F7F\u7528 Advice\uFF0C\u800C Pointcut \u5C31\u662F\u63D0\u4F9B\u4E00\u7EC4\u89C4\u5219\u6765\u5339\u914D JoinPoint\uFF0C\u7ED9\u6EE1\u8DB3\u89C4\u5219\u7684 JoinPoint \u4F7F\u7528 Advice\u3002</li><li>\u5207\u9762\uFF08Aspect\uFF09\uFF1A\u901A\u77E5\u548C\u5207\u70B9\u7684\u7ED3\u5408\u3002\u5176\u5B9E\u8FDE\u63A5\u70B9\u5C31\u662F\u4E3A\u4E86\u65B9\u4FBF\u7406\u89E3\u5207\u70B9\u800C\u5B9A\u4E49\u51FA\u6765\u7684\u3002\u901A\u77E5\u8BF4\u660E\u4E86\u5E72\u4EC0\u4E48\u548C\u4EC0\u4E48\u65F6\u5019\u5E72\uFF08\u4EC0\u4E48\u65F6\u5019\u5E72\u5728\u5B9A\u4E49\u901A\u77E5\u7684\u65F6\u5019\u53EF\u4EE5\u6307\u5B9A\uFF09\uFF0C\u800C\u5207\u5165\u70B9\u8BF4\u660E\u4E86\u5728\u54EA\u5E72\uFF08\u6307\u5B9A\u5230\u5E95\u662F\u54EA\u4E2A\u65B9\u6CD5\uFF09\uFF0C\u8FD9\u5C31\u662F\u4E00\u4E2A\u5B8C\u6574\u7684\u5207\u9762\u5B9A\u4E49\u3002</li><li>\u7EC7\u5165\uFF08Weaving\uFF09\uFF1A\u628A\u5207\u9762\u5E94\u7528\u5230\u76EE\u6807\u5BF9\u8C61\u6765\u521B\u5EFA\u65B0\u7684\u4EE3\u7406\u5BF9\u8C61\u7684\u8FC7\u7A0B\uFF0CSpring \u4E2D\u7528\u7684\u662F\u8FD0\u884C\u65F6\u3002</li></ul><p>\u901A\u77E5\u6709\u4EE5\u4E0B\u51E0\u79CD\u7C7B\u578B\uFF1A</p><ul><li>@Before(&quot;pointcur()&quot;)\uFF1A\u5728\u6267\u884C\u5207\u70B9\u4E4B\u524D\u9700\u8981\u505A\u7684\u901A\u77E5\uFF1B</li><li>@After(&quot;pointcur()&quot;)\uFF1A\u5728\u6267\u884C\u5207\u70B9\u4E4B\u540E\u9700\u8981\u505A\u7684\u901A\u77E5\uFF1B</li><li>@AfterReturning(&quot;pointcur()&quot;)\uFF1A\u5728\u8FD4\u56DE\u503C\u4E4B\u540E\u9700\u8981\u505A\u7684\u901A\u77E5\uFF1B</li><li>@AfterThrowing(&quot;pointcur()&quot;)\uFF1A\u5728\u629B\u51FA\u5F02\u5E38\u540E\u9700\u8981\u505A\u7684\u901A\u77E5\uFF1B</li><li>@Around(&quot;pointcur()&quot;)\uFF1A\u73AF\u7ED5\u901A\u77E5\uFF0C\u53EF\u5728\u5207\u70B9\u524D\u540E\u505A\u901A\u77E5\uFF0C</li></ul><p>\u5B9A\u4E49\u65B9\u6CD5\u65F6\u53C2\u6570\u53EF\u4EE5\u4F20\u5165 JoinPoint\uFF0C\u7528\u6765\u6267\u884C\u88AB\u901A\u77E5\u7684\u65B9\u6CD5\uFF08<code>joinPoint.process()</code>\uFF09\u6216\u8005\u83B7\u53D6\u88AB\u6267\u884C\u7684\u65B9\u6CD5\uFF08<code>joinPoint.getSignature().getName()</code>\uFF09\u3002</p><p>\u6839\u636E\u6211\u4EEC\u7684\u4E1A\u52A1\u9700\u6C42\uFF0C\u5728 service \u5C42\u65B9\u6CD5\u6267\u884C\u524D\uFF0C\u8BB0\u5F55\u4E0B\u8BBF\u95EE\u8BB0\u5F55\u5373\u53EF\uFF0C\u6240\u4EE5\u5207\u70B9\u5B9A\u4E49\u7684\u89C4\u5219\u5B9A\u4E49\u4E3A <code>service.Impl</code> \u5305\u4E0B\u7684\u6240\u6709\u65B9\u6CD5\u90FD\u8981\u4F7F\u7528\u901A\u77E5\u3002\u5177\u4F53\u7684\u901A\u77E5\u5185\u5BB9\u5728\u6267\u884C\u5207\u70B9\u4E4B\u524D\u505A\uFF0C\u6240\u4EE5\u4F7F\u7528 @Before\u3002</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: \u5229\u7528 AOP\uFF0C\u8BB0\u5F55\u7528\u6237\u8BBF\u95EE\u4E1A\u52A1\u65B9\u6CD5\u7684\u65E5\u5FD7
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/15
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Aspect</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ServiceLogAspect</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">ServiceLogAspect</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// \u5207\u70B9\uFF0C\u8BA9 service.impl \u5305\u4E0B\u7684\u6240\u6709\u65B9\u6CD5\u6267\u884C\u901A\u77E5\uFF0Cexecution \u683C\u5F0F\uFF1A\u8FD4\u56DE\u503C \u5305\u4E0B\u7684\u65B9\u6CD5(\u53C2\u6570)</span>
    <span class="token annotation punctuation">@Pointcut</span><span class="token punctuation">(</span><span class="token string">&quot;execution(* com.run.nowcoder.service.impl.*.*(..))&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">pointcut</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u5728\u6267\u884C\u5207\u70B9\u4E4B\u524D\u9700\u8981\u505A\u7684\u901A\u77E5</span>
    <span class="token annotation punctuation">@Before</span><span class="token punctuation">(</span><span class="token string">&quot;pointcut()&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">JoinPoint</span> joinPoint<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u7528\u6237[ip]\uFF0C\u5728[now_time]\uFF0C\u8BBF\u95EE\u4E86[com.run.nowcoder.service.impl.xxx()]</span>
        <span class="token comment">// \u5229\u7528 RequestContextHolder \u5DE5\u5177\u7684 getRequestAttributes() \u65B9\u6CD5\u83B7\u53D6\u8BF7\u6C42\u4E0A\u4E0B\u6587</span>
        <span class="token class-name">ServletRequestAttributes</span> attributes <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">ServletRequestAttributes</span><span class="token punctuation">)</span> <span class="token class-name">RequestContextHolder</span><span class="token punctuation">.</span><span class="token function">getRequestAttributes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6839\u636E\u8BF7\u6C42\u4E0A\u4E0B\u6587\u83B7\u53D6 request</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>attributes <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token class-name">HttpServletRequest</span> request <span class="token operator">=</span> attributes<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u6839\u636E request \u83B7\u53D6 ip \u5730\u5740</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> now <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u65B9\u6CD5\u7C7B\u578B\u540D + \u65B9\u6CD5\u540D</span>
        <span class="token class-name">String</span> target <span class="token operator">=</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaringTypeName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> joinPoint<span class="token punctuation">.</span><span class="token function">getSignature</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">&quot;\u7528\u6237[%s]\uFF0C\u5728[%s]\uFF0C\u8BBF\u95EE\u4E86[%s]&quot;</span><span class="token punctuation">,</span> ip<span class="token punctuation">,</span> now<span class="token punctuation">,</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_3-redis-\u76F8\u5173" tabindex="-1"><a class="header-anchor" href="#_3-redis-\u76F8\u5173" aria-hidden="true">#</a> 3. Redis \u76F8\u5173</h2><h3 id="_3-1-\u70B9\u8D5E-\u91CD\u70B9" tabindex="-1"><a class="header-anchor" href="#_3-1-\u70B9\u8D5E-\u91CD\u70B9" aria-hidden="true">#</a> 3.1 \u70B9\u8D5E\uFF08\u91CD\u70B9\uFF09</h3><p>\u70B9\u8D5E\u4E1A\u52A1\u672C\u8EAB\u5E76\u4E0D\u590D\u6742\uFF0C\u65E0\u975E\u662F\u5BF9\u6570\u636E\u7684 update\uFF0C\u4F46\u662F\u70B9\u8D5E\u672C\u8EAB\u662F\u65E0\u610F\u8BC6\u884C\u4E3A\uFF0C\u5E76\u4E14\u540C\u4E00\u4E2A\u7528\u6237\u53EF\u5BF9\u535A\u6587\u8FDB\u884C\u70B9\u8D5E/\u53D6\u6D88\u70B9\u8D5E\uFF0C\u5982\u679C\u76F4\u63A5\u64CD\u4F5C\u6570\u636E\u5E93\uFF0C\u65E0\u7591\u4F1A\u589E\u52A0\u6570\u636E\u5E93 io \u64CD\u4F5C\u3002</p><p>\u6240\u4EE5\u8FD9\u91CC\u4F7F\u7528 Redis \u6765\u5B58\u50A8\u70B9\u8D5E\u6570\u636E\u3002</p><p>\u5BF9\u4E8E\u6570\u636E\u7C7B\u578B\u7684\u9009\u7528\uFF1A</p><ul><li>\u7531\u4E8E\u6211\u4EEC\u9700\u8981\u5FEB\u901F\u5224\u65AD\u8BE5\u7528\u6237\u662F\u5426\u5BF9\u5E16\u5B50/\u8BC4\u8BBA\u70B9\u8FC7\u8D5E\uFF0C\u6240\u4EE5\u9700\u8981\u5224\u65AD\u67D0\u4E2A\u5143\u7D20\u662F\u5426\u5728\u96C6\u5408\u4E2D\uFF0C\u56E0\u6B64\u4F7F\u7528 Set\uFF0C\u5B83\u63D0\u4F9B\u4E86\u4E00\u4E2A <code>SISMEMBER</code> \u547D\u4EE4\u6765\u5224\u65AD\u5143\u7D20\u662F\u5426\u5728\u96C6\u5408\u4E2D\uFF1B</li></ul><p>\u5BF9\u4E8E key \u7684\u8BBE\u8BA1\uFF1A</p><ul><li>\u6211\u4EEC\u73B0\u5728\u6709\u5BF9\u5E16\u5B50\u7684\u70B9\u8D5E\u548C\u5BF9\u8BC4\u8BBA\u7684\u70B9\u8D5E\uFF0C\u6216\u8BB8\u540E\u9762\u8FD8\u4F1A\u5F00\u653E\u5BF9\u5176\u4ED6\u5B9E\u4F53\u7684\u70B9\u8D5E\u3002\u6240\u4EE5\u6211\u4EEC\u8981\u8BBE\u7F6E\u4E00\u4E2A\u5B9E\u4F53\u7C7B\u578B entityType\uFF0C\u6765\u533A\u5206\u70B9\u8D5E\u7684\u7C7B\u578B\uFF1B</li><li>\u7136\u540E\u5728\u5B9E\u4F53\u7C7B\u578B\u540E\u9762\u8DDF\u4E0A\u8BE5\u5B9E\u4F53\u7684 id \u5373\u53EF\uFF08postId / commentId\uFF09\uFF1B</li><li>\u6240\u4EE5\u70B9\u8D5E\u529F\u80FD\u7684 key \u4E3A like:entity:entityType:entityId\uFF1B</li><li>value \u4E3A\u7ED9\u8BE5\u5B9E\u4F53\u70B9\u8D5E\u7684\u7528\u6237 id</li></ul><p>\u7531\u4E8E\u6211\u4EEC\u8FD8\u8981\u7EDF\u8BA1\u6BCF\u4E2A\u7528\u6237\u83B7\u5F97\u7684\u603B\u8D5E\u6570\uFF0C\u6240\u4EE5\u5728\u8BB0\u5F55\u70B9\u8D5E\u65F6\u4E5F\u8981\u987A\u4FBF\u628A\u7528\u6237\u7684\u603B\u8D5E\u6570 +1\u3002</p><p>\u6BCF\u4E2A\u7528\u6237\u7684\u603B\u8D5E\u6570\u7528 String \u6570\u636E\u7C7B\u578B\u6765\u50A8\u5B58\uFF0Ckey \u4E3A like:user:userId\uFF0Cvalue \u4E3A\u83B7\u5F97\u7684\u8D5E\u603B\u6570\u3002</p><p>\u56E0\u4E3A\u70B9\u8D5E\u548C\u7EDF\u8BA1\u7528\u6237\u8D5E\u7684\u603B\u6570\u662F\u4E00\u7EC4\u4E0D\u53EF\u5206\u5272\u7684\u884C\u4E3A\uFF0C\u6240\u4EE5\u9700\u8981\u4FDD\u8BC1\u539F\u5B50\u6027\uFF0C\u56E0\u6B64\u4F7F\u7528\u4E8B\u52A1\u6765\u6267\u884C\u8FD9\u4E24\u6761\u547D\u4EE4\u3002</p><p>\u81F3\u4E8E\u8FD9\u4E2A\u70B9\u8D5E\u64CD\u4F5C\u7684\u5B9E\u4F53\u7C7B\u578B\uFF0C\u4EE5\u53CA\u5B9E\u4F53 id \u548C \u88AB\u70B9\u8D5E\u4EBA\u7684 id\uFF0C\u90FD\u662F\u4ECE\u524D\u7AEF\u4F20\u8FC7\u6765\uFF0C\u800C\u5BF9\u4E8E\u70B9\u8D5E\u8005\u53EF\u4EE5\u901A\u8FC7 ThreadLocal \u6765\u83B7\u53D6\u3002</p><h3 id="_3-2-\u5173\u6CE8-\u91CD\u70B9" tabindex="-1"><a class="header-anchor" href="#_3-2-\u5173\u6CE8-\u91CD\u70B9" aria-hidden="true">#</a> 3.2 \u5173\u6CE8\uFF08\u91CD\u70B9\uFF09</h3><p>\u5173\u6CE8\u548C\u70B9\u8D5E\u975E\u5E38\u7C7B\u4F3C\uFF0C\u5173\u6CE8\u64CD\u4F5C\u9700\u8981\u66F4\u65B0\u5173\u6CE8\u8005\u7684\u5173\u6CE8\u4FE1\u606F\uFF0C\u8FD8\u8981\u66F4\u65B0\u88AB\u5173\u6CE8\u8005\u7684\u5173\u6CE8\u4FE1\u606F\uFF0C\u6240\u4EE5\u4E5F\u9700\u8981\u5728\u4E8B\u52A1\u4E2D\u64CD\u4F5C\u3002</p><p>\u5BF9\u4E8E\u5173\u6CE8\u64CD\u4F5C\uFF0C\u6211\u4EEC\u4F7F\u7528 zSet \u6765\u5B58\u50A8\uFF1A</p><ul><li>\u56E0\u4E3A\u5728\u663E\u793A\u5173\u6CE8\u5217\u8868\u548C\u7C89\u4E1D\u5217\u8868\u65F6\uFF0C\u4E00\u822C\u90FD\u662F\u6309\u7167\u65F6\u95F4\u964D\u5E8F\u663E\u793A\u7684\uFF1B</li><li>\u800C\u4E14\u65B9\u4FBF\u540E\u7EED\u6DFB\u52A0\u5171\u540C\u5173\u6CE8\u7684\u529F\u80FD\uFF0CzSet \u4E5F\u652F\u6301\u53D6\u4EA4\u96C6\uFF1B</li></ul><p>\u67D0\u4E2A\u7528\u6237\u5173\u6CE8\u7684\u5B9E\u4F53\uFF0Ckey \u7684\u8BBE\u8BA1\uFF1A</p><ul><li>\u9664\u4E86\u5173\u6CE8\u7528\u6237\u5916\uFF0C\u4EE5\u540E\u8FD8\u6709\u53EF\u80FD\u5173\u6CE8\u67D0\u4E2A\u9891\u9053\u3001\u5173\u6CE8\u67D0\u4E2A\u6807\u7B7E\u7B49\u7B49\u529F\u80FD\uFF0C\u6240\u4EE5\u6211\u4EEC\u8FD9\u91CC\u4E0D\u80FD\u628A key \u8BBE\u8BA1\u6B7B\uFF0C\u4E5F\u9700\u8981\u6839\u636E\u7C7B\u578B\u6765\u8BBE\u8BA1\uFF1B</li><li>\u6240\u4EE5 key \u4E3A\u67D0\u4E2A\u7528\u6237\u6240\u5173\u6CE8\u7684\u5B9E\u4F53\uFF1A<code>followee:useId:entityType</code>\uFF1Bvalue \u4E3A\u8FD9\u4E2A\u5B9E\u4F53\u6240\u5BF9\u5E94\u7684 id\uFF0C\u548C\u5173\u6CE8\u7684\u65F6\u95F4\uFF1A<code>zSet(entityId, nowTime)</code>\uFF1B</li></ul><p>\u67D0\u4E2A\u5B9E\u4F53\u6240\u62E5\u6709\u7684\u7C89\u4E1D\uFF0Ckey \u7684\u8BBE\u8BA1\uFF1A</p><ul><li><p>\u540C\u4E0A\u9762\u7C7B\u4F3C\uFF0Ckey \u4E3A\u67D0\u4E2A\u5B9E\u4F53\uFF08\u5B9E\u4F53\u7C7B\u578B\u548C\u5B9E\u4F53 id \u552F\u4E00\u786E\u5B9A\u4E00\u4E2A\u5B9E\u4F53\uFF09\uFF0Cvalue \u4E3A\u8BE5\u5B9E\u4F53\u7684\u7C89\u4E1D\u96C6\u5408\uFF08\u7C89\u4E1D\u5176\u5B9E\u5C31\u662F\u7528\u6237\uFF09\uFF1B</p></li><li><p>\u6240\u4EE5\uFF0Ckey\uFF1A<code>follower:entityType:entityId</code>\uFF1Bvalue\uFF1A<code>zSet(userId, nowTime)</code>\uFF1B</p></li></ul><h3 id="_3-3-\u9875\u9762\u4F18\u5316" tabindex="-1"><a class="header-anchor" href="#_3-3-\u9875\u9762\u4F18\u5316" aria-hidden="true">#</a> 3.3 \u9875\u9762\u4F18\u5316</h3><p>\u6211\u4EEC\u6709\u4E00\u4E9B\u8BBF\u95EE\u6570\u636E\u5E93\u7684\u64CD\u4F5C\u662F\u975E\u5E38\u9891\u7E41\u7684\uFF0C\u4F8B\u5982\u5728\u8FDB\u5165\u9996\u9875\u7684\u65F6\u5019\u5C31\u8981\u67E5\u8BE2\u4E00\u6574\u9875\u7684\u5E16\u5B50\u4FE1\u606F\uFF0C\u5E16\u5B50\u786E\u5B9E\u53EF\u4EE5\u4E00\u6B21\u6027\u67E5\u51FA\u4E00\u9875\u7684\u6570\u636E\u6765\uFF0C\u4F46\u662F\u6BCF\u4E2A\u5E16\u5B50\u5BF9\u5E94\u7684\u4F5C\u8005\u5219\u9700\u8981\u67E5\u8BE2\u591A\u6B21\uFF0C\u6709\u591A\u5C11\u4E2A\u5E16\u5B50\u5C31\u8981\u67E5\u8BE2\u591A\u5C11\u6B21\uFF0C\u8FD9\u6837\u9891\u7E41\u7684\u8BBF\u95EE\u6570\u636E\u5E93\u6548\u7387\u662F\u6BD4\u8F83\u4F4E\u7684\uFF0C\u6240\u4EE5\u6211\u4EEC\u8003\u8651\u7528 Redis \u6765\u505A\u7F13\u5B58\u3002</p><p>\u67E5\u8BE2\u7528\u6237\u65F6\uFF0C\u6839\u636E\u4E0B\u9762\u4E09\u6B65\u8D70\uFF1A</p><ol><li>\u5F53\u67E5\u8BE2\u65F6\uFF0C\u4F18\u5148\u4ECE\u7F13\u5B58\u4E2D\u53D6\u503C\uFF1B</li><li>\u53D6\u4E0D\u5230\u65F6\u518D\u8D70\u6570\u636E\u5E93\uFF0C\u5C06\u67E5\u51FA\u7684\u6570\u636E\u5B58\u5165\u7F13\u5B58\u4E2D\u518D\u8FD4\u56DE\uFF1B</li><li>\u6570\u636E\u66F4\u65B0\u65F6\u8981\u53CA\u65F6\u6E05\u9664\u7F13\u5B58\u3002\u6CE8\u610F\uFF0C\u8FD9\u91CC\u4E0D\u662F\u91C7\u7528\u66F4\u65B0\u7F13\u5B58\uFF0C\u800C\u662F\u76F4\u63A5\u6E05\u9664\u3002\u56E0\u4E3A\u82E5\u66F4\u65B0\u6570\u636E\u5E93\u9891\u7E41\uFF0C\u800C\u7F13\u5B58\u7684\u6570\u636E\u4E0D\u4E00\u5B9A\u4F1A\u9891\u7E41\u4F7F\u7528\uFF0C\u6240\u4EE5\u5220\u9664\u6BD4\u66F4\u65B0\u5F00\u9500\u5C0F\u3002</li></ol><p>\u7F13\u5B58\u4EE3\u7801\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/*
    \u4F18\u5316\uFF1A\u4F7F\u7528 Redis \u7F13\u5B58\u767B\u5F55\u7684\u7528\u6237\uFF0C\u8FD9\u6837\u5728\u9875\u9762\u95F4\u8BBF\u95EE\u65F6\uFF0C\u53EF\u4EE5\u76F4\u63A5\u4ECE\u7F13\u5B58\u4E2D\u53D6\uFF0C\u800C\u4E0D\u7528\u6BCF\u6B21\u90FD\u8BBF\u95EE\u6570\u636E\u5E93\uFF0C
    \u7F13\u5B58\u53EA\u4FDD\u7559\u4E00\u5C0F\u65F6\uFF0C\u7528\u6237\u4E0B\u6B21\u8BF7\u6C42\u65F6\u82E5\u7F13\u5B58\u6CA1\u6709\u547D\u4E2D\uFF0C\u5219\u51B2\u6570\u636E\u5E93\u4E2D\u67E5\u51FA\u6570\u636E\uFF0C\u653E\u5165\u7F13\u5B58\u518D\u8FD4\u56DE\u3002
     */</span>
    <span class="token comment">// 1.\u5F53\u67E5\u8BE2\u65F6\uFF0C\u4F18\u5148\u4ECE\u7F13\u5B58\u4E2D\u53D6\u503C</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">getCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> userKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">User</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 2.\u53D6\u4E0D\u5230\u65F6\u521D\u59CB\u5316\u7F13\u5B58\u6570\u636E</span>
    <span class="token keyword">private</span> <span class="token class-name">User</span> <span class="token function">initCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5148\u4ECE\u6570\u636E\u5E93\u4E2D\u67E5\u8BE2\uFF0C\u5B58\u5165\u7F13\u5B58\u540E\u518D\u8FD4\u56DE</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">selectById</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> userKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>userKey<span class="token punctuation">,</span> user<span class="token punctuation">,</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 3.\u6570\u636E\u66F4\u53D8\u65F6\u6E05\u9664\u7F13\u5B58\uFF08\u4E0D\u66F4\u65B0\u7F13\u5B58\u662F\u56E0\u4E3A\u82E5\u66F4\u65B0\u6570\u636E\u5E93\u9891\u7E41\uFF0C\u800C\u7F13\u5B58\u7684\u6570\u636E\u4E0D\u4E00\u5B9A\u4F1A\u9891\u7E41\u4F7F\u7528\uFF0C\u6240\u4EE5\u5220\u9664\u6BD4\u66F4\u65B0\u5F00\u9500\u5C0F\uFF09</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">clearCache</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> userKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUserKey</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>userKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u9700\u8981\u67E5\u8BE2\u7528\u6237\u7684\u5730\u65B9\u4F18\u5148\u4F7F\u7528\u7F13\u5B58\u5373\u53EF\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">User</span> <span class="token function">findUserById</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//        return userMapper.selectById(id);</span>

        <span class="token comment">// \u4F18\u5316\uFF1A\u5148\u4ECE\u7F13\u5B58\u4E2D\u67E5\u8BE2\u7528\u6237\uFF0C\u67E5\u4E0D\u5230\u5219\u521D\u59CB\u5316\u7F13\u5B58</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token function">getCache</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> user <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">?</span> user <span class="token operator">:</span> <span class="token function">initCache</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u66F4\u65B0\u7528\u6237\u4FE1\u606F\u7684\u5730\u65B9\u8BB0\u5F97\u90FD\u8981\u8C03\u7528\u6E05\u9664\u7F13\u5B58\u7684\u65B9\u6CD5\u3002</p><h3 id="_3-4-redis-\u9AD8\u7EA7\u6570\u636E\u7C7B\u578B" tabindex="-1"><a class="header-anchor" href="#_3-4-redis-\u9AD8\u7EA7\u6570\u636E\u7C7B\u578B" aria-hidden="true">#</a> 3.4 Redis \u9AD8\u7EA7\u6570\u636E\u7C7B\u578B</h3><p>\u4E0B\u9762\u4ECB\u7ECD\u4E24\u79CD Redis \u9AD8\u7EA7\u6570\u636E\u7C7B\u578B\uFF0C\u7528\u4E8E\u7EDF\u8BA1\u7F51\u7AD9\u7684 UV(Unique Visitor) \u548C DAU(Daily Active User)\u3002</p><blockquote><p>HyperLogLog</p></blockquote><p>HyperLogLog \u662F\u7528\u6765\u505A\u57FA\u6570\u7EDF\u8BA1\u7684\uFF0C\u6240\u8C13\u57FA\u6570\u7EDF\u8BA1\uFF0C\u5C31\u662F\u6307\u4E00\u4E32\u6570\u5B57\u4E2D\u4E0D\u91CD\u590D\u7684\u6570\u5B57\u4E2A\u6570\uFF0C\u5982 {1\uFF0C2\uFF0C1\uFF0C2\uFF0C3} \u7684\u57FA\u6570\u96C6\u5C31\u662F {1\uFF0C2\uFF0C3}\uFF0C\u57FA\u6570\u5C31\u662F3\u3002</p><p>\u57FA\u672C\u64CD\u4F5C\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u6DFB\u52A0\u6570\u636E</span>
pfadd key element <span class="token punctuation">[</span>element <span class="token punctuation">..</span>.<span class="token punctuation">]</span> 

<span class="token comment"># \u7EDF\u8BA1\u6570\u636E</span>
pfcount key <span class="token punctuation">[</span>key <span class="token punctuation">..</span>.<span class="token punctuation">]</span>

<span class="token comment"># \u5408\u5E76\u6570\u636E</span>
pfmerge destkey sourcekey <span class="token punctuation">[</span>sourcekey<span class="token punctuation">..</span>.<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>HyperLogLog \u7279\u70B9\uFF1A</p><ul><li><p>\u7528\u4E8E\u8FDB\u884C\u57FA\u6570\u7EDF\u8BA1\uFF0C\u4E0D\u662F\u96C6\u5408\uFF0C\u4E0D\u4FDD\u5B58\u6570\u636E\uFF0C\u53EA\u8BB0\u5F55\u6570\u91CF\u800C\u4E0D\u662F\u5177\u4F53\u6570\u636E</p></li><li><p>\u6838\u5FC3\u662F\u57FA\u6570\u4F30\u7B97\u7B97\u6CD5\uFF0C\u6700\u7EC8\u6570\u503C\u5B58\u5728\u4E00\u5B9A\u8BEF\u5DEE</p></li><li><p>\u8BEF\u5DEE\u8303\u56F4\uFF1A\u57FA\u6570\u4F30\u8BA1\u7684\u7ED3\u679C\u662F\u4E00\u4E2A\u5E26\u6709 0.81% \u6807\u51C6\u9519\u8BEF\u7684\u8FD1\u4F3C\u503C</p></li><li><p>\u8017\u7A7A\u95F4\u6781\u5C0F\uFF0C\u6BCF\u4E2A hyperloglog key \u5360\u7528\u4E86 12K \u7684\u5185\u5B58\u7528\u4E8E\u6807\u8BB0\u57FA\u6570</p></li><li><p>pfadd \u547D\u4EE4\u4E0D\u662F\u4E00\u6B21\u6027\u5206\u914D 12K \u5185\u5B58\u4F7F\u7528\uFF0C\u4F1A\u968F\u7740\u57FA\u6570\u7684\u589E\u52A0\u5185\u5B58\u9010\u6E10\u589E\u5927</p></li><li><p>Pfmerge\u547D\u4EE4\u5408\u5E76\u540E\u5360\u7528\u7684\u5B58\u50A8\u7A7A\u95F4\u4E3A 12K\uFF0C\u65E0\u8BBA\u5408\u5E76\u4E4B\u524D\u6570\u636E\u91CF\u591A\u5C11</p></li></ul><p>\u4E1A\u52A1\u573A\u666F\uFF1A</p><ul><li>\u7EDF\u8BA1\u9875\u9762\u5B9E\u65F6 UV \u6570\u3001\u7EDF\u8BA1\u5728\u7EBF\u7528\u6237\u6570\u3001\u7EDF\u8BA1\u7528\u6237\u6BCF\u5929\u641C\u7D22\u4E0D\u540C\u8BCD\u6761\u7684\u4E2A\u6570\u3002</li><li>\u800C BitMaps\uFF08\u4E0B\u9762\u8BF4\uFF09\u5219\u7528\u4E8E\u5224\u65AD\u67D0\u4E2A\u7528\u6237\u662F\u5426\u8BBF\u95EE\u8FC7\u9875\u9762\u3002</li></ul><blockquote><p>BitMaps</p></blockquote><p>\u4ECB\u7ECD\uFF1A</p><ul><li>BitMaps \u5C31\u662F\u901A\u8FC7\u4E00\u4E2A bit \u4F4D\u6765\u8868\u793A\u67D0\u4E2A\u5143\u7D20\u5BF9\u5E94\u7684\u503C\u6216\u8005\u72B6\u6001\uFF0C\u5176\u4E2D\u7684 key \u5C31\u662F\u5BF9\u5E94\u5143\u7D20\u672C\u8EAB\uFF1B</li><li>\u53EF\u4EE5\u628A Bitmaps \u60F3\u8C61\u6210\u662F\u4E00\u4E32\u4E8C\u8FDB\u5236\u6570\u5B57\uFF0C\u6BCF\u4E2A\u4F4D\u7F6E\u53EA\u5B58\u50A8 0 \u6216 1\uFF08\u67D0\u79CD\u72B6\u6001\uFF09\uFF0C\u4E0B\u6807\u662F Bitmaps \u7684\u504F\u79FB\u91CF\uFF08offset\uFF09\uFF1B</li><li>\u56E0\u4E3A\u4E00\u4E2A\u5B57\u8282\u6709 8 \u4F4D\uFF0C\u6240\u4EE5 BitMaps \u672C\u8EAB\u4F1A\u6781\u5927\u7684\u8282\u7701\u5B58\u50A8\u7A7A\u95F4\uFF1B</li></ul><p>\u57FA\u672C\u64CD\u4F5C\uFF1A</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># \u83B7\u53D6\u6307\u5B9A key \u5BF9\u5E94\u504F\u79FB\u91CF\u4E0A\u7684 bit \u503C</span>
getbit key offset       <span class="token comment"># \u5982\u679C\u6CA1\u6709\u8BBE\u7F6E\u7684\u8BDD\uFF0C\u9ED8\u8BA4\u662F 0</span>

<span class="token comment"># \u8BBE\u7F6E\u6307\u5B9A key \u5BF9\u5E94\u504F\u79FB\u91CF\u4E0A\u7684 bit \u503C\uFF0Cvalue \u53EA\u80FD\u662F 0 \u6216 1</span>
setbit key offset value      <span class="token comment"># \u504F\u79FB\u91CF\u5F88\u5927\u7684\u8BDD\uFF0C\u4E5F\u80FD\u8BBE\u7F6E\uFF0C\u4F46\u662F\u524D\u9762\u8981\u8865 0\uFF0C\u6BD4\u8F83\u8017\u65F6</span>
 
<span class="token comment"># \u5BF9\u6307\u5B9A key \u6309\u4F4D\u8FDB\u884C\u4EA4\u3001\u5E76\u3001\u975E\u3001\u5F02\u6216\u64CD\u4F5C\uFF0C\u5E76\u5C06\u7ED3\u679C\u4FDD\u5B58\u5230 destKey \u4E2D</span>
bitop <span class="token function">op</span> destKey key1 <span class="token punctuation">[</span>key2<span class="token punctuation">..</span>.<span class="token punctuation">]</span>         <span class="token comment"># op\uFF1Aand\uFF08\u4EA4\uFF09\u3001or\uFF08\u5E76\uFF09\u3001not\uFF08\u975E\uFF09\u3001xor\uFF08\u5F02\u6216\uFF09</span>
  
<span class="token comment"># \u7EDF\u8BA1\u6307\u5B9A key \u4E2D 1 \u7684\u6570\u91CF</span>
bitcount key <span class="token punctuation">[</span>start end<span class="token punctuation">]</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E1A\u52A1\u573A\u666F\uFF1A</p><ul><li>\u7EDF\u8BA1\u7528\u6237\u5728\u6307\u5B9A\u8303\u56F4\u5185\u767B\u5F55\u8FC7\u591A\u5C11\u6B21\uFF1B</li><li>\u7EDF\u8BA1\u6307\u5B9A\u65E5\u671F\u8303\u56F4\u5185\u7684 DAU \u6570\u91CF\uFF1B</li><li>\u7EDF\u8BA1\u6BCF\u5929\u7F51\u7AD9\u7684 PV\uFF08Page Visitor\uFF09\uFF0C\u4E0D\u80FD\u7EDF\u8BA1 UV\uFF0C\u56E0\u4E3A UV \u8981\u53BB\u91CD\uFF1B</li></ul><blockquote><p>UV \u548C DAU \u7684\u5B9E\u73B0</p></blockquote><p>\u4F7F\u7528 Redis\uFF0C\u9996\u5148\u90FD\u8981\u8BBE\u8BA1\u597D key\uFF0C\u7531\u4E8E\u6211\u4EEC\u7684\u9700\u6C42\u662F\u65E2\u53EF\u4EE5\u5BF9\u5355\u65E5\u8FDB\u884C\u7EDF\u8BA1\uFF0C\u4E5F\u53EF\u4EE5\u5BF9\u67D0\u4E2A\u533A\u95F4\u8303\u56F4\u8FDB\u884C\u7EDF\u8BA1\uFF0C\u6240\u4EE5\u9700\u8981\u8BBE\u8BA1\u4E24\u79CD\u7C7B\u578B\u7684 key\u3002</p><p>\u5BF9\u4E8E UV\uFF0C\u91C7\u7528 HyperLogLog\uFF1A</p><ul><li>\u5355\u65E5 UV \u7684 key \u4E3A uv:date\uFF0Cvalue \u4E3A\u5F53\u5929\u8BBF\u95EE\u8FC7\u7F51\u7AD9\u7684 ip \u5730\u5740\u96C6\u5408\uFF1B</li><li>\u533A\u95F4 UV \u7684 key \u4E3A uv:startDate:endDate\uFF0Cvalue \u4E3A ip \u5730\u5740\u96C6\u5408\uFF1B\uFF08\u533A\u95F4 UV \u5176\u5B9E\u5C31\u662F\u628A\u8303\u56F4\u65E5\u671F\u5185\u7684\u5355\u65E5 UV \u8FDB\u884C\u5408\u5E76\uFF0C\u518D\u5B58\u5165\u533A\u95F4 UV \u4E2D\uFF09</li></ul><p>\u5BF9\u4E8E DUA\uFF0C\u91C7\u7528 BitMap\uFF1A</p><ul><li>\u5355\u65E5 DUA\u7684 key \u4E3A dua:date\uFF0Coffset \u4E3A userId\uFF0Cvalue \u4E3A 0|1\uFF1B</li><li>\u533A\u95F4 DUA\u7684 key \u4E3A dua:startDate:endDate\uFF0Coffset \u4E3A\u5728\u6307\u5B9A\u65E5\u671F\u8303\u56F4\u5185\uFF0C\u6D3B\u8DC3\u7528\u6237\u7684 userId\uFF0Cvalue \u4E3A 0|1\uFF1B\uFF08\u533A\u95F4 DUA \u5176\u5B9E\u5C31\u662F\u628A\u8303\u56F4\u65E5\u671F\u5185\u7684\u5355\u65E5 DUA \u8FDB\u884C OR \u8FD0\u7B97\uFF0C\u518D\u5B58\u5165\u533A\u95F4 DUA \u4E2D\uFF09</li></ul><p>\u6CE8\uFF1A\u5355\u65E5 UV \u548C DUA \u53EA\u662F\u7528\u4E8E\u5728\u7528\u6237\u8BBF\u95EE\u7684\u65F6\u5019\u8BB0\u5F55\u8FDB Redis\uFF0C\u6211\u4EEC\u7684\u4E1A\u52A1\u4E3B\u8981\u662F\u8303\u56F4\u7EDF\u8BA1\u3002\u800C\u8303\u56F4\u7EDF\u8BA1\u8981\u9760\u6BCF\u4E00\u5929\u7684 UV \u548C DUA \u5408\u5E76\u8BA1\u7B97\u51FA\u6765\u7684\u3002</p><p>key \u8BBE\u8BA1\u597D\u4E86\uFF0C\u90A3\u4E48\u6211\u4EEC\u4EC0\u4E48\u65F6\u5019\u8FDB\u884C\u7EDF\u8BA1\u5462\uFF1F\u5728\u54EA\u513F\u7EDF\u8BA1\u5462\uFF1F</p><p>\u80AF\u5B9A\u8981\u5728\u8BF7\u6C42\u65F6\u8FDB\u884C\u7EDF\u8BA1\uFF0C\u90A3\u4E48\u53EF\u4EE5\u7528\u62E6\u622A\u5668\u5B9E\u73B0\uFF0C\u5728\u7528\u6237\u8BBF\u95EE\u9875\u9762\u65F6\uFF0C\u5FC5\u7136\u5148\u8D70\u62E6\u622A\u5668\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">HandlerInterceptor</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataService</span> dataService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">preHandle</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">Object</span> handler<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u7EDF\u8BA1 UV</span>
        <span class="token class-name">String</span> ip <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getRemoteHost</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        dataService<span class="token punctuation">.</span><span class="token function">recordUV</span><span class="token punctuation">(</span>ip<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u7EDF\u8BA1 DAU</span>
        <span class="token class-name">User</span> user <span class="token operator">=</span> <span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>user <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            dataService<span class="token punctuation">.</span><span class="token function">recordDAU</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4E3B\u8981\u7684\u7EDF\u8BA1\u4E1A\u52A1\uFF0C\u8303\u56F4\u7EDF\u8BA1\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * \u7EDF\u8BA1\u6307\u5B9A\u65E5\u671F\u8303\u56F4\u5185\u7684 UV \u6570\u91CF
     * <span class="token keyword">@param</span> <span class="token parameter">start</span> \u5F00\u59CB\u65F6\u95F4
     * <span class="token keyword">@param</span> <span class="token parameter">end</span> \u7ED3\u675F\u65F6\u95F4
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">calculateUV</span><span class="token punctuation">(</span><span class="token class-name">Date</span> start<span class="token punctuation">,</span> <span class="token class-name">Date</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> end <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u6574\u7406\u8BE5\u65E5\u671F\u8303\u56F4\u5185\u7684 key</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> keyList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Calendar \u5DE5\u5177\u53EF\u7528\u4E8E\u5904\u7406\u8DDF\u65F6\u95F4\u76F8\u5173\u7684\u903B\u8F91</span>
        <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        calendar<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5F53\u5F97\u5230\u7684\u65F6\u95F4\u4E0D\u5728\u7ED3\u675F\u65F6\u95F4\u4E4B\u540E\u65F6\uFF0C\u7EDF\u8BA1\u6BCF\u4E00\u5929\u7684key\uFF0C\u4E14\u5C06\u65F6\u95F4 +1\u5929\uFF0C\u7EE7\u7EED\u4E0B\u4E00\u6B21\u5FAA\u73AF\u7EDF\u8BA1</span>
        <span class="token comment">// \u4E0D\u7528 .before(end) \u662F\u56E0\u4E3A\u4F1A\u6F0F\u6389 end \u65F6\u95F4</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUVKey</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            calendar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>DATE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u5408\u5E76\u8FD9\u4E9B\u6570\u636E\uFF0C\u5B58\u5165 \u8303\u56F4UV \u7684 key \u4E2D</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getUVKey</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> keyList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u8FD4\u56DE\u7EDF\u8BA1\u7ED3\u679C</span>
        <span class="token keyword">return</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForHyperLogLog</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token doc-comment comment">/**
     * \u7EDF\u8BA1\u6307\u5B9A\u65E5\u671F\u8303\u56F4\u5185\u7684 DAU \u6570\u91CF
     * <span class="token keyword">@param</span> <span class="token parameter">start</span> \u5F00\u59CB\u65F6\u95F4
     * <span class="token keyword">@param</span> <span class="token parameter">end</span> \u7ED3\u675F\u65F6\u95F4
     * <span class="token keyword">@return</span>
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">calculateDAU</span><span class="token punctuation">(</span><span class="token class-name">Date</span> start<span class="token punctuation">,</span> <span class="token class-name">Date</span> end<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>start <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> end <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u4E0D\u80FD\u4E3A\u7A7A\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u6574\u7406\u8BE5\u65E5\u671F\u8303\u56F4\u5185\u7684 key\uFF0CBitMap\u5B58\u50A8\u7684key\u7C7B\u578B\u662F\u5B57\u8282\u6570\u7EC4</span>
        <span class="token class-name">List</span><span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> keyList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Calendar \u5DE5\u5177\u53EF\u7528\u4E8E\u5904\u7406\u8DDF\u65F6\u95F4\u76F8\u5173\u7684\u903B\u8F91</span>
        <span class="token class-name">Calendar</span> calendar <span class="token operator">=</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        calendar<span class="token punctuation">.</span><span class="token function">setTime</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5F53\u5F97\u5230\u7684\u65F6\u95F4\u4E0D\u5728\u7ED3\u675F\u65F6\u95F4\u4E4B\u540E\u65F6\uFF0C\u7EDF\u8BA1\u6BCF\u4E00\u5929\u7684key\uFF0C\u4E14\u5C06\u65F6\u95F4 +1\u5929\uFF0C\u7EE7\u7EED\u4E0B\u4E00\u6B21\u5FAA\u73AF\u7EDF\u8BA1</span>
        <span class="token comment">// \u4E0D\u7528 .before(end) \u662F\u56E0\u4E3A\u4F1A\u6F0F\u6389 end \u65F6\u95F4</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">!</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">after</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getDAUKey</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>calendar<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            keyList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            calendar<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">Calendar</span><span class="token punctuation">.</span>DATE<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u8FDB\u884C OR \u8FD0\u7B97\uFF0C\u65E5\u671F\u8303\u56F4\u5185\u4EFB\u610F\u4E00\u5929\u767B\u5F55\u8FC7\u90FD\u7B97\u6D3B\u8DC3\uFF0C\u5B58\u5165\u8303\u56F4DAU \u7684 key \u4E2D</span>
        <span class="token class-name">Object</span> dauCnt <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">RedisCallback</span><span class="token punctuation">)</span> connection <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getDAUKey</span><span class="token punctuation">(</span>sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>start<span class="token punctuation">)</span><span class="token punctuation">,</span> sdf<span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            connection<span class="token punctuation">.</span><span class="token function">bitOp</span><span class="token punctuation">(</span><span class="token class-name">RedisStringCommands<span class="token punctuation">.</span>BitOperation</span><span class="token punctuation">.</span>OR<span class="token punctuation">,</span>
                    redisKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> keyList<span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// \u8FD4\u56DE key \u4E3A \u8303\u56F4DAU \u4E2D\u4F4D\u4E3A1\u7684\u6570\u91CF</span>
            <span class="token keyword">return</span> connection<span class="token punctuation">.</span><span class="token function">bitCount</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token keyword">long</span><span class="token punctuation">)</span> dauCnt<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Controller \u5C42\u63A5\u6536\u524D\u7AEF\u4F20\u5165\u7684\u65F6\u95F4\uFF0C\u67E5\u8BE2\u5230\u7EDF\u8BA1\u7ED3\u679C\u540E\u54CD\u5E94\u5373\u53EF\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DataController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DataService</span> dataService<span class="token punctuation">;</span>

    <span class="token comment">// \u8DF3\u8F6C\u5230\u7EDF\u8BA1\u9875\u9762\uFF0C\u652F\u6301 POST \u8BF7\u6C42\u662F\u4E3A\u4E86\u8BA9\u4E0B\u9762\u7684 /data/uv \u80FD\u8F6C\u53D1\u8FC7\u6765</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/data&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">,</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDataPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;/site/admin/data&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u7EDF\u8BA1\u7F51\u7AD9 UV\uFF0C@DateTimeFormat \u5C06\u524D\u7AEF\u4F20\u6765\u7684\u5B57\u7B26\u4E32\u7C7B\u578B\u7684\u65E5\u671F\u8F6C\u4E3A\u6211\u4EEC\u6307\u5B9A\u7684\u683C\u5F0F</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/data/uv&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getUV</span><span class="token punctuation">(</span><span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> start<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> end<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> uv <span class="token operator">=</span> dataService<span class="token punctuation">.</span><span class="token function">calculateUV</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;uvResult&quot;</span><span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;uvStartDate&quot;</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;uvEndDate&quot;</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">/* \u6B64\u5904\u53EF\u4EE5\u7528\u8F6C\u53D1\uFF1A\u8F6C\u53D1\u5230 /data \u9875\u9762\uFF0C\u6B64\u9875\u9762\u7684\u4FE1\u606F\u4F1A\u88AB\u5E26\u5230\u8F6C\u53D1\u7684\u9875\u9762\uFF0C\u8F6C\u53D1\u662F\u5728\u4E00\u4E2A\u8BF7\u6C42\u4E2D\u5B8C\u6210\u7684\uFF0C
        \u8981\u6C42\u8F6C\u53D1\u7684\u8BF7\u6C42\u4E0E\u539F\u8BF7\u6C42\u7C7B\u578B\u76F8\u540C\uFF0C\u8FD9\u4E5F\u662F\u4E3A\u4EC0\u4E48\u4E0A\u9762\u5199 /data \u8BF7\u6C42\u65F6\u8981\u652F\u6301 POST\uFF1B*/</span>
        <span class="token comment">// \u4E0D\u80FD\u7528\u91CD\u5B9A\u5411\uFF1A\u56E0\u4E3A\u91CD\u5B9A\u5411\u76F8\u5F53\u4E8E\u5BA2\u6237\u7AEF\u91CD\u65B0\u5355\u72EC\u53D1\u4E86\u4E00\u6B21 /data \u8BF7\u6C42\uFF0C\u6B64\u9875\u9762\u7684\u4FE1\u606F\u4E0D\u4F1A\u643A\u5E26\u8FC7\u53BB\uFF1B</span>
        <span class="token keyword">return</span> <span class="token string">&quot;forward:/data&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u7EDF\u8BA1\u7F51\u7AD9 DAU</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/data/dau&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getDAU</span><span class="token punctuation">(</span><span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> start<span class="token punctuation">,</span>
                        <span class="token annotation punctuation">@DateTimeFormat</span><span class="token punctuation">(</span>pattern <span class="token operator">=</span> <span class="token string">&quot;yyyy-MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Date</span> end<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">long</span> uv <span class="token operator">=</span> dataService<span class="token punctuation">.</span><span class="token function">calculateDAU</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;dauResult&quot;</span><span class="token punctuation">,</span> uv<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;dauStartDate&quot;</span><span class="token punctuation">,</span> start<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;dauEndDate&quot;</span><span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;forward:/data&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_4-kafka-\u76F8\u5173" tabindex="-1"><a class="header-anchor" href="#_4-kafka-\u76F8\u5173" aria-hidden="true">#</a> 4. Kafka \u76F8\u5173</h2><h3 id="_4-1-\u4EC0\u4E48\u662F-kafka" tabindex="-1"><a class="header-anchor" href="#_4-1-\u4EC0\u4E48\u662F-kafka" aria-hidden="true">#</a> 4.1 \u4EC0\u4E48\u662F Kafka</h3><p>Kafka \u7684\u6838\u5FC3\u6982\u5FF5\uFF1A</p><ul><li>\u751F\u4EA7\u8005\uFF08Producer\uFF09\u4E0E\u6D88\u8D39\u8005\uFF08Consumer\uFF09\uFF1A <ul><li>\u751F\u4EA7\u8005\uFF08\u4E5F\u79F0\u4E3A\u53D1\u5E03\u8005\uFF09\u521B\u5EFA\u6D88\u606F\uFF1B</li><li>\u800C\u6D88\u8D39\u8005\uFF08\u4E5F\u79F0\u4E3A\u8BA2\u9605\u8005\uFF09\u8D1F\u8D23\u6D88\u8D39 or \u8BFB\u53D6\u6D88\u606F\uFF1B</li></ul></li><li>\u4E3B\u9898\uFF08Topic\uFF09\u4E0E\u5206\u533A\uFF08Partition\uFF09\uFF1A <ul><li>\u5728 Kafka \u4E2D\u6D88\u606F\u4EE5\u4E3B\u9898\u6765\u5206\u7C7B\uFF0C\u6BCF\u4E00\u4E2A\u4E3B\u9898\u90FD\u5BF9\u5E94\u4E00\u4E2A\u300C\u6D88\u606F\u961F\u5217\u300D\u3002</li><li>\u4E00\u4E2A Topic \u88AB\u5206\u6210\u591A\u4E2A Partition\uFF0CPartition \u662F\u6700\u5C0F\u7684 <strong>\u5B58\u50A8\u5355\u5143</strong>\uFF0C\u638C\u63E1\u7740\u4E00\u4E2A Topic \u7684\u90E8\u5206\u6570\u636E\u3002</li></ul></li><li>Broker \u548C\u96C6\u7FA4\uFF08Cluster\uFF09\uFF1A <ul><li>\u4E00\u4E2A Kafka \u670D\u52A1\u5668\u4E5F\u79F0\u4E3A Broker\uFF0C\u5B83\u63A5\u53D7\u751F\u4EA7\u8005\u53D1\u9001\u7684\u6D88\u606F\u5E76\u5B58\u5165\u78C1\u76D8\u3002</li><li>Broker \u540C\u65F6\u670D\u52A1\u6D88\u8D39\u8005\u62C9\u53D6\u5206\u533A\u6D88\u606F\u7684\u8BF7\u6C42\uFF0C\u8FD4\u56DE\u76EE\u524D\u5DF2\u7ECF\u63D0\u4EA4\u7684\u6D88\u606F\u3002</li><li>\u4E00\u4E2A Broker \u6BCF\u79D2\u53EF\u4EE5\u5904\u7406\u6210\u5343\u4E0A\u4E07\u7684\u5206\u533A\u548C\u767E\u4E07\u91CF\u7EA7\u7684\u6D88\u606F\u3002</li><li>\u82E5\u5E72\u4E2A Broker \u7EC4\u6210\u4E00\u4E2A\u96C6\u7FA4\uFF08Cluster\uFF09\uFF0C\u5176\u4E2D\u96C6\u7FA4\u5185\u67D0\u4E2A Broker \u4F1A\u6210\u4E3A\u96C6\u7FA4\u63A7\u5236\u5668\uFF08Cluster Controller\uFF09\uFF0C\u5B83\u8D1F\u8D23\u7BA1\u7406\u96C6\u7FA4\u3002</li></ul></li></ul><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210301628001.webp" alt="img"></p><p>Kafka\u7279\u70B9\uFF1A</p><ul><li>\u9AD8\u541E\u5410\u91CF\u3001\u6D88\u606F\u6301\u4E45\u5316\u3001\u9AD8\u53EF\u9760\u6027\u3001\u9AD8\u6269\u5C55\u6027\u3002</li></ul><h3 id="_4-2-\u53D1\u9001\u7CFB\u7EDF\u901A\u77E5" tabindex="-1"><a class="header-anchor" href="#_4-2-\u53D1\u9001\u7CFB\u7EDF\u901A\u77E5" aria-hidden="true">#</a> 4.2 \u53D1\u9001\u7CFB\u7EDF\u901A\u77E5</h3><p>\u5176\u5B9E\u7CFB\u7EDF\u901A\u77E5\u548C\u53D1\u666E\u901A\u79C1\u4FE1\u662F\u4E00\u6837\u7684\uFF0C\u53EA\u662F\u6D88\u606F\u7684\u53D1\u9001\u8005\u662F\u7CFB\u7EDF\u800C\u5DF2\u3002</p><p>\u90A3\u4E48\u4E3A\u4EC0\u4E48\u7CFB\u7EDF\u901A\u77E5\u8981\u4F7F\u7528 Kafka \u5462\uFF1F</p><ul><li>\u7CFB\u7EDF\u901A\u77E5\u662F\u89E6\u53D1\u70B9\u8D5E\uFF0C\u5173\u6CE8\uFF0C\u8BC4\u8BBA\u7B49\u529F\u80FD\u65F6\uFF0C\u901A\u77E5\u88AB\u52A8\u65B9\u3002\u53EF\u80FD\u5728\u67D0\u4E00\u65F6\u95F4\u70B9\u4E00\u4E2A\u70ED\u8D34\u7684\u70B9\u8D5E\u6216\u8BC4\u8BBA\u5F88\u591A\uFF0C\u8FD9\u65F6\u5982\u679C\u6BCF\u6B21\u90FD\u8BB2\u901A\u77E5\u4FDD\u5B58\u5728\u6570\u636E\u5E93\uFF0C\u90A3\u5E76\u53D1\u91CF\u592A\u5927\u4E86\uFF0C\u7CFB\u7EDF\u6027\u80FD\u660E\u663E\u4F1A\u4E0B\u964D\u3002</li><li>\u6240\u4EE5\u5229\u7528\u6D88\u606F\u961F\u5217\uFF0C\u5F53\u89E6\u53D1\u70B9\u8D5E\uFF0C\u5173\u6CE8\uFF0C\u8BC4\u8BBA\u7B49\u529F\u80FD\u65F6\uFF0C\u5C31\u628A\u76F8\u5E94\u7684\u901A\u77E5\u4E22\u5230\u6D88\u606F\u961F\u5217\u4E2D\uFF0C\u8BA9\u7CFB\u7EDF\u5F02\u6B65\u7684\u53BB\u6D88\u8D39\u6D88\u606F\uFF08\u53D1\u901A\u77E5\uFF09\u3002</li></ul><blockquote><p>\u89C4\u5B9A Topic \u548C content</p></blockquote><p>\u5F88\u660E\u663E\uFF0C\u6BCF\u7C7B\u901A\u77E5\u90FD\u8981\u5BF9\u5E94\u4E00\u79CD Topic\uFF1A</p><ul><li>\u8BC4\u8BBA Topic\uFF1Acomment</li><li>\u70B9\u8D5E Topic\uFF1Alike</li><li>\u5173\u6CE8 Topic\uFF1Afollow</li></ul><p>Topic \u5BF9\u5E94\u7684 content \u5B9A\u4E49\u4E3A\u4E00\u4E2A JSON \u5B57\u7B26\u4E32\uFF0C\u6211\u4EEC\u5C06\u5176\u5C01\u88C5\u6210\u4E00\u4E2A Event \u5B9E\u4F53\u5BF9\u8C61\u4FBF\u4E8E JSON \u7684\u8F6C\u5316\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Event</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> topic<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> userId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> entityType<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> entityId<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> entityUserId<span class="token punctuation">;</span>
    <span class="token comment">// \u5176\u4ED6\u6570\u636E\u4FE1\u606F</span>
    <span class="token keyword">private</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> data <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u56E0\u4E3A\u7CFB\u7EDF\u901A\u77E5\u4E5F\u662F\u6D88\u606F\u7684\u4E00\u79CD\uFF0C\u6240\u4EE5\u6211\u4EEC\u5C06\u7CFB\u7EDF\u901A\u77E5\u4E5F\u5B58\u5165 message \u8868\u4E2D\uFF0Cmessage \u8868\u5982\u4E0B\uFF1A</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210281446446.png" alt="image-20221028144604816"></p><p>\u5728\u7CFB\u7EDF\u6D88\u606F\u4E2D\uFF0C\u5404\u5B57\u6BB5\u7684\u542B\u4E49\u5982\u4E0B\uFF1A</p><ul><li>from_id\uFF1A\u56FA\u5B9A\u4E3A 1\uFF0C\u8868\u793A\u7CFB\u7EDF\u7BA1\u7406\u5458\uFF1B</li><li>to_id\uFF1A\u8981\u901A\u77E5\u7684\u7528\u6237 id\uFF1B</li><li>conversation_id\uFF1A\u7531\u4E8E\u7CFB\u7EDF\u901A\u77E5\u5206\u4E3A\u4E09\u5927\u7C7B\uFF0C\u6240\u4EE5\u6709\u4E09\u79CD\u4E0D\u540C\u7684\u503C\uFF0C<strong>\u6BCF\u79CD\u503C\u5BF9\u5E94 Kafka \u7684 Topic</strong>\uFF1A <ul><li>follow\uFF1A\u5173\u6CE8\u901A\u77E5</li><li>like\uFF1A\u70B9\u8D5E\u901A\u77E5</li><li>comment\uFF1A\u8BC4\u8BBA\u901A\u77E5</li></ul></li><li>content\uFF1AJSON \u5B57\u7B26\u4E32\uFF0C\u5177\u4F53\u5185\u5BB9\u6839\u636E\u901A\u77E5\u7684\u7C7B\u578B\u800C\u5B9A\uFF1A <ul><li>follow \u7C7B\u578B\uFF1A{&quot;entityType&quot;: \u901A\u77E5\u7C7B\u578B\uFF0C3 \u8868\u793A\u5173\u6CE8\uFF0C&quot;entityId&quot;\uFF1A\u88AB\u901A\u77E5\u7684\u5B9E\u4F53 id(\u5BF9\u4E8E\u5173\u6CE8\u6765\u8BF4\u662F\u7528\u6237 id)\uFF0C&quot;userId&quot;: \u89E6\u53D1\u901A\u77E5\u7684\u7528\u6237 id}</li><li>like \u7C7B\u578B\uFF1A{&quot;entityType&quot;: \u901A\u77E5\u7C7B\u578B\uFF0C2 \u8868\u793A\u70B9\u8D5E\uFF0C&quot;entityId&quot;: \u88AB\u901A\u77E5\u7684\u5B9E\u4F53 id(\u5BF9\u4E8E\u70B9\u8D5E\u6765\u8BF4\u662F\u5E16\u5B50 id)\uFF0C&quot;postId&quot;: \u88AB\u70B9\u8D5E\u7684\u5E16\u5B50 id\uFF0C&quot;userId&quot;: \u89E6\u53D1\u70B9\u8D5E\u7684\u7528\u6237 id}</li><li>comment \u7C7B\u578B\uFF1A{&quot;entityType&quot;: \u901A\u77E5\u7C7B\u578B\uFF0C1 \u8868\u793A\u8BC4\u8BBA\uFF0C&quot;entityId&quot;\uFF1A\u88AB\u8BC4\u8BBA\u7684\u5B9E\u4F53 id(\u5BF9\u4E8E\u8BC4\u8BBA\u6765\u8BF4\u662F\u5E16\u5B50 id\uFF0C\u6216\u8005\u88AB\u8BC4\u8BBA\u7684\u8BC4\u8BBA id)\uFF0C&quot;postId&quot;: \u88AB\u8BC4\u8BBA\u7684\u5E16\u5B50 id\uFF0C&quot;userId&quot;: \u89E6\u53D1\u8BC4\u8BBA\u7684\u7528\u6237 id}</li></ul></li></ul><blockquote><p>Kafka \u7684\u4F7F\u7528</p></blockquote><p>\u60F3\u8981\u4F7F\u7528 Kafka\uFF0C\u9996\u5148\u5F97\u5148\u5B9A\u4E49\u4E00\u4E2A\u4E8B\u4EF6\u7684\u751F\u4EA7\u8005\uFF0C\u7528\u5728\u6211\u4EEC\u9700\u8981\u53D1\u9001\u901A\u77E5\u7684\u5730\u65B9\uFF0C\u628A\u4E8B\u4EF6\u4E22\u7ED9\u751F\u4EA7\u8005\u5C31\u884C\u4E86\u3002\u7136\u540E\u518D\u4E3A Topic \u5B9A\u4E49\u4E00\u4E2A\u6D88\u8D39\u8005\uFF0C\u76D1\u542C\u751F\u4EA7\u8005\u7684\u961F\u5217\uFF0C\u6709\u4E8B\u4EF6\u5C31\u8FDB\u884C\u6D88\u8D39\u5373\u53EF\u3002</p><p>\u751F\u4EA7\u8005\u7684\u5B9A\u4E49\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EventProducer</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">KafkaTemplate</span> kafkaTemplate<span class="token punctuation">;</span>

    <span class="token comment">// \u5904\u7406\u4E8B\u4EF6\uFF08\u53D1\u6D88\u606F\uFF09</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">fireEvent</span><span class="token punctuation">(</span><span class="token class-name">Event</span> event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u5C06\u4E8B\u4EF6\u53D1\u5E03\u5230\u6307\u5B9A\u7684\u4E3B\u9898\uFF0C\u5185\u5BB9\u662F\u4E8B\u4EF6\u5BF9\u8C61\u7684 JSON \u5B57\u7B26\u4E32</span>
        kafkaTemplate<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u7740\uFF0C\u5728\u9700\u8981\u53D1\u9001\u901A\u77E5\u7684\u5730\u65B9\u5C01\u88C5\u4E8B\u4EF6\uFF0C\u4E22\u7ED9\u751F\u4EA7\u8005\u3002\u4F8B\u5982\u5728\u6DFB\u52A0\u8BC4\u8BBA\u65F6\uFF0C\u628A\u8BC4\u8BBA\u4E8B\u4EF6\u4E22\u7ED9\u751F\u4EA7\u8005\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/add/{discussPostId}&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">addComment</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span><span class="token punctuation">(</span><span class="token string">&quot;discussPostId&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> discussPostId<span class="token punctuation">,</span> <span class="token class-name">Comment</span> comment<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        comment<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        comment<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        commentService<span class="token punctuation">.</span><span class="token function">addComment</span><span class="token punctuation">(</span>comment<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u89E6\u53D1\u8BC4\u8BBA\u4E8B\u4EF6\uFF08\u901A\u77E5\u7ED9\u88AB\u8BC4\u8BBA\u7684\u7528\u6237\uFF09\uFF0CEntityType\uFF0CEntityId \u7B49\u4FE1\u606F\u524D\u7AEF\u5DF2\u7ECF\u8D4B\u4E0A\u4E86</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Event</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setTopic</span><span class="token punctuation">(</span><span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>TOPIC_COMMENT<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token class-name">UserThreadLocal</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityType</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setEntityId</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">setData</span><span class="token punctuation">(</span><span class="token string">&quot;postId&quot;</span><span class="token punctuation">,</span> discussPostId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u7531\u4E8E\u4E0D\u77E5\u9053\u8BC4\u8BBA\u7684\u76EE\u6807\u662F\u5B50\u8BC4\u8BBA\u8FD8\u662F\u5E16\u5B50\uFF0C\u6240\u4EE5\u9700\u8981\u5224\u65AD</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>ENTITY_TYPE_POST<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DiscussPost</span> target <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span><span class="token function">setEntityUserId</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>ENTITY_TYPE_COMMENT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Comment</span> target <span class="token operator">=</span> commentService<span class="token punctuation">.</span><span class="token function">findCommentById</span><span class="token punctuation">(</span>comment<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            event<span class="token punctuation">.</span><span class="token function">setEntityUserId</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        eventProducer<span class="token punctuation">.</span><span class="token function">fireEvent</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token string">&quot;redirect:/discuss/detail/&quot;</span> <span class="token operator">+</span> discussPostId<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u73B0\u5728\u6D88\u606F\u4E8B\u4EF6\u5DF2\u7ECF\u88AB\u751F\u4EA7\u8005\u63A5\u6536\uFF0C\u653E\u5165\u961F\u5217\u4E2D\u4E86\uFF0C\u63A5\u4E0B\u6765\u5C31\u8981\u5B9A\u4E49\u6D88\u8D39\u8005\u53BB\u6D88\u8D39\u8FD9\u4E2A Topic \u4E2D\u7684\u4E8B\u4EF6\u4E86\u3002\u7531\u4E8E\u8BC4\u8BBA\u3001\u70B9\u8D5E\u3001\u5173\u6CE8\u90FD\u662F\u5C5E\u4E8E\u7CFB\u7EDF\u901A\u77E5\uFF0C\u6240\u4EE5\u53EF\u4EE5\u7528\u4E00\u4E2A\u6D88\u8D39\u8005\u6D88\u8D39\u8FD9\u4E09\u7C7B Topic\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token doc-comment comment">/**
     * \u6D88\u8D39 \u8BC4\u8BBA/\u70B9\u8D5E/\u5173\u6CE8 \u4E8B\u4EF6
     * <span class="token keyword">@param</span> <span class="token parameter">record</span>
     */</span>
    <span class="token annotation punctuation">@KafkaListener</span><span class="token punctuation">(</span>topics <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>TOPIC_COMMENT<span class="token punctuation">,</span> <span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>TOPIC_LIKE<span class="token punctuation">,</span> <span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>TOPIC_FOLLOW<span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handlePDGMessage</span><span class="token punctuation">(</span><span class="token class-name">ConsumerRecord</span> record<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>record <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6D88\u606F\u7684\u5185\u5BB9\u4E3A\u7A7A&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u4ECE\u961F\u5217\u4E2D\u83B7\u53D6\u6D88\u606F</span>
        <span class="token class-name">Event</span> event <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>record<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>event <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u6D88\u606F\u683C\u5F0F\u9519\u8BEF&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u53D1\u9001\u7AD9\u5185\u901A\u77E5</span>
        <span class="token class-name">Message</span> message <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Message</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setFromId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// \u7CFB\u7EDF\u901A\u77E5\u7684id\u4E3A1</span>
        message<span class="token punctuation">.</span><span class="token function">setToId</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>       <span class="token comment">// \u901A\u77E5\u76EE\u6807\u5B9E\u4F53\u7684id</span>
        message<span class="token punctuation">.</span><span class="token function">setConversationId</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getTopic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        message<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// message \u4E2D\u7684\u5185\u5BB9\uFF08content\uFF09\uFF0CJSON \u5B57\u7B26\u4E32\u7C7B\u578B</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> content <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        content<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;userId&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        content<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityType&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getEntityType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        content<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;entityId&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span><span class="token function">getEntityId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u5176\u4ED6\u6570\u636E\u6D88\u606F\uFF0C\u901A\u8FC7 event.getData()\uFF08Map\uFF09 \u6765\u83B7\u53D6</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            content<span class="token punctuation">.</span><span class="token function">putAll</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span><span class="token function">getData</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        message<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        messageService<span class="token punctuation">.</span><span class="token function">addMessage</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u4ECE\u4EE3\u7801\u4E2D\u53EF\u4EE5\u770B\u5230\uFF0C\u6D88\u8D39\u8005\u6D88\u8D39\u6D88\u606F\u7684\u6B65\u9AA4\u4E3A\uFF1A</p><ol><li>\u4ECE\u5BF9\u5E94 Topic \u7684\u961F\u5217\u4E2D\u83B7\u53D6\u6D88\u606F\u4E8B\u4EF6\uFF1B</li><li>\u5C06\u4E8B\u4EF6\u7684\u5185\u5BB9\u8BFB\u53D6\u51FA\u6765\uFF0C\u63D2\u5165\u5230 message \u8868\u4E2D\uFF1B</li><li>\u7528\u6237\u5728\u8BBF\u95EE\u9875\u9762\u65F6\uFF0C\u5C31\u4F1A\u8BBF\u95EE MessageController \u4E2D\u7684\u83B7\u53D6\u901A\u77E5\u7684\u8BF7\u6C42\u65B9\u6CD5\uFF0C\u5C06\u7CFB\u7EDF\u901A\u77E5\u548C\u79C1\u4FE1\u90FD\u8BFB\u51FA\u6765\uFF0C\u6700\u540E\u663E\u793A\u5728\u9875\u9762\u4E0A\uFF0C\u5C31\u5B8C\u6210\u4E86\u901A\u77E5\u529F\u80FD\u3002</li></ol><p>\u9664\u4E86\u7CFB\u7EDF\u901A\u77E5\uFF0CKafka \u8FD8\u7528\u4E8E\u66F4\u65B0 ES\uFF08\u5E16\u5B50\u7684\u589E\u5220\u6539\u540E\u90FD\u8981\u66F4\u65B0 ES\uFF09 \uFF0C\u6216\u8005\u4E00\u4E9B\u5BF9\u5B9E\u65F6\u6027\u8981\u6C42\u6CA1\u6709\u90A3\u4E48\u9AD8\u7684\u529F\u80FD\u3002</p><h2 id="_5-elasticsearch-\u76F8\u5173" tabindex="-1"><a class="header-anchor" href="#_5-elasticsearch-\u76F8\u5173" aria-hidden="true">#</a> 5. ElasticSearch \u76F8\u5173</h2><h3 id="_5-1-\u4E3A\u4EC0\u4E48\u8981\u7528-es" tabindex="-1"><a class="header-anchor" href="#_5-1-\u4E3A\u4EC0\u4E48\u8981\u7528-es" aria-hidden="true">#</a> 5.1 \u4E3A\u4EC0\u4E48\u8981\u7528 ES</h3><p>\u6211\u4EEC\u4F7F\u7528 ES \u6700\u591A\u7684\u5C31\u662F\u641C\u7D22\u529F\u80FD\u4E86\uFF0C\u6570\u636E\u5E93\u4E5F\u80FD\u505A\u641C\u7D22\u529F\u80FD\u554A\uFF0C\u6BD4\u5982\uFF1A</p><div class="language-sql ext-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> <span class="token identifier"><span class="token punctuation">\`</span>discuss_post<span class="token punctuation">\`</span></span> <span class="token keyword">where</span> content <span class="token operator">like</span> <span class="token string">&#39;%\u5BD2\u51AC%&#39;</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>\u8FD9\u6837\u4E5F\u80FD\u628A &quot;\u5BD2\u51AC&quot; \u76F8\u5173\u7684\u5185\u5BB9\u7684\u5E16\u5B50\u641C\u7D22\u51FA\u6765\uFF0C\u4F46\u662F\u50CF content like &#39;%\u5BD2\u51AC%&#39; \u8FD9\u7C7B\u67E5\u8BE2\u662F\u4E0D\u8D70\u7D22\u5F15\u7684\u3002</p><p>\u4ECE SQL \u6267\u884C\u7684\u5206\u6790\u7ED3\u679C\u4E2D\u53EF\u4EE5\u770B\u51FA\uFF0C\u4E0A\u9762\u7684\u67E5\u8BE2\u8BED\u53E5\u6CA1\u6709\u53EF\u7528\u7684\u7D22\u5F15\uFF0C\u4E14\u67E5\u8BE2\u7C7B\u578B\u4E3A ALL\uFF08\u5168\u8868\u626B\u63CF\uFF09\uFF1A</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210301822836.png" alt="image-20221030182241344"></p><p>\u4F60\u53EF\u80FD\u4F1A\u8BF4\uFF0C\u90A3\u597D\u529E\uFF0C\u90A3\u6211\u5728 content \u5217\u6DFB\u52A0\u4E00\u4E2A\u7D22\u5F15\u5457\u3002\u4F46\u662F content \u5217\u7684\u7C7B\u578B\u4E3A text\uFF0C\u6211\u4EEC\u9700\u8981\u7ED9\u51FA\u524D\u7F00\u7D22\u5F15\u957F\u5EA6\u624D\u80FD\u4E3A\u6B64\u5217\u5EFA\u7ACB\u7D22\u5F15\uFF0C\u56E0\u4E3A\u7D22\u5F15\u5217\u7684\u957F\u5EA6\u662F\u6709\u9650\u5236\u7684\u3002\u90A3\u5982\u679C\u6211\u8981\u67E5\u8BE2\u7684\u5173\u952E\u5B57\u5C31\u662F\u5728 content \u4E2D\u7684\u540E\u9762\u90E8\u5206\u5462\uFF1F\u4F60\u53EA\u5EFA\u7ACB\u524D\u7F00\u7D22\u5F15\u6709\u4EC0\u4E48\u7528\uFF1F\u6240\u4EE5\u5EFA\u7ACB content \u7D22\u5F15\u5217\u4E0D\u662F\u5F88\u65B9\u4FBF\u3002</p><p>\u8FD8\u6709\u4E00\u4E2A\u89E3\u51B3\u529E\u6CD5\uFF0CMySQL 5.6 \u7248\u672C\u5F00\u59CB\uFF0CInnoDB \u4E5F\u652F\u6301\u5168\u6587\u7D22\u5F15\uFF08\u5168\u6587\u7D22\u5F15\u6709\u81EA\u5DF1\u7684\u8BED\u6CD5\u683C\u5F0F\uFF09\uFF0C5.7.6 \u4E4B\u540E\u4E5F\u6709\u4E86\u4E2D\u6587\u7684\u5168\u6587\u5206\u6790\u5668 ngram\u3002\u6240\u4EE5\u6211\u4EEC\u53EF\u4EE5\u5728 content \u5217\u5EFA\u7ACB\u5168\u6587\u7D22\u5F15\u3002</p><p>\u4F46\u662F MySQL \u7684\u5168\u6587\u7D22\u5F15\u6709\u4E9B\u6027\u80FD\u95EE\u9898\uFF1A</p><ul><li>\u5F53\u641C\u7D22\u7684\u7ED3\u679C\u96C6\u8F83\u5927\u65F6\uFF0C\u4F1A\u5F15\u53D1\u6267\u884C\u5F02\u5E38\uFF0C\u9700\u8981\u8C03\u9AD8\u76F8\u5173\u5185\u5B58\u53C2\u6570\u914D\u7F6E\uFF1B</li><li>\u8F93\u5165\u76EE\u6807\u6587\u672C\u8D8A\u957F\uFF0C\u6027\u80FD\u8D8A\u4F4E\uFF1B</li><li>\u7B26\u5408\u6761\u4EF6\u8BB0\u5F55\u6570\u8D8A\u591A\uFF0C\u6027\u80FD\u8D8A\u4F4E\uFF1B</li></ul><p>\u800C\u4E14\uFF0C\u6211\u4EEC\u6709\u65F6\u5019\u4E5F\u4E0D\u9700\u8981\u5C06\u7B26\u5408\u6761\u4EF6\u7684\u7ED3\u679C\u5168\u90E8\u8FD4\u56DE\u7ED9\u7528\u6237\uFF0C\u53EF\u80FD\u7528\u6237\u5C31\u67E5\u770B\u524D\u9762\u4E00\u4E24\u9875\u7684\u6570\u636E\uFF0C\u6240\u4EE5\u8981\u6C42\u524D\u9762\u7684\u6570\u636E\u4E00\u5B9A\u8981\u662F\u76F8\u5173\u6027\u6700\u5F3A\u7684\u3002</p><p>\u6240\u4EE5\uFF0C\u4E13\u4E1A\u7684\u4E8B\uFF08\u5168\u6587\u641C\u7D22\uFF09\u8FD8\u662F\u4EA4\u7ED9\u4E13\u4E1A\u7684\u4EBA\uFF08ES\uFF09\u6765\u505A\u5427\uFF01</p><h3 id="_5-2-\u4EC0\u4E48\u662F-es" tabindex="-1"><a class="header-anchor" href="#_5-2-\u4EC0\u4E48\u662F-es" aria-hidden="true">#</a> 5.2 \u4EC0\u4E48\u662F ES</h3><blockquote><p>ES \u80FD\u5E72\u4EC0\u4E48</p></blockquote><p>\u6211\u4EEC\u4E3B\u8981\u8BA8\u8BBA\u5B83\u7684\u6838\u5FC3\u529F\u80FD \u2014 \u641C\u7D22\uFF1A</p><ul><li>Elasticsearch \u5BF9\u6A21\u7CCA\u641C\u7D22\u975E\u5E38\u64C5\u957F\uFF08\u641C\u7D22\u901F\u5EA6\u5F88\u5FEB\uFF09</li><li>\u4ECEElasticsearch \u641C\u7D22\u5230\u7684\u6570\u636E\u53EF\u4EE5\u6839\u636E <strong>\u8BC4\u5206</strong> \u8FC7\u6EE4\u6389\u5927\u90E8\u5206\u7684\uFF0C\u53EA\u8981\u8FD4\u56DE\u8BC4\u5206\u9AD8\u7684\u7ED9\u7528\u6237\u5C31\u597D\u4E86\uFF08\u539F\u751F\u5C31\u652F\u6301\u6392\u5E8F\uFF09</li><li>\u6CA1\u6709\u90A3\u4E48\u51C6\u786E\u7684\u5173\u952E\u5B57\u4E5F\u80FD\u641C\u51FA\u76F8\u5173\u7684\u7ED3\u679C\uFF08\u80FD\u5339\u914D\u6709\u76F8\u5173\u6027\u7684\u8BB0\u5F55\uFF09</li></ul><blockquote><p>ES \u7684\u6838\u5FC3\u6982\u5FF5</p></blockquote><p>\u8282\u70B9\uFF08Node\uFF09\u3001\u96C6\u7FA4\uFF08Cluster\uFF09\u3001\u5206\u7247\uFF08Shards\uFF09\uFF1A</p><ul><li>\u8282\u70B9\uFF08Node\uFF09\uFF1A\u5355\u4E2A\u5B9E\u4F8B\u79F0\u4E3A\u4E00\u4E2A\u8282\u70B9\uFF1B</li><li>\u96C6\u7FA4\uFF08Cluster\uFF09\uFF1A\u4E00\u7EC4\u8282\u70B9\u6784\u6210\u4E00\u4E2A\u96C6\u7FA4\uFF1B</li><li>\u5206\u7247\uFF08Shards\uFF09\uFF1A\u5206\u7247\u662F\u5E95\u5C42\u7684\u5DE5\u4F5C\u5355\u5143\uFF0C\u6587\u6863\u4FDD\u5B58\u5728\u5206\u7247\u5185\uFF0C\u5206\u7247\u53C8\u88AB\u5206\u914D\u5230\u96C6\u7FA4\u5185\u7684\u5404\u4E2A\u8282\u70B9\u91CC\uFF0C\u6BCF\u4E2A\u5206\u7247\u4EC5\u4FDD\u5B58\u5168\u90E8\u6570\u636E\u7684\u4E00\u90E8\u5206\u3002</li></ul><p>\u7D22\u5F15 Index\u3001\u7C7B\u578B Type \u548C\u6587\u6863 Document\uFF0C\u5BF9\u6BD4\u6211\u4EEC\u6BD4\u8F83\u719F\u6089\u7684 MySQL \u6570\u636E\u5E93\uFF1A</p><ul><li>index \u2192 db</li><li><s>type \u2192 table</s></li><li>document \u2192 row</li></ul><p><strong>\u6CE8\u610F</strong>\uFF1A\u5728 ES 7.0 \u4E4B\u540E\u7684\u7248\u672C\u4E2D Type \u88AB\u5E9F\u5F03\u4E86\u3002\u4E00\u4E2A index \u4E2D\u53EA\u6709\u4E00\u4E2A\u9ED8\u8BA4\u7684 type\uFF0C\u5373 _doc\u3002</p><p>ES \u7684 Type \u88AB\u5E9F\u5F03\u540E\uFF0C\u5E93\u8868\u5408\u4E00\uFF0CIndex \u65E2\u53EF\u4EE5\u88AB\u8BA4\u4E3A\u5BF9\u5E94 MySQL \u7684 Database\uFF0C\u4E5F\u53EF\u4EE5\u8BA4\u4E3A\u5BF9\u5E94 table\u3002</p><p>\u6240\u4EE5 ES 7.0 \u4E4B\u540E\u53EF\u4EE5\u8FD9\u6837\u8BA4\u4E3A\uFF1A</p><ul><li>ES \u5B9E\u4F8B\uFF1A\u5BF9\u5E94 MySQL \u5B9E\u4F8B\u4E2D\u7684\u4E00\u4E2A Database\u3002</li><li>Index \u5BF9\u5E94 MySQL \u4E2D\u7684 Table \u3002</li><li>Document \u5BF9\u5E94 MySQL \u4E2D\u8868\u7684\u8BB0\u5F55</li></ul><h3 id="_5-3-\u641C\u7D22\u529F\u80FD" tabindex="-1"><a class="header-anchor" href="#_5-3-\u641C\u7D22\u529F\u80FD" aria-hidden="true">#</a> 5.3 \u641C\u7D22\u529F\u80FD</h3><p>\u63A5\u4E0B\u6765\uFF0C\u6211\u4EEC\u5C31\u5229\u7528 ES \u6765\u5B9E\u73B0\u641C\u7D22\u529F\u80FD\u3002</p><blockquote><p>ES \u5BA2\u6237\u7AEF\u914D\u7F6E</p></blockquote><p>\u9996\u5148\u8981\u5EFA\u7ACB\u4E00\u4E2A ES \u5BA2\u6237\u7AEF\uFF0C\u7528\u4E8E\u8FDE\u63A5 ES\uFF0C\u7136\u540E\u5728\u8FD9\u4E2A\u5BA2\u6237\u7AEF\u4E0A\u8FDB\u884C\u590D\u6742\u7684\u67E5\u8BE2\u64CD\u4F5C\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EsConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${spring.elasticsearch.uris}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> esUrl<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token class-name">RestHighLevelClient</span> <span class="token function">esClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClientConfiguration</span> clientConfiguration <span class="token operator">=</span> <span class="token class-name">ClientConfiguration</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">connectedTo</span><span class="token punctuation">(</span>esUrl<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">RestClients</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>clientConfiguration<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728\u9700\u8981\u4F7F\u7528\u7684\u5730\u65B9\u7528 <code>@Qualifier(&quot;esClient&quot;)</code> \u6307\u5B9A\u7C7B\u540D\u6CE8\u5165\u5373\u53EF\u3002</p><p>\u8FD8\u8981\u5C06\u6570\u636E\u5B58\u5165\u5230 ES \u4E2D\uFF0C\u53EF\u4EE5\u4F7F\u7528 ElasticsearchRepository \u63A5\u53E3\uFF0C\u53EA\u8981\u7EE7\u627F\u5B83\u5C31\u53EF\u4EE5\u4F7F\u7528\u4E86\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Repository</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">DiscussPostRepository</span> <span class="token keyword">extends</span> <span class="token class-name">ElasticsearchRepository</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u9664\u6B64\u4E4B\u5916\uFF0C\u4E3A\u4E86\u65B9\u4FBF\uFF0C\u6211\u4EEC\u521B\u5EFA\u4E00\u4E2A SearchResult \u5B9E\u4F53\u7C7B\uFF0C\u7528\u4E8E\u5B58\u653E\u67E5\u8BE2\u7ED3\u679C\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: \u7528\u4E8E\u6682\u5B58 es \u4E2D\u67E5\u8BE2\u5230\u7684\u5217\u8868\u548C\u603B\u884C\u6570
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/20
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchResult</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">long</span> total<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">SearchResult</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> list<span class="token punctuation">,</span> <span class="token keyword">long</span> total<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>list <span class="token operator">=</span> list<span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>total <span class="token operator">=</span> total<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>\u529F\u80FD\u5B9E\u73B0</p></blockquote><p>\u5728 service \u5C42\u63D0\u4F9B\u6570\u636E\u5B58\u5165 ES\uFF0C\u4ECE ES \u5220\u9664\u6570\u636E\uFF0C\u67E5\u8BE2\u6570\u636E\u7684\u65B9\u6CD5\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ElasticsearchServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">ElasticsearchService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostRepository</span> postRepository<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;esClient&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">RestHighLevelClient</span> restHighLevelClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveDiscussPost</span><span class="token punctuation">(</span><span class="token class-name">DiscussPost</span> discussPost<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        postRepository<span class="token punctuation">.</span><span class="token function">save</span><span class="token punctuation">(</span>discussPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">deleteDiscussPost</span><span class="token punctuation">(</span><span class="token keyword">int</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        postRepository<span class="token punctuation">.</span><span class="token function">deleteById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">SearchResult</span> <span class="token function">searchDiscussPost</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyword<span class="token punctuation">,</span> <span class="token keyword">int</span> current<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token class-name">SearchRequest</span> searchRequest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchRequest</span><span class="token punctuation">(</span><span class="token string">&quot;discusspost&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//discusspost\u662F\u7D22\u5F15\u540D\uFF0C\u5C31\u662F\u8868\u540D</span>
        <span class="token comment">//\u9AD8\u4EAE</span>
        <span class="token class-name">HighlightBuilder</span> highlightBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HighlightBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">field</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">requireFieldMatch</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">preTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;span style=&#39;color:red&#39;&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        highlightBuilder<span class="token punctuation">.</span><span class="token function">postTags</span><span class="token punctuation">(</span><span class="token string">&quot;&lt;/span&gt;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//\u6784\u5EFA\u641C\u7D22\u6761\u4EF6</span>
        <span class="token class-name">SearchSourceBuilder</span> searchSourceBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SearchSourceBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token class-name">QueryBuilders</span><span class="token punctuation">.</span><span class="token function">multiMatchQuery</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> <span class="token string">&quot;title&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span><span class="token string">&quot;type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>DESC<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span><span class="token string">&quot;score&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>DESC<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token class-name">SortBuilders</span><span class="token punctuation">.</span><span class="token function">fieldSort</span><span class="token punctuation">(</span><span class="token string">&quot;createTime&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">order</span><span class="token punctuation">(</span><span class="token class-name">SortOrder</span><span class="token punctuation">.</span>DESC<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>current<span class="token punctuation">)</span>  <span class="token comment">// \u6307\u5B9A\u4ECE\u54EA\u6761\u5F00\u59CB\u67E5\u8BE2</span>
                <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span>limit<span class="token punctuation">)</span>    <span class="token comment">// \u9700\u8981\u67E5\u51FA\u7684\u603B\u8BB0\u5F55\u6761\u6570</span>
                <span class="token punctuation">.</span><span class="token function">highlighter</span><span class="token punctuation">(</span>highlightBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//\u9AD8\u4EAE</span>

        searchRequest<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span>searchSourceBuilder<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchResponse</span> searchResponse <span class="token operator">=</span> restHighLevelClient<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>searchRequest<span class="token punctuation">,</span> <span class="token class-name">RequestOptions</span><span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">long</span> total <span class="token operator">=</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTotalHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>value<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">SearchHit</span> hit <span class="token operator">:</span> searchResponse<span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">DiscussPost</span> discussPost <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>hit<span class="token punctuation">.</span><span class="token function">getSourceAsString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">DiscussPost</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// \u5904\u7406\u9AD8\u4EAE\u663E\u793A\u7684\u7ED3\u679C</span>
            <span class="token class-name">HighlightField</span> titleField <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;title&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>titleField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                discussPost<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>titleField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">HighlightField</span> contentField <span class="token operator">=</span> hit<span class="token punctuation">.</span><span class="token function">getHighlightFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;content&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>contentField <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                discussPost<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span>contentField<span class="token punctuation">.</span><span class="token function">getFragments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
<span class="token comment">//                System.out.println(discussPost);</span>
            list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>discussPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SearchResult</span><span class="token punctuation">(</span>list<span class="token punctuation">,</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5176\u4E2D\uFF0Csave \u548C delete \u5728\u6DFB\u52A0\u5E16\u5B50\u548C\u5220\u9664\u5E16\u5B50\u65F6\u8C03\u7528\uFF0C\u5177\u4F53\u7684\u8C03\u7528\u65B9\u5F0F\u662F\uFF1A</p><ol><li>\u5728\u6DFB\u52A0\u5E16\u5B50\u548C\u5220\u9664\u5E16\u5B50\u65F6\uFF0C\u5148\u5C06\u4E8B\u4EF6\u4E22\u5165 Kafka\uFF0C\u800C\u4E0D\u662F\u7ACB\u5373\u66F4\u65B0 ES\uFF1B</li><li>\u7136\u540E\u518D\u5728\u6D88\u8D39\u8005\u4E2D\u8C03\u7528 save \u548C delete \u65B9\u6CD5\u8FDB\u884C\u5177\u4F53\u7684\u5220\u9664\u3002</li></ol><p>search \u65B9\u6CD5\u662F\u6838\u5FC3\uFF0C\u5176\u4E3B\u8981\u5B8C\u6210\u4E86\uFF1A</p><ul><li>\u5173\u952E\u8BCD\u7684\u9AD8\u4EAE\uFF1B</li><li>\u6839\u636E\u5173\u952E\u8BCD\u5BF9 titile \u548C content \u8FDB\u884C\u5339\u914D\uFF1B</li></ul><p>Controller \u5C42\u53EA\u9700\u8981\u63D0\u4F9B\u4E00\u4E2A\u8BF7\u6C42\u65B9\u6CD5\u5373\u53EF\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Controller</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SearchController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ElasticsearchService</span> elasticsearchService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">UserService</span> userService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LikeService</span> likeService<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u901A\u8FC7 ES \u641C\u7D22\u5E16\u5B50
     * <span class="token keyword">@param</span> <span class="token parameter">keyword</span> \u641C\u7D22\u5173\u952E\u8BCD
     * <span class="token keyword">@param</span> <span class="token parameter">page</span> \u5206\u9875\u4FE1\u606F
     * <span class="token keyword">@param</span> <span class="token parameter">model</span>
     * <span class="token keyword">@return</span>
     * <span class="token keyword">@throws</span> <span class="token reference"><span class="token class-name">IOException</span></span>
     */</span>
    <span class="token comment">// search?keyword=xxx</span>
    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span>path <span class="token operator">=</span> <span class="token string">&quot;/search&quot;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token class-name">RequestMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">search</span><span class="token punctuation">(</span><span class="token class-name">String</span> keyword<span class="token punctuation">,</span> <span class="token class-name">Page</span> page<span class="token punctuation">,</span> <span class="token class-name">Model</span> model<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u641C\u7D22\u5E16\u5B50</span>
        <span class="token class-name">SearchResult</span> result <span class="token operator">=</span> elasticsearchService<span class="token punctuation">.</span><span class="token function">searchDiscussPost</span><span class="token punctuation">(</span>keyword<span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> page<span class="token punctuation">.</span><span class="token function">getLimit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u805A\u5408\u6570\u636E</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> discussPosts <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">DiscussPost</span> post <span class="token operator">:</span> result<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;post&quot;</span><span class="token punctuation">,</span> post<span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">,</span> userService<span class="token punctuation">.</span><span class="token function">findUserById</span><span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                map<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;likeCount&quot;</span><span class="token punctuation">,</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>ENTITY_TYPE_POST<span class="token punctuation">,</span> post<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                discussPosts<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>map<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;discussPosts&quot;</span><span class="token punctuation">,</span> discussPosts<span class="token punctuation">)</span><span class="token punctuation">;</span>
        model<span class="token punctuation">.</span><span class="token function">addAttribute</span><span class="token punctuation">(</span><span class="token string">&quot;keyword&quot;</span><span class="token punctuation">,</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u5206\u9875\u4FE1\u606F</span>
        page<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">&quot;/search?keyword=&quot;</span> <span class="token operator">+</span> keyword<span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">setRows</span><span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">getTotal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token string">&quot;/site/search&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="_6-\u5B9A\u65F6\u4EFB\u52A1" tabindex="-1"><a class="header-anchor" href="#_6-\u5B9A\u65F6\u4EFB\u52A1" aria-hidden="true">#</a> 6. \u5B9A\u65F6\u4EFB\u52A1</h2><p>\u56E0\u4E3A\u70ED\u699C\u5E16\u5B50\u662F\u6BCF\u9694\u4E00\u6BB5\u65F6\u95F4\u66F4\u65B0\u4E00\u6B21\u7684\uFF0C\u6240\u4EE5\u5F88\u9002\u5408\u7528\u5B9A\u65F6\u4EFB\u52A1\u6765\u5B8C\u6210\u8FD9\u4E2A\u4E1A\u52A1\u3002</p><h3 id="_6-1-\u8BA4\u8BC6-quartz" tabindex="-1"><a class="header-anchor" href="#_6-1-\u8BA4\u8BC6-quartz" aria-hidden="true">#</a> 6.1 \u8BA4\u8BC6 Quartz</h3><p>\u4F7F\u7528 JDK \u7684 ScheduledExecutorService \u548C Spring \u7684 ThreadPoolTaskScheduler \u90FD\u53EF\u4EE5\u5B9E\u73B0\u5B9A\u65F6\u4EFB\u52A1\uFF0C\u4F46\u662F\u6CA1\u6709 Quartz \u529F\u80FD\u5F3A\u5927\u3002</p><p>Quartz \u53EF\u4EE5\u6839\u636E Cron \u8868\u8FBE\u5F0F\u81EA\u7531\u7684\u81EA\u5B9A\u4E49\u5B9A\u65F6\u4EFB\u52A1\u7684\u89C4\u5219\uFF0C\u6BD4\u5982\u6BCF\u6708\u6BCF\u5929\u4EC0\u4E48\u65F6\u5019\u6267\u884C\u4EFB\u52A1\u3002</p><p>Quartz \u7684\u6838\u5FC3\u6982\u5FF5\uFF1A</p><ul><li>Job\uFF1A\u5373\u9700\u8981\u5B8C\u6210\u7684\u5DE5\u4F5C\uFF0C\u9700\u8981\u5B9E\u73B0 org.quartz.job \u63A5\u53E3\uFF0C\u91CD\u5199 execute \u65B9\u6CD5\uFF0C\u5B9A\u65F6\u5668\u5230\u65F6\u540E\u5C31\u4F1A\u6267\u884C\u3002</li><li>Trigger\uFF1A\u6267\u884C\u4EFB\u52A1\u7684\u89E6\u53D1\u5668\uFF0C\u6BD4\u5982\u4F60\u60F3\u6BCF\u5929\u5B9A\u65F6 1 \u70B9\u53D1\u9001\u90AE\u4EF6\uFF0CTrigger \u5C06\u4F1A\u8BBE\u7F6E 1 \u70B9\u6267\u884C\u8BE5\u4EFB\u52A1\u3002</li><li>Scheduler\uFF1A\u4EFB\u52A1\u7684\u8C03\u5EA6\u5668\uFF0C\u4F1A\u5C06 Job \u548C Trigger \u7ED3\u5408\uFF0C\u8D1F\u8D23\u57FA\u4E8E Trigger \u8BBE\u5B9A\u7684\u65F6\u95F4\u6267\u884C Job</li></ul><h3 id="_6-2-\u70ED\u699C\u5E16\u5B50\u5B9E\u73B0" tabindex="-1"><a class="header-anchor" href="#_6-2-\u70ED\u699C\u5E16\u5B50\u5B9E\u73B0" aria-hidden="true">#</a> 6.2 \u70ED\u699C\u5E16\u5B50\u5B9E\u73B0</h3><p>\u5728\u9996\u9875\u7684\u70ED\u5E16\u6392\u884C\u699C\u4E2D\uFF0C\u5E16\u5B50\u662F\u6839\u636E\u70ED\u5EA6\u6392\u884C\u7684\uFF0C\u70ED\u5EA6\u7528\u5206\u6570\u6765\u8861\u91CF\u3002</p><p>\u6211\u4EEC\u6BCF\u6B21\u5728\u5BF9\u5E16\u5B50\u8FDB\u884C\u6DFB\u52A0\u3001\u8BC4\u8BBA\u3001\u52A0\u7CBE\u3001\u70B9\u8D5E\u65F6\uFF0C\u90FD\u4F1A\u5BF9\u5E16\u5B50\u7684\u5206\u6570\u9020\u6210\u5F71\u54CD\uFF0C\u6240\u4EE5\u5728\u8FD9\u4E9B\u5730\u65B9\u90FD\u9700\u8981\u66F4\u65B0\u5E16\u5B50\u5206\u6570\u3002</p><p>\u5E16\u5B50\u5206\u6570\u80AF\u5B9A\u4E0D\u662F\u5B9E\u65F6\u66F4\u65B0\u7684\uFF0C\u6211\u4EEC\u5C06\u9700\u8981\u66F4\u65B0\u7684\u5E16\u5B50 id \u5B58\u5165 Redis \u4E2D\uFF0C\u7136\u540E\u7528\u5B9A\u65F6\u4EFB\u52A1\u53BB Redis \u4E2D\u53D6\u5E16\u5B50\u6765\u66F4\u65B0\u3002\u56E0\u4E3A\u4E0D\u7BA1\u6211\u4EEC\u5BF9\u5E16\u5B50\u505A\u4E86\u591A\u5C11\u6B21\u66F4\u6539\uFF0C\u6700\u540E\u5BF9\u6BCF\u4E00\u4E2A\u5E16\u5B50\u90FD\u53EA\u8BA1\u7B97\u4E00\u6B21\u5206\u6570\uFF0C\u4E3A\u4E86\u907F\u514D\u91CD\u590D\u5BF9\u4E00\u4E2A\u5E16\u5B50\u8FDB\u884C\u66F4\u65B0\uFF0C\u6240\u4EE5 key \u4F7F\u7528 set \u7C7B\u578B\u3002</p><p>\u5206\u6790\u597D\u4E1A\u52A1\u529F\u80FD\u540E\uFF0C\u5F00\u59CB\u5B9A\u4E49\u6211\u4EEC\u7684 Job\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: \u5B9A\u65F6\u4EFB\u52A1\uFF0C\u5B9A\u65F6\u5237\u65B0\u5E16\u5B50\u7684\u5206\u6570
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/23
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PostScoreRefreshJob</span> <span class="token keyword">implements</span> <span class="token class-name">Job</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">PostScoreRefreshJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostService</span> discussPostService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">LikeService</span> likeService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">ElasticsearchService</span> elasticsearchService<span class="token punctuation">;</span>

    <span class="token comment">// \u725B\u5BA2\u7EAA\u5143\uFF0C\u8BA1\u7B97\u5206\u6570\u65F6\u9700\u8981</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Date</span> NOWCODER_EPOCH<span class="token punctuation">;</span>

    <span class="token keyword">static</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            NOWCODER_EPOCH <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleDateFormat</span><span class="token punctuation">(</span><span class="token string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token string">&quot;2014-08-01 00:00:00&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">ParseException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;\u521D\u59CB\u5316\u725B\u5BA2\u7EAA\u5143\u5931\u8D25\uFF01&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> jobExecutionContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JobExecutionException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getPostScoreKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u7ED1\u5B9A redisKey \u7684\u5BF9\u8C61\uFF0C\u540E\u9762\u76F4\u63A5\u901A\u8FC7\u8FD9\u4E2A\u5BF9\u8C61\u6765\u8FDB\u884C\u6709\u5173\u4E0E redisKey \u76F8\u5173\u7684\u64CD\u4F5C</span>
        <span class="token class-name">BoundSetOperations</span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundSetOps</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[\u4EFB\u52A1\u53D6\u6D88] \u6CA1\u6709\u9700\u8981\u5237\u65B0\u5206\u6570\u7684\u5E16\u5B50&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[\u4EFB\u52A1\u5F00\u59CB] \u6B63\u5728\u5237\u65B0\u5E16\u5B50\u5206\u6570\uFF1A&quot;</span> <span class="token operator">+</span> operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u5F53 set \u4E2D\u6709\u8981\u5237\u65B0\u7684\u5E16\u5B50\u65F6\uFF0C\u4F9D\u6B21\u5F39\u51FA\u8FDB\u884C\u5237\u65B0</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> operations<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[\u4EFB\u52A1\u7ED3\u675F] \u5E16\u5B50\u5206\u6570\u5237\u65B0\u5B8C\u6BD5\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">refresh</span><span class="token punctuation">(</span><span class="token keyword">int</span> postId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">DiscussPost</span> post <span class="token operator">=</span> discussPostService<span class="token punctuation">.</span><span class="token function">findDiscussPostById</span><span class="token punctuation">(</span>postId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>post <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;\u8BE5\u5E16\u5B50\u4E0D\u5B58\u5728\uFF1Aid = &quot;</span> <span class="token operator">+</span> postId<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u662F\u5426\u52A0\u7CBE</span>
        <span class="token keyword">boolean</span> wonderful <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">getStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token comment">// \u8BC4\u8BBA\u6570\u91CF</span>
        <span class="token keyword">int</span> commentCount <span class="token operator">=</span> post<span class="token punctuation">.</span><span class="token function">getCommentCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u70B9\u8D5E\u6570\u91CF</span>
        <span class="token keyword">long</span> likeCount <span class="token operator">=</span> likeService<span class="token punctuation">.</span><span class="token function">findEntityLikeCount</span><span class="token punctuation">(</span><span class="token class-name">CommonConstant</span><span class="token punctuation">.</span>ENTITY_TYPE_POST<span class="token punctuation">,</span> postId<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u8BA1\u7B97\u6743\u91CD</span>
        <span class="token keyword">double</span> w <span class="token operator">=</span> <span class="token punctuation">(</span>wonderful <span class="token operator">?</span> <span class="token number">75</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> commentCount <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span> likeCount <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5206\u6570 = \u5E16\u5B50\u6743\u91CD + \u8DDD\u79BB\u5929\u6570</span>
        <span class="token keyword">double</span> score <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">log10</span><span class="token punctuation">(</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">+</span> <span class="token punctuation">(</span>post<span class="token punctuation">.</span><span class="token function">getCreateTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> NOWCODER_EPOCH<span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">*</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u66F4\u65B0\u5E16\u5B50\u5206\u6570</span>
        discussPostService<span class="token punctuation">.</span><span class="token function">updateScore</span><span class="token punctuation">(</span>postId<span class="token punctuation">,</span> score<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u540C\u6B65 ES \u6570\u636E</span>
        post<span class="token punctuation">.</span><span class="token function">setScore</span><span class="token punctuation">(</span>score<span class="token punctuation">)</span><span class="token punctuation">;</span>
        elasticsearchService<span class="token punctuation">.</span><span class="token function">saveDiscussPost</span><span class="token punctuation">(</span>post<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u63A5\u7740\u53BB\u914D\u7F6E Trigger \u5373\u53EF\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: Quartz \u914D\u7F6E\u7C7B\uFF1A\u914D\u7F6E -&gt; \u6570\u636E\u5E93 -&gt; \u8C03\u7528
 *      1. \u9879\u76EE\u542F\u52A8\uFF0C\u8BE5\u914D\u7F6E\u88AB\u52A0\u8F7D\uFF0C\u4E0B\u9762\u7684\u914D\u7F6E\u4F1A\u88AB\u63D2\u5165\u5230\u6570\u636E\u5E93
 *      2. \u63A5\u7740\u5C31\u53EF\u4EE5\u6839\u636E\u6570\u636E\u5E93\u4E2D\u7684\u914D\u7F6E\u6570\u636E\u8FDB\u884C\u8C03\u5EA6
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/22
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">QuartzConfig</span> <span class="token punctuation">{</span>
    <span class="token comment">/*
    FactoryBean \u53EF\u7B80\u5316 Bean \u7684\u5B9E\u4F8B\u5316\u8FC7\u7A0B\uFF1A
        1. \u901A\u8FC7 FactoryBean \u5C01\u88C5 Bean \u7684\u5B9E\u4F8B\u5316\u8FC7\u7A0B
        2. \u5C06 FactoryBean \u88C5\u914D\u5230 Spring \u5BB9\u5668
        3. \u5C06 FactoryBean \u6CE8\u5165\u7ED9\u5176\u4ED6\u7684 Bean
        4. \u8BE5 Bean \u5F97\u5230\u7684\u662F FactoryBean \u6240\u7BA1\u7406\u7684\u5BF9\u8C61\u5B9E\u4F8B
     */</span>

    <span class="token comment">// \u5237\u65B0\u5E16\u5B50\u5206\u6570\u4EFB\u52A1</span>
    <span class="token comment">// \u914D\u7F6E JobDetail\uFF0C\u88C5\u914D\u5230 Spring \u5BB9\u5668</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">JobDetailFactoryBean</span> <span class="token class-name">PostScoreRefreshJobDetail</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">JobDetailFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JobDetailFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setJobClass</span><span class="token punctuation">(</span><span class="token class-name">PostScoreRefreshJob</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;postScoreRefreshJob&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;nowcoderGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setDurability</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setRequestsRecovery</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u914D\u7F6E Trigger\uFF0C\u5C06\u540D\u4E3A PostScoreRefreshJobDetail \u7684 Bean \u901A\u8FC7 Bean \u540D\u5B57\u6CE8\u5165\u8FDB\u6765\uFF0C\u76F4\u63A5\u4F7F\u7528</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">SimpleTriggerFactoryBean</span> <span class="token class-name">PostScoreRefreshTrigger</span><span class="token punctuation">(</span><span class="token class-name">JobDetail</span> <span class="token class-name">PostScoreRefreshJobDetail</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SimpleTriggerFactoryBean</span> factoryBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SimpleTriggerFactoryBean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setJobDetail</span><span class="token punctuation">(</span><span class="token class-name">PostScoreRefreshJobDetail</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;postScoreRefreshTrigger&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setGroup</span><span class="token punctuation">(</span><span class="token string">&quot;nowcoderGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setRepeatInterval</span><span class="token punctuation">(</span><span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 5min \u6267\u884C\u4E00\u6B21</span>
        factoryBean<span class="token punctuation">.</span><span class="token function">setJobDataMap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">JobDataMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> factoryBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u7136\u540E\u5728\u5BF9\u5E16\u5B50\u8FDB\u884C\u6DFB\u52A0\u3001\u8BC4\u8BBA\u3001\u52A0\u7CBE\u3001\u70B9\u8D5E\u65F6\uFF0C\u5C06\u5BF9\u5E94\u7684 postId \u5B58\u5165 Redis \u5373\u53EF\uFF0C\u5F53 Redis \u4E2D\u8BE5 key \u5BF9\u5E94\u7684 set \u96C6\u5408\u4E0D\u4E3A\u7A7A\u65F6\uFF0C\u5B9A\u65F6\u4EFB\u52A1\u4F1A\u81EA\u52A8\u4ECE Redis \u4E2D\u53D6\u51FA\u5E16\u5B50\u6765\u66F4\u65B0\u3002</p><h2 id="_7-\u4E8C\u7EA7\u7F13\u5B58\u4F18\u5316\u6027\u80FD" tabindex="-1"><a class="header-anchor" href="#_7-\u4E8C\u7EA7\u7F13\u5B58\u4F18\u5316\u6027\u80FD" aria-hidden="true">#</a> 7. \u4E8C\u7EA7\u7F13\u5B58\u4F18\u5316\u6027\u80FD</h2><p>\u6211\u4EEC\u7684\u70ED\u699C\u5E16\u5B50\u662F\u4F7F\u7528\u5B9A\u65F6\u4EFB\u52A1\u66F4\u65B0\u7684\uFF0C\u6240\u4EE5\u66F4\u65B0\u4E0D\u4F1A\u5F88\u9891\u7E41\uFF0C\u800C\u4E14\u70ED\u699C\u5E16\u5B50\u901A\u5E38\u662F\u8BBF\u95EE\u6700\u9891\u7E41\u7684\u3002</p><p>\u56E0\u6B64\uFF0C\u70ED\u699C\u5E16\u5B50\u975E\u5E38\u9002\u5408\u518D\u52A0\u4E00\u4E2A <strong>\u672C\u5730\u7F13\u5B58</strong>\u3002\u5C06\u6570\u636E\u7F13\u5B58\u5728\u5E94\u7528\u670D\u52A1\u5668\u4E0A\uFF0C\u6027\u80FD\u6700\u597D\u3002</p><p>\u56E0\u4E3A Redis \u9700\u8981\u7F51\u7EDC\u5F00\u9500\uFF0C\u589E\u52A0\u65F6\u8017\u3002\u672C\u5730\u7F13\u5B58\u662F\u76F4\u63A5\u4ECE\u672C\u5730\u5185\u5B58\u4E2D\u8BFB\u53D6\uFF0C\u6CA1\u6709\u7F51\u7EDC\u5F00\u9500\uFF0C\u6BD4\u8F83\u9002\u5408\u6570\u636E\u91CF\u8F83\u5C0F\u7684\u7F13\u5B58\u3002\u6211\u4EEC\u53EA\u7F13\u5B58 15 - 20 \u4E2A\u70ED\u70B9\u5E16\u5B50\u5230\u672C\u5730\uFF0C\u56E0\u4E3A\u4E00\u822C\u7528\u6237\u53EA\u770B\u524D\u4E24\u4E09\u9875\u3002</p><p>\u6211\u4EEC\u89C4\u5B9A\u4E86\u70ED\u699C\u5E16\u5B50\u7684 orderMode \u4E3A 1\uFF0C\u6240\u4EE5\u6211\u4EEC\u53EA\u5BF9 oderMode \u4E3A 1\uFF0CuserId \u4E3A 0\uFF08userId \u4E3A 0 \u8868\u793A\u67E5\u8BE2\u6240\u6709\u5E16\u5B50\uFF0C\u4E0D\u4E3A 0 \u8868\u793A\u67E5\u8BE2\u67D0\u4E2A user \u7684\u5E16\u5B50\uFF09\u7684\u67E5\u8BE2\u5E16\u5B50\u5217\u8868\u52A0\u672C\u5730\u7F13\u5B58\u3002</p><p>\u9664\u4E86\u5BF9\u5E16\u5B50\u5217\u8868\u7684\u67E5\u8BE2\u505A\u672C\u5730\u7F13\u5B58\u5916\uFF0C\u8FD8\u6709\u67E5\u8BE2\u5E16\u5B50\u7684\u603B\u9875\u6570\u4E5F\u8981\u505A\uFF0C\u56E0\u4E3A\u52A0\u8F7D\u70ED\u699C\u5E16\u5B50\u9875\u9762\u65F6\uFF0C\u4E5F\u8981\u52A0\u8F7D\u603B\u9875\u6570\uFF0C\u4E0D\u80FD\u8BA9\u52A0\u8F7D\u603B\u9875\u6570\u7684\u67E5\u8BE2\u62D6\u4E86\u540E\u817F\u3002</p><h3 id="_7-1-\u8BA4\u8BC6-caffeine" tabindex="-1"><a class="header-anchor" href="#_7-1-\u8BA4\u8BC6-caffeine" aria-hidden="true">#</a> 7.1 \u8BA4\u8BC6 Caffeine</h3><p>\u672C\u5730\u7F13\u5B58\u5E38\u7528\u7684\u5DE5\u5177\u6709 Ehcache\u3001Guava\u3001Caffeine \u7B49\uFF0C\u6211\u4EEC\u4F7F\u7528 Caffeine\uFF0C\u5B83\u662F\u76EE\u524D\u6027\u80FD\u6700\u597D\u7684\u7F13\u5B58\u5DE5\u5177\u3002</p><blockquote><p>Caffeine \u914D\u7F6E\u8BF4\u660E</p></blockquote><p>\u5982\u4E0B\u56FE\uFF1A</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210311545410.webp" alt="img"></p><p>\u6CE8\u610F\uFF1A</p><ul><li>weakValues \u548C softValues \u4E0D\u53EF\u4EE5\u540C\u65F6\u4F7F\u7528\u3002</li><li>maximumSize \u548C maximumWeight \u4E0D\u53EF\u4EE5\u540C\u65F6\u4F7F\u7528\u3002</li><li>expireAfterWrite \u548C expireAfterAccess \u540C\u4E8B\u5B58\u5728\u65F6\uFF0C\u4EE5 expireAfterWrite \u4E3A\u51C6\u3002</li></ul><h3 id="_7-2-\u4F7F\u7528-caffeine" tabindex="-1"><a class="header-anchor" href="#_7-2-\u4F7F\u7528-caffeine" aria-hidden="true">#</a> 7.2 \u4F7F\u7528 Caffeine</h3><p>\u9996\u5148\uFF0C\u80AF\u5B9A\u662F\u5728\u539F\u59CB\u7684\u4E1A\u52A1\u5C42\u53BB\u6DFB\u52A0\u672C\u5730\u7F13\u5B58\uFF0C\u6240\u4EE5\u5B9A\u4F4D\u5230 <code>DiscussPostServiceImpl</code>\u3002</p><p>Caffeine \u7684\u6838\u5FC3\u63A5\u53E3\u662F Cache\uFF0C\u5B50\u63A5\u53E3\u6709 LoadingCache\uFF08\u540C\u6B65\u52A0\u8F7D\uFF09\uFF0CAsyncLoadingCache\uFF08\u5F02\u6B65\u52A0\u8F7D\uFF09\u3002</p><p>Caffeine \u5185\u90E8\u901A\u8FC7 ConcurrentHashMap \u5B9E\u73B0\uFF0C\u6240\u4EE5\u4F7F\u7528\u52A0\u8F7D\u548C\u83B7\u53D6\u7F13\u5B58\u90FD\u662F\u901A\u8FC7\u54C8\u5E0C\u8868\u7684 key-value \u65B9\u5F0F\u3002</p><p>\u5728 DiscussPostServiceImpl \u4E1A\u52A1\u5C42\u5B9A\u4E49\u7F13\u5B58\uFF0C\u4E14\u521D\u59CB\u5316\u597D\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: \u5E16\u5B50\u76F8\u5173\u4E1A\u52A1\u7C7B\uFF0C\u4F7F\u7528 Caffeine \u672C\u5730\u7F13\u5B58 \u70ED\u70B9\u5E16\u5B50\uFF08\u5B9A\u671F\u66F4\u65B0\u80FD\u4FDD\u8BC1\u53D8\u66F4\u4E0D\u9891\u7E41\uFF0C\u800C\u8BBF\u95EE\u5F88\u9891\u7E41\uFF09
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/8
 */</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DiscussPostServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">DiscussPostService</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">DiscussPostService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostMapper</span> discussPostMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">SensitiveFilter</span> sensitiveFilter<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${caffeine.posts.max-size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxSize<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${caffeine.posts.expire-seconds}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> expireSeconds<span class="token punctuation">;</span>

    <span class="token comment">// Caffeine \u6838\u5FC3\u63A5\u53E3\uFF1ACache\uFF0C \u5B50\u63A5\u53E3\uFF1ALoadingCache\uFF0CAsyncLoadingCache</span>

    <span class="token comment">// \u5E16\u5B50\u5217\u8868\u7684\u7F13\u5B58\uFF0Ckey \u4E3A offset:limit\uFF1B value \u4E3A\u4E00\u9875\u7684\u5E16\u5B50\u5217\u8868</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> postListCache<span class="token punctuation">;</span>

    <span class="token comment">// \u5E16\u5B50\u603B\u6570\u7684\u7F13\u5B58\uFF0Ckey \u4E3A userId\uFF08\u6C38\u8FDC\u90FD\u662F 0\uFF0C\u8868\u793A\u67E5\u8BE2\u6240\u6709\u5E16\u5B50\uFF09; value \u4E3A\u5E16\u5B50\u7684\u603B\u884C\u6570</span>
    <span class="token keyword">private</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> postRowsCache<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u521D\u59CB\u5316\u5E16\u5B50\u5217\u8868\u548C\u603B\u6570\u7684\u7F13\u5B58
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        postListCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// load \u65B9\u6CD5\u7528\u4E8E\u67E5\u4E0D\u5230\u672C\u5730\u7F13\u5B58\u65F6\uFF0C\u53BB\u54EA\u513F\u53D6\u6570\u636E\uFF0C\u53C2\u6570\u662F\u7F13\u5B58\u7684 key</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> params<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// \u4E2D\u95F4\u53EF\u4EE5\u518D\u7A7F\u63D2\u4E00\u4E2A\u4E8C\u7EA7\u7F13\u5B58\uFF08Redis\uFF09</span>

                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post list from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        postRowsCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Integer</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Integer</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post rows from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPostRows</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">findDiscussPosts</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">,</span> <span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">,</span> <span class="token keyword">int</span> orderMode<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// \u53EA\u7F13\u5B58\u70ED\u70B9\u5E16\u5B50\uFF0CuserId == 0 \u8868\u793A\u67E5\u8BE2\u6240\u6709\u5E16\u5B50\uFF08\u4E0D\u4E3A 0 \u8868\u793A\u67E5\u8BE2\u67D0\u4E2A user \u7684\u5E16\u5B50\uFF09\uFF0CorderMode \u4E3A 1 \u8868\u793A\u67E5\u8BE2\u70ED\u70B9\u5E16\u5B50</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> orderMode <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// key \u7684\u8BBE\u8BA1\uFF1Aoffset \u548C limit \u80FD\u552F\u4E00\u786E\u5B9A\u4E00\u9875\u5E16\u5B50</span>
            <span class="token keyword">return</span> postListCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>offset <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post list from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span>userId<span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> orderMode<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">findDiscussPostRows</span><span class="token punctuation">(</span><span class="token keyword">int</span> userId<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>userId <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// key \u7684\u8BBE\u8BA1\uFF1AuserId\uFF08\u6C38\u8FDC\u90FD\u662F 0\uFF0C\u8868\u793A\u67E5\u8BE2\u6240\u6709\u5E16\u5B50\uFF09</span>
            <span class="token keyword">return</span> postRowsCache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post rows from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPostRows</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// \u5176\u4ED6\u4E1A\u52A1\u65B9\u6CD5\u7565</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u73B0\u5728\u5F53\u6709\u5927\u91CF\u6570\u636E\u65F6\uFF0C\u672C\u5730\u7F13\u5B58\u5E26\u6765\u7684\u6027\u80FD\u63D0\u5347\u5C31\u5F88\u5927\u4E86\u3002</p><h3 id="_7-3-\u914D\u5408-redis-\u505A\u4E8C\u7EA7\u7F13\u5B58" tabindex="-1"><a class="header-anchor" href="#_7-3-\u914D\u5408-redis-\u505A\u4E8C\u7EA7\u7F13\u5B58" aria-hidden="true">#</a> 7.3 \u914D\u5408 Redis \u505A\u4E8C\u7EA7\u7F13\u5B58</h3><p>\u7F13\u5B58\u7684\u89E3\u51B3\u65B9\u6848\u4E00\u822C\u6709\u4E09\u79CD\uFF1A</p><ol><li>\u672C\u5730\u5185\u5B58\u7F13\u5B58\uFF0C\u5982 Caffeine\u3001Ehcache\uFF1B \u9002\u5408\u5355\u673A\u7CFB\u7EDF\uFF0C\u901F\u5EA6\u6700\u5FEB\uFF0C\u4F46\u662F\u5BB9\u91CF\u6709\u9650\uFF0C\u800C\u4E14\u91CD\u542F\u7CFB\u7EDF\u540E\u7F13\u5B58\u4E22\u5931\uFF1B</li><li>\u96C6\u4E2D\u5F0F\u7F13\u5B58\uFF0C\u5982 Redis\u3001Memcached\uFF1B \u9002\u5408\u5206\u5E03\u5F0F\u7CFB\u7EDF\uFF0C\u89E3\u51B3\u4E86\u5BB9\u91CF\u3001\u91CD\u542F\u4E22\u5931\u7F13\u5B58\u7B49\u95EE\u9898\uFF0C\u4F46\u662F\u5F53\u8BBF\u95EE\u91CF\u6781\u5927\u65F6\uFF0C\u5F80\u5F80\u6027\u80FD\u4E0D\u662F\u9996\u8981\u8003\u8651\u7684\u95EE\u9898\uFF0C\u800C\u662F\u5E26\u5BBD\u3002\u73B0\u8C61\u5C31\u662F Redis \u670D\u52A1\u8D1F\u8F7D\u4E0D\u9AD8\uFF0C\u4F46\u662F\u7531\u4E8E\u673A\u5668\u7F51\u5361\u5E26\u5BBD\u8DD1\u6EE1\uFF0C\u5BFC\u81F4\u6570\u636E\u8BFB\u53D6\u975E\u5E38\u6162\uFF1B</li><li>\u7B2C\u4E09\u79CD\u65B9\u6848\u5C31\u662F\u7ED3\u5408\u4EE5\u4E0A 2 \u79CD\u65B9\u6848\u7684\u4E8C\u7EA7\u7F13\u5B58\u5E94\u8FD0\u800C\u751F\uFF0C\u4EE5\u5185\u5B58\u7F13\u5B58\u4F5C\u4E3A\u4E00\u7EA7\u7F13\u5B58\u3001\u96C6\u4E2D\u5F0F\u7F13\u5B58\u4F5C\u4E3A\u4E8C\u7EA7\u7F13\u5B58\uFF1B</li></ol><p>\u4E8C\u7EA7\u7F13\u5B58\u65B9\u6848\u5927\u81F4\u6D41\u7A0B\u5982\u4E0B\uFF1A</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210312114587.png" alt=""></p><blockquote><p>\u4E8C\u7EA7\u7F13\u5B58\u5B9E\u73B0</p></blockquote><p>\u8981\u4F7F\u7528 Redis\uFF0C\u9996\u5148\u7B2C\u4E00\u6B65\u4E00\u5B9A\u662F\u5B9A\u4E49\u597D key\uFF0C\u4E8C\u7EA7\u7F13\u5B58\u7684 key \u5B9A\u4E49\u5982\u4E0B\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RedisKeyUtil</span> <span class="token punctuation">{</span>
    
    <span class="token comment">// \u5176\u4ED6\u7565</span>
    
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> PREFIX_L2CACHE_POSTS <span class="token operator">=</span> <span class="token string">&quot;l2cache:posts&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> PREFIX_L2CACHE_POST_ROWS <span class="token operator">=</span> <span class="token string">&quot;l2cache:post:rows&quot;</span><span class="token punctuation">;</span>
    
    <span class="token comment">// \u4E8C\u7EA7\u7F13\u5B58\uFF1A\u5E16\u5B50\u5217\u8868</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getL2CachePostsKey</span><span class="token punctuation">(</span><span class="token keyword">int</span> offset<span class="token punctuation">,</span> <span class="token keyword">int</span> limit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> PREFIX_L2CACHE_POSTS <span class="token operator">+</span> SPLIT <span class="token operator">+</span> offset <span class="token operator">+</span> SPLIT <span class="token operator">+</span> limit<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// \u4E8C\u7EA7\u7F13\u5B58\uFF1A\u5E16\u5B50\u603B\u884C\u6570</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">getL2CachePostRowsKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> PREFIX_L2CACHE_POST_ROWS<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u91CC\u628A\u4E8C\u7EA7\u7F13\u5B58\u5B9A\u4E49\u7EDF\u4E00\u7684\u524D\u7F00\uFF0C\u65B9\u4FBF\u540E\u9762\u505A\u6E05\u7406\u64CD\u4F5C\u3002</p><p>\u7531\u4E8E\u6211\u4EEC\u5728\u66F4\u65B0\u5E16\u5B50\u5206\u6570\u7684\u65F6\u5019\u9700\u8981\u6E05\u9664\u4E00\u7EA7\u7F13\u5B58\u548C\u4E8C\u7EA7\u7F13\u5B58\uFF0C\u6240\u4EE5\u6211\u628A Caffeine \u5C01\u88C5\u6210\u4E86\u4E00\u4E2A\u5DE5\u5177\u7C7B\uFF0C\u8FD9\u6837\u5728\u66F4\u65B0\u5E16\u5B50\u5206\u6570\u65F6\u4E5F\u53EF\u4EE5\u8C03\u7528\u672C\u5730\u7F13\u5B58\u6765\u8FDB\u884C\u6E05\u7406\u64CD\u4F5C\u3002</p><p>\u5176\u5B9E\u8FD8\u6709\u4E00\u4E2A\u65B9\u6848\u662F\u628A\u672C\u5730\u7F13\u5B58\u548C Redis \u7F13\u5B58\u7684\u8FC7\u671F\u65F6\u95F4\u90FD\u8BBE\u7F6E\u6210\u66F4\u65B0\u5E16\u5B50\u5206\u6570\u7684\u5B9A\u65F6\u4EFB\u52A1\u7684\u65F6\u95F4\u95F4\u9694\u3002\u8FD9\u6837\u5728\u4E0B\u4E00\u6B21\u66F4\u65B0\u5E16\u5B50\u5206\u6570\u65F6\u7F13\u5B58\u521A\u597D\u4E5F\u5931\u6548\u4E86\uFF0C\u4F46\u662F\u8FD9\u6837\u603B\u611F\u89C9\u6709\u4E00\u4E2A\u7EA6\u675F\uFF0C\u6211\u7684\u7F13\u5B58\u4E3A\u4EC0\u4E48\u8981\u4F9D\u8D56\u4E8E\u5B9A\u65F6\u4EFB\u52A1\u7684\u65F6\u95F4\u5462\uFF1F\uFF1F</p><p>\u6211\u4E0D\u7BA1\u4F60\u4EC0\u4E48\u65F6\u5019\u6267\u884C\u5B9A\u65F6\u4EFB\u52A1\u66F4\u65B0\u5E16\u5B50\u5206\u6570\uFF0C\u4F60\u4E5F\u522B\u7BA1\u6211\u7F13\u5B58\u8FC7\u4E45\u8FC7\u671F\u3002\u53EA\u8981\u5728\u4F60\u66F4\u65B0\u5E16\u5B50\u5206\u6570\u65F6\u6211\u6E05\u7406\u6389\u7F13\u5B58\uFF0C<strong>\u4FDD\u8BC1\u6570\u636E\u5E93\u548C\u7F13\u5B58\u4E00\u81F4</strong>\uFF08\u975E\u5F3A\u4E00\u81F4\uFF09 \u5373\u53EF\u3002</p><p>\u62BD\u51FA\u6765\u7684 CaffeineUtil\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * <span class="token keyword">@desc</span>: \u672C\u5730\u7F13\u5B58 CaffeineUtil
 * <span class="token keyword">@author</span>: AruNi_Lu
 * <span class="token keyword">@date</span>: 2022/10/31
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CaffeineUtil</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> logger <span class="token operator">=</span> <span class="token class-name">LoggerFactory</span><span class="token punctuation">.</span><span class="token function">getLogger</span><span class="token punctuation">(</span><span class="token class-name">CaffeineUtil</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">DiscussPostMapper</span> discussPostMapper<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${caffeine.posts.max-size}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> maxSize<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">&quot;\${caffeine.posts.expire-seconds}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> expireSeconds<span class="token punctuation">;</span>

    <span class="token comment">// Caffeine \u6838\u5FC3\u63A5\u53E3\uFF1ACache\uFF0C \u5B50\u63A5\u53E3\uFF1ALoadingCache\uFF0CAsyncLoadingCache</span>

    <span class="token comment">// \u5E16\u5B50\u5217\u8868\u7684\u7F13\u5B58\uFF0Ckey \u4E3A offset:limit\uFF1B value \u4E3A\u4E00\u9875\u7684\u5E16\u5B50\u5217\u8868</span>
    <span class="token keyword">public</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> postListCache<span class="token punctuation">;</span>

    <span class="token comment">// \u5E16\u5B50\u603B\u6570\u7684\u7F13\u5B58\uFF0Ckey \u4E3A userId\uFF08\u6C38\u8FDC\u90FD\u662F 0\uFF0C\u8868\u793A\u67E5\u8BE2\u6240\u6709\u5E16\u5B50\uFF09; value \u4E3A\u5E16\u5B50\u7684\u603B\u884C\u6570</span>
    <span class="token keyword">public</span> <span class="token class-name">LoadingCache</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> postRowsCache<span class="token punctuation">;</span>

    <span class="token doc-comment comment">/**
     * \u521D\u59CB\u5316\u5E16\u5B50\u5217\u8868\u548C\u603B\u6570\u7684\u7F13\u5B58
     */</span>
    <span class="token annotation punctuation">@PostConstruct</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        postListCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// load \u65B9\u6CD5\u7528\u4E8E\u67E5\u4E0D\u5230\u672C\u5730\u7F13\u5B58\u65F6\uFF0C\u53BB\u54EA\u513F\u53D6\u6570\u636E\uFF0C\u53C2\u6570\u662F\u7F13\u5B58\u7684 key</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">String</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> key<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> params <span class="token operator">=</span> key<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;:&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>params <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> params<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;\u53C2\u6570\u9519\u8BEF\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        <span class="token keyword">int</span> offset <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">int</span> limit <span class="token operator">=</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">parseInt</span><span class="token punctuation">(</span>params<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// \u4E2D\u95F4\u53EF\u4EE5\u518D\u7A7F\u63D2\u4E00\u4E2A\u4E8C\u7EA7\u7F13\u5B58\uFF08Redis\uFF09</span>
                        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getL2CachePostsKey</span><span class="token punctuation">(</span>offset<span class="token punctuation">,</span> limit<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">DiscussPost</span><span class="token punctuation">&gt;</span></span> postList <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>postList <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> postList<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post list from Redis.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> postList<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>


                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post list from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        postList <span class="token operator">=</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPosts</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> offset<span class="token punctuation">,</span> limit<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token comment">// \u4ECE DB \u67E5\u8BE2\u540E\u521D\u59CB\u5316 Redis</span>
                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;init l2cache posts from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">rightPushAll</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> postList<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        redisTemplate<span class="token punctuation">.</span><span class="token function">expire</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">return</span> postList<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        postRowsCache <span class="token operator">=</span> <span class="token class-name">Caffeine</span><span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">maximumSize</span><span class="token punctuation">(</span>maxSize<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">expireAfterWrite</span><span class="token punctuation">(</span>expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">CacheLoader</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token annotation punctuation">@Override</span>
                    <span class="token keyword">public</span> <span class="token annotation punctuation">@Nullable</span> <span class="token class-name">Integer</span> <span class="token function">load</span><span class="token punctuation">(</span><span class="token annotation punctuation">@NonNull</span> <span class="token class-name">Integer</span> key<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                        <span class="token comment">// \u4E8C\u7EA7\u7F13\u5B58</span>
                        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getL2CachePostRowsKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Integer</span> rows <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token keyword">if</span> <span class="token punctuation">(</span>rows <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                            logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post rows from Redis.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">return</span> rows<span class="token punctuation">;</span>
                        <span class="token punctuation">}</span>

                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;load post rows from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        rows <span class="token operator">=</span> discussPostMapper<span class="token punctuation">.</span><span class="token function">selectDiscussPostRows</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;init l2cache post rows from DB.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                        redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">,</span> rows<span class="token punctuation">,</span> expireSeconds<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>

                        <span class="token keyword">return</span> rows<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u5728 DiscussPostServiceImpl \u4E2D\u76F4\u63A5\u6CE8\u5165 CaffeineUtil\uFF0C\u7136\u540E\u901A\u8FC7\u5B83\u8C03\u7528 postListCache \u548C postRowsCache\u5373\u53EF\u3002</p><p>\u5728\u5B9A\u65F6\u4EFB\u52A1\u7684\u5DE5\u4F5C\u7C7B PostScoreRefreshJob \u4E2D\u5237\u65B0\u70ED\u5E16\u65F6\uFF0C\u6DFB\u52A0\u4E0A\u5220\u9664\u7F13\u5B58\u7684\u4EE3\u7801\uFF0C\u5224\u65AD\u662F\u5426\u9700\u8981\u5237\u65B0\u70ED\u5E16\u7684\u65B9\u6CD5\u662F execute\uFF1A</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">execute</span><span class="token punctuation">(</span><span class="token class-name">JobExecutionContext</span> jobExecutionContext<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">JobExecutionException</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> redisKey <span class="token operator">=</span> <span class="token class-name">RedisKeyUtil</span><span class="token punctuation">.</span><span class="token function">getPostScoreKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u83B7\u53D6\u7ED1\u5B9A redisKey \u7684\u5BF9\u8C61\uFF0C\u540E\u9762\u76F4\u63A5\u901A\u8FC7\u8FD9\u4E2A\u5BF9\u8C61\u6765\u8FDB\u884C\u6709\u5173\u4E0E redisKey \u76F8\u5173\u7684\u64CD\u4F5C</span>
        <span class="token class-name">BoundSetOperations</span> operations <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">boundSetOps</span><span class="token punctuation">(</span>redisKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[\u4EFB\u52A1\u53D6\u6D88] \u6CA1\u6709\u9700\u8981\u5237\u65B0\u5206\u6570\u7684\u5E16\u5B50&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[\u4EFB\u52A1\u5F00\u59CB] \u6B63\u5728\u5237\u65B0\u5E16\u5B50\u5206\u6570\uFF1A&quot;</span> <span class="token operator">+</span> operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// \u5F53 set \u4E2D\u6709\u8981\u5237\u65B0\u7684\u5E16\u5B50\u65F6\uFF0C\u4F9D\u6B21\u5F39\u51FA\u8FDB\u884C\u5237\u65B0</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span>operations<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">refresh</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> operations<span class="token punctuation">.</span><span class="token function">pop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// \u70ED\u5E16\u5237\u65B0\u65F6\uFF0C\u5220\u9664\u4E00\u7EA7\u548C\u4E8C\u7EA7\u7F13\u5B58</span>
        logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;\u70ED\u5E16\u5DF2\u66F4\u65B0\uFF0C\u5F00\u59CB\u5220\u9664\u4E00\u7EA7\u7F13\u5B58\u548C\u4E8C\u7EA7\u7F13\u5B58\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        caffeineUtil<span class="token punctuation">.</span>postListCache<span class="token punctuation">.</span><span class="token function">cleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        caffeineUtil<span class="token punctuation">.</span>postRowsCache<span class="token punctuation">.</span><span class="token function">cleanUp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// \u5148\u83B7\u53D6\u6240\u6709\u5173\u4E8E\u4E8C\u7EA7\u7F13\u5B58\u7684\u952E\uFF0C\u5728\u4F9D\u6B21\u5220\u9664\u5373\u53EF</span>
        <span class="token class-name">Set</span> keys <span class="token operator">=</span> redisTemplate<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token string">&quot;l2cache*&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Object</span> key <span class="token operator">:</span> keys<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        logger<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[\u4EFB\u52A1\u7ED3\u675F] \u5E16\u5B50\u5206\u6570\u5237\u65B0\u5B8C\u6BD5\uFF01&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u81F3\u6B64\uFF0C\u4E8C\u7EA7\u7F13\u5B58\u7684\u529F\u80FD\u5DF2\u5B8C\u6210\u3002</p><h2 id="_8-\u9879\u76EE\u603B\u7ED3" tabindex="-1"><a class="header-anchor" href="#_8-\u9879\u76EE\u603B\u7ED3" aria-hidden="true">#</a> 8. \u9879\u76EE\u603B\u7ED3</h2><p>\u4E3B\u8981\u7684\u5B9E\u73B0\u7684\u529F\u80FD\u548C\u6280\u672F\u6808\uFF1A</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210262337123.png" alt="image-20221026233652193"></p><p>\u90E8\u7F72\u4E0A\u7EBF\u65F6\uFF0C\u91CD\u8981\u7684\u662F\u6027\u80FD\u3001\u5B89\u5168\u3001\u53EF\u9760\u6027\u3002</p><p><img src="https://run-notes.oss-cn-beijing.aliyuncs.com/notes/202210262337052.png" alt="image-20221026233619539"></p><h2 id="_9-\u5FC3\u5F97\u4F53\u4F1A" tabindex="-1"><a class="header-anchor" href="#_9-\u5FC3\u5F97\u4F53\u4F1A" aria-hidden="true">#</a> 9. \u5FC3\u5F97\u4F53\u4F1A</h2><p>\u603B\u4F53\u6765\u8BF4\u4EFF\u725B\u5BA2\u8BBA\u8BA8\u8FD9\u4E2A\u9879\u76EE\u8FD8\u662F\u80FD\u5B66\u5230\u5F88\u591A\u4E1C\u897F\u7684\uFF0C\u8001\u5E08\u8BB2\u7684\u4E5F\u597D\uFF0C\u901A\u4FD7\u6613\u61C2\u3002</p><p>\u8FD9\u662F\u6211\u51C6\u5907\u7528\u6765\u627E\u5B9E\u4E60\u7684\u9879\u76EE\uFF0C\u867D\u7136\u50CF\u5546\u57CE\u3001\u8BBA\u575B\u7B49\u5DF2\u7ECF\u70C2\u5927\u8857\u4E86\uFF0C\u4F46\u662F\u4E0D\u53EF\u5426\u8BA4\u5B83\u4EEC\u786E\u786E\u5B9E\u5B9E\u662F\u597D\u7684\u9879\u76EE\uFF0C\u81EA\u5DF1\u80FD\u4ECE\u4E2D\u5B66\u5230\u4E1C\u897F\u5373\u53EF\u3002</p><h2 id="\u5F85\u5B8C\u5584" tabindex="-1"><a class="header-anchor" href="#\u5F85\u5B8C\u5584" aria-hidden="true">#</a> \u5F85\u5B8C\u5584</h2><ul><li>\u5982\u4F55\u4FDD\u8BC1\u6570\u636E\u5E93\u4E0E\u7F13\u5B58\u7684\u6570\u636E\u4E00\u81F4\u6027\uFF1F</li></ul>`,322);function an(tn,pn){const s=l("RouterLink");return e(),o("div",null,[k,n("div",r,[(e(),o("svg",d,b)),g,n("nav",y,[n("ul",null,[n("li",null,[a(s,{to:"#_1-\u6570\u636E\u5E93\u8BBE\u8BA1"},{default:t(()=>[f]),_:1}),n("ul",null,[n("li",null,[a(s,{to:"#_1-1-\u7528\u6237\u8868-user"},{default:t(()=>[w]),_:1})]),n("li",null,[a(s,{to:"#_1-2-\u5E16\u5B50\u8868-discuss-post"},{default:t(()=>[h]),_:1})]),n("li",null,[a(s,{to:"#_1-3-\u8BC4\u8BBA\u8868-comment"},{default:t(()=>[q]),_:1})]),n("li",null,[a(s,{to:"#_1-4-\u6D88\u606F\u8868-message"},{default:t(()=>[S]),_:1})]),n("li",null,[a(s,{to:"#_1-5-\u767B\u5F55\u51ED\u8BC1\u8868-login-ticket"},{default:t(()=>[_]),_:1})])])]),n("li",null,[a(s,{to:"#_2-\u4E1A\u52A1\u5F00\u53D1"},{default:t(()=>[C]),_:1}),n("ul",null,[n("li",null,[a(s,{to:"#_2-1-\u9996\u9875"},{default:t(()=>[T]),_:1})]),n("li",null,[a(s,{to:"#_2-2-\u6CE8\u518C\u529F\u80FD"},{default:t(()=>[x]),_:1})]),n("li",null,[a(s,{to:"#_2-3-\u767B\u5F55\u529F\u80FD-\u91CD\u70B9"},{default:t(()=>[R]),_:1})]),n("li",null,[a(s,{to:"#_2-4-\u4FEE\u6539\u4E2A\u4EBA\u4FE1\u606F-\u91CD\u70B9"},{default:t(()=>[L]),_:1})]),n("li",null,[a(s,{to:"#_2-5-\u8FC7\u6EE4\u654F\u611F\u8BCD"},{default:t(()=>[I]),_:1})]),n("li",null,[a(s,{to:"#_2-6-\u7EDF\u4E00\u5F02\u5E38\u5904\u7406"},{default:t(()=>[E]),_:1})]),n("li",null,[a(s,{to:"#_2-7-\u7EDF\u4E00\u65E5\u5FD7\u7BA1\u7406"},{default:t(()=>[P]),_:1})])])]),n("li",null,[a(s,{to:"#_3-redis-\u76F8\u5173"},{default:t(()=>[D]),_:1}),n("ul",null,[n("li",null,[a(s,{to:"#_3-1-\u70B9\u8D5E-\u91CD\u70B9"},{default:t(()=>[A]),_:1})]),n("li",null,[a(s,{to:"#_3-2-\u5173\u6CE8-\u91CD\u70B9"},{default:t(()=>[j]),_:1})]),n("li",null,[a(s,{to:"#_3-3-\u9875\u9762\u4F18\u5316"},{default:t(()=>[O]),_:1})]),n("li",null,[a(s,{to:"#_3-4-redis-\u9AD8\u7EA7\u6570\u636E\u7C7B\u578B"},{default:t(()=>[U]),_:1})])])]),n("li",null,[a(s,{to:"#_4-kafka-\u76F8\u5173"},{default:t(()=>[M]),_:1}),n("ul",null,[n("li",null,[a(s,{to:"#_4-1-\u4EC0\u4E48\u662F-kafka"},{default:t(()=>[B]),_:1})]),n("li",null,[a(s,{to:"#_4-2-\u53D1\u9001\u7CFB\u7EDF\u901A\u77E5"},{default:t(()=>[N]),_:1})])])]),n("li",null,[a(s,{to:"#_5-elasticsearch-\u76F8\u5173"},{default:t(()=>[K]),_:1}),n("ul",null,[n("li",null,[a(s,{to:"#_5-1-\u4E3A\u4EC0\u4E48\u8981\u7528-es"},{default:t(()=>[H]),_:1})]),n("li",null,[a(s,{to:"#_5-2-\u4EC0\u4E48\u662F-es"},{default:t(()=>[F]),_:1})]),n("li",null,[a(s,{to:"#_5-3-\u641C\u7D22\u529F\u80FD"},{default:t(()=>[J]),_:1})])])]),n("li",null,[a(s,{to:"#_6-\u5B9A\u65F6\u4EFB\u52A1"},{default:t(()=>[V]),_:1}),n("ul",null,[n("li",null,[a(s,{to:"#_6-1-\u8BA4\u8BC6-quartz"},{default:t(()=>[z]),_:1})]),n("li",null,[a(s,{to:"#_6-2-\u70ED\u699C\u5E16\u5B50\u5B9E\u73B0"},{default:t(()=>[W]),_:1})])])]),n("li",null,[a(s,{to:"#_7-\u4E8C\u7EA7\u7F13\u5B58\u4F18\u5316\u6027\u80FD"},{default:t(()=>[Q]),_:1}),n("ul",null,[n("li",null,[a(s,{to:"#_7-1-\u8BA4\u8BC6-caffeine"},{default:t(()=>[G]),_:1})]),n("li",null,[a(s,{to:"#_7-2-\u4F7F\u7528-caffeine"},{default:t(()=>[Y]),_:1})]),n("li",null,[a(s,{to:"#_7-3-\u914D\u5408-redis-\u505A\u4E8C\u7EA7\u7F13\u5B58"},{default:t(()=>[$]),_:1})])])]),n("li",null,[a(s,{to:"#_8-\u9879\u76EE\u603B\u7ED3"},{default:t(()=>[X]),_:1})]),n("li",null,[a(s,{to:"#_9-\u5FC3\u5F97\u4F53\u4F1A"},{default:t(()=>[Z]),_:1})]),n("li",null,[a(s,{to:"#\u5F85\u5B8C\u5584"},{default:t(()=>[nn]),_:1})])])])]),sn])}var on=c(u,[["render",an],["__file","2022-10-31-\u4EFF\u725B\u5BA2\u9879\u76EE\u603B\u7ED3.html.vue"]]);export{on as default};
